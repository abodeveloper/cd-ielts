import{a as M,j as e,d as H,u as V,t as C,r as F,R as I,e as Y}from"./index-CwxirhWB.js";import{u as U,F as W,C as X}from"./useTestLogic-CBEcl3E7.js";import{B as q}from"./badge-HNMHLiIo.js";import{B}from"./button-BLDaD6WZ.js";import{C as Q,a as G,c as D,d as z}from"./card-Cu0LwOn4.js";import{T as Z,a as ee,b as P,c as _,d as se,e as v}from"./table-U3GL7qNp.js";import{c as J,e as te,g as ae,R as K}from"./index-BZYcU9zo.js";import{l as a}from"./lodash-CwxYmA9C.js";import{T as re}from"./tabs-OoYfrzwv.js";import{u as ne,T as ie,a as T,P as le,C as ce,b as oe}from"./usePreventPageLeave-BsjJorJn.js";import{o as k,b as de,s as R,c as L,n as O,u as me,a as ue}from"./schemas-B-ZJsds3.js";import{u as xe,a as he,F as ge}from"./index.esm-CXQp8oKO.js";import{u as pe,E as $}from"./ErrorMessage-DqHAmZc9.js";import{L as je}from"./LoadingSpinner-DSiRdXBg.js";import"./index-BdrbzQWw.js";import"./utils-CPYLdFy8.js";import"./index-DrUrsE95.js";import"./index-CRbAYwbf.js";import"./index-BRTLPeh9.js";import"./index-BLaBgYv4.js";import"./index-BQzLEYJo.js";import"./index-jomFHtgw.js";import"./index-DBORmBR9.js";import"./createLucideIcon-C4Z7YXAM.js";import"./select-UnpDhEjM.js";import"./index-DNhsxQRF.js";import"./index-DldyDhO1.js";import"./index-V3AwEoFl.js";import"./form-Y7dO-aOq.js";import"./circle-BnfojBR6.js";import"./input-CJ8aA-OI.js";import"./index-BkzstEBz.js";function fe({formData:t}){const{user:d}=M(),i=a.get(t,"finish"),l=a.get(t,"test_type"),n=a.get(t,"overall_score"),j=a.get(t,"percentage_correct_for_material",0),f=a.get(t,"answers",[]),c=a.get(t,"total_answers",0),w=a.get(t,"total_correct_answers",0),x=a.get(t,"total_incorrect_answers",0),N=()=>{i()};return e.jsx("div",{className:"p-4 w-full",children:e.jsxs(Q,{className:"w-full shadow-lg",children:[e.jsxs(G,{className:"flex items-center space-x-2",children:[e.jsx(J,{className:"w-12 h-12"}),e.jsx("h1",{className:"text-center text-lg font-extrabold tracking-tight text-balance",children:"IELTS Academic Reading - Results"})]}),e.jsxs(D,{className:"space-y-8",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Candidate:"}),e.jsx("div",{children:a.get(d,"full_name")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Total Questions:"}),e.jsx("div",{children:c})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Correct answers:"}),e.jsx("div",{className:"text-green-500",children:w})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Incorrect answers:"}),e.jsx("div",{className:"text-destructive",children:x})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Percentage correct for material:"}),e.jsxs("div",{children:[j,"%"]})]}),l==="mock"&&e.jsxs("div",{className:"flex items-center gap-2 mt-4",children:[e.jsx("strong",{children:"Overal:"}),e.jsx(q,{variant:"default",children:n})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h2",{className:"text-md font-semibold",children:"Answer Review"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(Z,{className:"h-[400px]",children:[e.jsx(ee,{children:e.jsxs(P,{children:[e.jsx(_,{children:"Question"}),e.jsx(_,{children:"Your Answer"}),e.jsx(_,{children:"True Answer"}),e.jsx(_,{children:"Status"})]})}),e.jsx(se,{children:f.map(o=>e.jsxs(P,{children:[e.jsx(v,{children:o.question_number}),e.jsx(v,{children:o.answer||e.jsx(q,{className:"bg-orange-500",children:"Not answered"})}),e.jsx(v,{children:o.true_answer}),e.jsx(v,{children:o.is_true?e.jsx(te,{className:"text-green-500"}):e.jsx(ae,{className:"text-destructive"})})]},o.id))})]})})]})]}),e.jsx(z,{children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsxs("p",{className:"flex gap-2",children:[e.jsx(K,{})," Review and finalize your results."]}),e.jsx(B,{className:"w-64",onClick:()=>N(),children:"Finish"})]})})]})})}const we=async t=>(await H.get(`/api/reading/by-material/${t}/`)).data,Ne=async(t,d)=>(await H.post(`/api/reading-answers/${t}/`,d)).data,ye=k({answers:de(k({reading_id:L([O(),R()]).optional(),question_number:L([O(),R()]).optional(),answer:R().nullable().optional()}).nullable()).optional()}),be=t=>pe({queryKey:["readings",t],queryFn:()=>we(t),enabled:!!t}),_e=(t,d)=>{const{user:i}=M(),l=V(),n=be(t),j=i?.id||"guest",f=a.get(n.data,"is_view"),c=a.get(n.data,"material"),w=a.get(n.data,"test_type"),x=()=>{if(i?.role===I.TEACHER)l("/");else if(String(a.get(c,"test_type"))?.toLowerCase()=="mock"){const s=a.get(c,"next_test"),r=a.get(c,"next_test_id");l(s==="listening"&&r?`/listenings/${r}`:s==="reading"&&r?`/readings/${r}`:s==="speaking"&&r?`/speakings/${r}`:s==="writing"&&r?`/writings/${r}`:"/")}else l("/")},N=s=>{w==="Thematic"?d?.({...s,material:c,finish:x}):i?.role===I.TEACHER?d?.({...s,material:c,finish:x}):f===!0?d?.({...s,material:c}):x()},o=me({mutationFn:s=>Ne(t,s),onSuccess:s=>{C.success("Successfully submitted!"),N(s)},onError:s=>{console.error("Error:",s),C.error(a.get(s,"response.data.error",""))}}),g=xe({resolver:ue(ye),defaultValues:{answers:[]}}),{fields:S,replace:y}=he({control:g.control,name:"answers"}),p=`reading_answers_${j}_${t}`;return F.useEffect(()=>{const s=n.data;if(!Array.isArray(s?.reading_parts)||s.reading_parts.length===0)return;const r=Math.max(...s.reading_parts.flatMap(u=>u?.question_numbers?.map(h=>h.question_number))),m=Array(r)?.fill(null);s.reading_parts.forEach(u=>{u?.question_numbers?.forEach(h=>{const E=h.question_number-1;m[E]={reading_id:u.id,question_number:h.question_number,answer:""}})});try{const u=localStorage.getItem(p);if(u){const h=JSON.parse(u);m.forEach((E,b)=>{h[b]&&h[b].answer&&(m[b].answer=h[b].answer)})}}catch(u){console.warn("Failed to load saved answers:",u)}y(m)},[n.data,y,p]),F.useEffect(()=>{const s=g.watch(r=>{if(r.answers&&r.answers.length>0)try{localStorage.setItem(p,JSON.stringify(r.answers))}catch(m){console.warn("Failed to save answers:",m)}});return()=>s.unsubscribe()},[g,p]),{form:g,readingMutation:o,onSubmit:s=>{const r=(s.answers??[]).filter(m=>m!=null);o.mutate(r);try{localStorage.removeItem(p)}catch(m){console.warn("Failed to clear saved answers:",m)}},answersFields:S,query:n,finish:x}},ve=({onNext:t})=>{const{id:d}=Y(),{form:i,onSubmit:l,query:n,readingMutation:j,finish:f}=_e(d,t),c=a.get(n,"data.reading_parts",[]),w=a.get(n,"data.answer_time",null),{timeLeft:x,formatTime:N,activeTab:o,setActiveTab:g,currentTabIndex:S,handlePrevious:y,handleNext:p,isTestFinished:A}=U(w,c,i.handleSubmit(l),!0,f);ne(!A);const s=c.find(r=>`tab-${r.id}`===o);return n.isLoading?e.jsx(je,{message:"Loading test data..."}):n.isError?e.jsx($,{title:"Failed to Load Test",message:"An error occurred while loading the test. Please try again later."}):n.data?.reading_parts.length===0?e.jsx($,{title:"Failed to load test",message:"An error occurred while loading the test questions. Please try again later."}):e.jsx(ge,{...i,children:e.jsxs("form",{onSubmit:i.handleSubmit(l),className:"min-h-screen",children:[e.jsxs("div",{className:"sticky top-0 z-50 bg-primary-foreground space-y-1",children:[e.jsx(ie,{timeLeft:x,formatTime:N,testType:T.READING,type:a.get(n,"data.material.test_type","Mock")}),e.jsx(le,{activePart:s,testType:T.READING})]}),e.jsxs(re,{value:o,onValueChange:g,children:[e.jsx(ce,{data:c,activeTab:o,testType:T.READING,form:i,testId:d}),e.jsx(oe,{data:c,form:i,testType:T.READING,activeTab:o,setActiveTab:g,currentTabIndex:S,handlePrevious:y,handleNext:p,onSubmit:i.handleSubmit(l),isTestFinished:A,isLoading:j.isPending})]})]})})};function Te({onNext:t}){return e.jsx("div",{className:"flex items-center justify-center min-h-screen py-4 w-full",children:e.jsxs(Q,{className:"w-full max-w-2xl shadow-lg",children:[e.jsxs(G,{className:"flex items-center space-x-2",children:[e.jsx(J,{className:"w-12 h-12"}),e.jsx("h1",{className:"scroll-m-20 text-center text-lg font-extrabold tracking-tight text-balance",children:"IELTS Academic Reading"})]}),e.jsxs(D,{className:"space-y-8",children:[e.jsx("div",{className:"space-y-3",children:e.jsxs("p",{children:[e.jsx("strong",{children:"Time:"})," 1 hour"]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h2",{className:"text-md font-semibold",children:"INSTRUCTIONS TO CANDIDATES"}),e.jsxs("ul",{className:"list-disc pl-5 space-y-1",children:[e.jsx("li",{children:"Answer all the questions."}),e.jsx("li",{children:"You can change your answers at any time during the test."})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h2",{className:"text-md font-semibold",children:"INFORMATION FOR CANDIDATES"}),e.jsxs("ul",{className:"list-disc pl-5 space-y-1",children:[e.jsx("li",{children:"There are 40 questions in this test."}),e.jsx("li",{children:"Each question carries one mark."}),e.jsx("li",{children:"The test clock will show you when there are 10 minutes and 5 minutes remaining."})]})]}),e.jsxs("p",{className:"flex gap-2",children:[e.jsx(K,{})," Read instructions and start only when ready."]})]}),e.jsx(z,{children:e.jsx(B,{className:"w-full",onClick:t,children:"Start test"})})]})})}const rs=()=>e.jsx(W,{steps:[e.jsx(X,{}),e.jsx(Te,{}),e.jsx(ve,{}),e.jsx(fe,{disableOverflow:!0})]});export{rs as default};
