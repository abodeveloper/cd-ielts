import{a as te,j as e,u as pe,t as K,r as d,R as D,e as fe}from"./index-BbklvPpu.js";import{u as ge,F as je,C as ye}from"./useTestLogic-CQo63ygv.js";import{B as W}from"./badge-5FQ91n2Z.js";import{B as H}from"./button-BK83DydW.js";import{C as $,a as V,c as B,d as Q}from"./card-BzsE9E7W.js";import{T as we,a as Se,b as X,c as R,d as Ne,e as F}from"./table-W2ePLfhO.js";import{b as re,e as ve,g as Te,R as G,O as be}from"./index-CbvhZcw0.js";import{l as i}from"./lodash-fTVL00d2.js";import{T as _e}from"./tabs-BQQwGosT.js";import{u as Ae,T as Ee,a as q,P as Ce,C as Ie,b as Le}from"./usePreventPageLeave-XDvu2xsT.js";import{o as Z,b as ke,s as O,n as ee,u as Pe,a as Re}from"./schemas-BYM9Rah-.js";import{u as Fe,a as qe,F as He}from"./index.esm-B-Vf5xVL.js";import{g as Me,p as Oe}from"./listening-3mYEJAkA.js";import{u as $e,E as se}from"./ErrorMessage-IrfQjCx_.js";import{L as Ve}from"./LoadingSpinner-D3IgXavV.js";import"./index-BsslK4Jl.js";import"./index-BdrbzQWw.js";import"./utils-CPYLdFy8.js";import"./index-Dzjbbmb8.js";import"./index-Nr7r8_3J.js";import"./index-BHIge0Hg.js";import"./index-bytFTQlw.js";import"./index-CXtE11F1.js";import"./index-BUUEPINl.js";import"./index-CpNnetnF.js";import"./createLucideIcon-2ADmymkX.js";import"./index-D8CtAA40.js";import"./index-RnJkw4uL.js";import"./index-C4a00Uj_.js";import"./form-C6HBuQGw.js";import"./dropdown-menu-tZExcf0d.js";import"./chevron-right-zF019B71.js";import"./input-Bng3fGE8.js";import"./select-6PsKiFgP.js";import"./index-Nk0DrRtG.js";import"./slider-QGSwncsB.js";import"./index-Bs4xmec2.js";function Be({formData:a}){const{user:p}=te(),h=i.get(a,"finish"),u=i.get(a,"test_type"),r=i.get(a,"overall_score"),A=i.get(a,"percentage_correct_for_material",0),E=i.get(a,"answers",[]),j=i.get(a,"total_answers",0),o=i.get(a,"total_correct_answers",0),C=i.get(a,"total_incorrect_answers",0),_=()=>{h()};return e.jsx("div",{className:"p-4 w-full",children:e.jsxs($,{className:"w-full shadow-lg",children:[e.jsxs(V,{className:"flex items-center space-x-2",children:[e.jsx(re,{className:"w-12 h-12"}),e.jsx("h1",{className:"text-center text-lg font-extrabold tracking-tight text-balance",children:"IELTS Academic Listening - Results"})]}),e.jsxs(B,{className:"space-y-8",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Candidate:"}),e.jsx("div",{children:i.get(p,"full_name")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Total Questions:"}),e.jsx("div",{children:j})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Correct answers:"}),e.jsx("div",{className:"text-green-500",children:o})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Incorrect answers:"}),e.jsx("div",{className:"text-destructive",children:C})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Percentage correct for material:"}),e.jsxs("div",{children:[A,"%"]})]}),u==="mock"&&e.jsxs("div",{className:"flex items-center gap-2 mt-4",children:[e.jsx("strong",{children:"Overal:"}),e.jsx(W,{variant:"default",children:r})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h2",{className:"text-md font-semibold",children:"Answer Review"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(we,{className:"h-[400px]",children:[e.jsx(Se,{children:e.jsxs(X,{children:[e.jsx(R,{children:"Question"}),e.jsx(R,{children:"Your Answer"}),e.jsx(R,{children:"True Answer"}),e.jsx(R,{children:"Status"})]})}),e.jsx(Ne,{children:E.map(g=>e.jsxs(X,{children:[e.jsx(F,{children:g.question_number}),e.jsx(F,{children:g.answer||e.jsx(W,{className:"bg-orange-500",children:"Not answered"})}),e.jsx(F,{children:g.true_answer}),e.jsx(F,{children:g.is_true?e.jsx(ve,{className:"text-green-500"}):e.jsx(Te,{className:"text-destructive"})})]},g.id))})]})})]})]}),e.jsx(Q,{children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsxs("p",{className:"flex gap-2",children:[e.jsx(G,{})," Review and finalize your results."]}),e.jsx(H,{className:"w-64",onClick:()=>_(),children:"Finish"})]})})]})})}const Qe=Z({answers:ke(Z({listening_id:ee().optional()||O().optional(),question_number:ee().optional()||O().optional(),answer:O().nullable().optional()}).nullable()).optional()}),Ge=a=>$e({queryKey:["listenings",a],queryFn:()=>Me(a),enabled:!!a}),ne=(a=[])=>[...a].sort((p,h)=>{const u=(p.listening_section??0)-(h.listening_section??0);return u!==0?u:p.id-h.id}),Ue=(a,p)=>{const{user:h}=te(),u=pe(),r=Ge(a),A=h?.id||"guest",E=i.get(r.data,"is_view"),j=i.get(r.data,"material"),o=()=>{if(h?.role===D.TEACHER)u("/");else if(String(i.get(j,"test_type"))?.toLowerCase()=="mock"){const t=i.get(j,"next_test"),l=i.get(j,"next_test_id");u(t==="listening"&&l?`/listenings/${l}`:t==="reading"&&l?`/readings/${l}`:t==="speaking"&&l?`/speakings/${l}`:t==="writing"&&l?`/writings/${l}`:"/")}else u("/")},C=t=>{h?.role===D.TEACHER?p?.({...t,material:j,finish:o}):E===!0?p?.({...t,material:j}):o()},_=Pe({mutationFn:t=>Oe(a,t),onSuccess:t=>{K.success("Successfully submitted!"),C(t)},onError:t=>{console.error("Error:",t),K.error(i.get(t,"response.data.error",""))}}),g=Fe({resolver:Re(Qe),defaultValues:{answers:[]}}),{fields:I,replace:L}=qe({control:g.control,name:"answers"}),f=`listening_answers_${A}_${a}`;return d.useEffect(()=>{const t=r.data,l=Array.isArray(t?.listening_parts)?ne(t.listening_parts):[];if(l.length===0)return;const x=Math.max(...l.flatMap(m=>m?.question_numbers?.map(y=>y.question_number))),s=Array(x).fill(null);l.forEach(m=>{m?.question_numbers?.forEach(y=>{const N=y.question_number-1;s[N]={listening_id:m.id,question_number:y.question_number,answer:""}})});try{const m=localStorage.getItem(f);if(m){const y=JSON.parse(m);s.forEach((N,S)=>{y[S]&&y[S].answer&&(s[S].answer=y[S].answer)})}}catch(m){console.warn("Failed to load saved answers:",m)}L(s)},[r.data,L,f]),d.useEffect(()=>{const t=g.watch(l=>{if(l.answers&&l.answers.length>0)try{localStorage.setItem(f,JSON.stringify(l.answers))}catch(x){console.warn("Failed to save answers:",x)}});return()=>t.unsubscribe()},[g,f]),{form:g,listeningMutation:_,onSubmit:t=>{const l=(t.answers??[]).filter(x=>x!=null);_.mutate(l);try{localStorage.removeItem(f)}catch(x){console.warn("Failed to clear saved answers:",x)}},answersFields:I,query:r,finish:o}};function Ye({onNext:a}){const[p,h]=d.useState(!1),u=d.useRef(null),r=()=>{p?u.current?.pause():u.current?.play(),h(!p)};return e.jsx("div",{className:"flex items-center justify-center min-h-screen py-4",children:e.jsxs($,{className:"w-full max-w-xl shadow-lg",children:[e.jsxs(V,{className:"flex items-center space-x-2",children:[e.jsx(be,{className:"w-12 h-12"}),e.jsx("h1",{className:"scroll-m-20 text-center text-lg font-extrabold tracking-tight text-balance",children:"Test sound"})]}),e.jsxs(B,{className:"space-y-6",children:[e.jsx("p",{className:"text-center",children:"Put on your headphones and click on the Play sound button to play a sample sound."}),e.jsx("div",{className:"flex justify-center",children:e.jsx(H,{variant:"outline",onClick:r,children:p?"Stop sound":"Play sound"})}),e.jsxs("p",{className:"flex gap-2",children:[e.jsx(G,{className:"text-destructive"})," If you cannot hear the sound clearly, please tell the invigilator."]}),e.jsx("audio",{ref:u,src:"https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3"})]}),e.jsx(Q,{children:e.jsx(H,{className:"w-full",onClick:a,children:"Continue"})})]})})}const ze=({onNext:a})=>{const{id:p}=fe(),{form:h,onSubmit:u,query:r,listeningMutation:A,finish:E}=Ue(p,a),j=i.get(r,"data.listening_parts",[]),o=d.useMemo(()=>ne(Array.isArray(j)?j:[]),[j]),C=i.get(r,"data.answer_time",null);(i.get(r,"data.material.test_type","Mock")||"Mock").toString().toLowerCase();const[_,g]=d.useState(!1),[I,L]=d.useState(!0),[f,k]=d.useState(0),[t,l]=d.useState(!1),x=d.useRef([]),s=d.useRef(null),[m,y]=d.useState(()=>{const n=localStorage.getItem("audioVolume");return n?parseFloat(n):1}),[N,S]=d.useState(!1),[U,ae]=d.useState(!1),[v,M]=d.useState(!1);d.useEffect(()=>{r.data&&(i.get(r,"data.material.test_type","Mock")==="Thematic"?(S(!0),M(!1)):(S(!1),M(!0)))},[r.data]);const{timeLeft:ie,formatTime:oe,activeTab:P,setActiveTab:Y,currentTabIndex:le,handlePrevious:ce,handleNext:de,isTestFinished:z}=ge(C,o,h.handleSubmit(u),_,E);Ae(!z),d.useEffect(()=>{if(r.isSuccess&&o.length>0&&!t){let n=0;const c=[];o.forEach((T,b)=>{const w=new Audio;w.src=T.audio,w.preload="auto",w.volume=m,c[b]=w,w.oncanplaythrough=()=>{n++,n===o.length&&(l(!0),x.current=c)},w.onerror=xe=>{console.error(`Audio yuklashda xato (part ${T.id}):`,xe),n++,n===o.length&&(l(!0),x.current=c)}})}},[r.isSuccess,o,t,m]);const ue=()=>{L(!1),x.current.length>0&&(s.current=x.current[0],i.get(r,"data.material.test_type","Mock")==="Mock"&&s.current.play().catch(c=>{console.error("Birinchi audio ijro etishda xato:",c)}))};d.useEffect(()=>{localStorage.setItem("audioVolume",m.toString()),x.current.forEach(n=>{n.volume=m})},[m]),d.useEffect(()=>{r.data&&t&&i.get(r,"data.material.test_type","Mock")==="Thematic"&&s.current&&(s.current.pause(),s.current.currentTime=0)},[r.data,t]),d.useEffect(()=>{if(I||!t||o.length===0)return;const n=i.get(r,"data.material.test_type","Mock");if(n==="Thematic"&&!v)return;const c=s.current,T=()=>{f<o.length-1?(c&&(c.pause(),c.currentTime=0),k(b=>b+1)):(g(!0),c&&(c.pause(),c.currentTime=0))};if(f<o.length){const b=x.current[f];b&&b!==c?(c&&(c.pause(),c.currentTime=0,c.removeEventListener("ended",T)),s.current=b,s.current.volume=m,n==="Thematic"&&!v&&(s.current.pause(),s.current.currentTime=0),!N&&v&&s.current.play().catch(w=>{console.error(`Audio ijro etishda xato (part ${o[f].id}):`,w)}),s.current.addEventListener("ended",T)):c&&(c.paused&&!N&&v&&c.play().catch(w=>{console.error("Audio ijro etishda xato:",w)}),c.addEventListener("ended",T))}return()=>{s.current&&(s.current.pause(),s.current.removeEventListener("ended",T))}},[f,o,I,t,m,N,v]),d.useEffect(()=>{"mediaSession"in navigator&&(navigator.mediaSession.setActionHandler("play",()=>{s.current&&s.current.paused&&v&&s.current.play()}),navigator.mediaSession.setActionHandler("pause",()=>{s.current&&!s.current.paused&&s.current.pause()}),navigator.mediaSession.setActionHandler("stop",()=>{s.current&&(s.current.pause(),s.current.currentTime=0)}),navigator.mediaSession.setActionHandler("nexttrack",()=>{f<o.length-1&&k(n=>n+1)}),navigator.mediaSession.setActionHandler("previoustrack",()=>{f>0&&k(n=>n-1)}))},[f,o.length,v]);const J=n=>{y(n)},me=()=>{if(s.current)if(N){s.current.play(),S(!1),M(!0);const{user:n}=useAuthStore.getState();n?.role===Role.STUDENT&&ae(!0)}else{const{user:n}=useAuthStore.getState();(n?.role===Role.TEACHER||!U)&&(s.current.pause(),S(!0))}},he=o.find(n=>`tab-${n.id}`===P);return r.isLoading||!t?e.jsx(Ve,{message:"Loading test data and audio files..."}):r.isError?e.jsx(se,{title:"Failed to Load Test",message:"An error occurred while loading the test. Please try again later."}):r.data?.listening_parts.length===0?e.jsx(se,{title:"Failed to load test",message:"An error occurred while loading the test questions. Please try again later."}):e.jsx(e.Fragment,{children:I?e.jsx(Ye,{onNext:ue,onVolumeChange:J,initialVolume:m,audioElements:x.current}):e.jsx(He,{...h,children:e.jsxs("form",{onSubmit:h.handleSubmit(u),className:"min-h-screen",children:[e.jsxs("div",{className:"sticky top-0 z-50 bg-primary-foreground space-y-1",children:[e.jsx(Ee,{timeLeft:ie,formatTime:oe,testType:q.LISTENING,type:i.get(r,"data.material.test_type","Mock"),audioRef:s,handleVolumeChange:J,handlePauseToggle:me,isPaused:N,studentHasStarted:U,userHasStarted:v}),e.jsx(Ce,{activePart:he,testType:q.LISTENING})]}),e.jsxs(_e,{value:P,onValueChange:Y,children:[e.jsx(Ie,{data:o,activeTab:P,testType:q.LISTENING,form:h,testId:p}),e.jsx(Le,{data:o,testType:q.LISTENING,form:h,activeTab:P,setActiveTab:Y,currentTabIndex:le,handlePrevious:ce,handleNext:de,onSubmit:h.handleSubmit(u),isTestFinished:z,isLoading:A.isPending})]})]})})})};function Je({onNext:a}){return e.jsx("div",{className:"flex items-center justify-center min-h-screen py-4",children:e.jsxs($,{className:"w-full max-w-3xl shadow-lg",children:[e.jsxs(V,{className:"flex items-center space-x-2",children:[e.jsx(re,{className:"w-12 h-12"}),e.jsx("h1",{className:"scroll-m-20 text-center text-lg font-extrabold tracking-tight text-balance",children:"IELTS Academic Listening"})]}),e.jsxs(B,{className:"space-y-8",children:[e.jsx("div",{className:"space-y-3",children:e.jsxs("p",{children:[e.jsx("strong",{children:"Time:"})," Approximately 30 minutes"]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h2",{className:"text-md font-semibold",children:"INSTRUCTIONS TO CANDIDATES"}),e.jsxs("ul",{className:"list-disc pl-5 space-y-1",children:[e.jsx("li",{children:"Answer all the questions."}),e.jsx("li",{children:"You can change your answers at any time during the test."})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h2",{className:"text-md font-semibold",children:"INFORMATION FOR CANDIDATES"}),e.jsxs("ul",{className:"list-disc pl-5 space-y-1",children:[e.jsx("li",{children:"There are 40 questions in this test."}),e.jsx("li",{children:"Each question carries one mark."}),e.jsx("li",{children:"There are four parts to the test."}),e.jsx("li",{children:"You will hear each part once."}),e.jsx("li",{children:"For each part of the test there will be time for you to look through the questions and time for you to check your answers."})]})]}),e.jsxs("p",{className:"flex gap-2",children:[e.jsx(G,{})," Read instructions and start only when ready."]})]}),e.jsx(Q,{children:e.jsx(H,{className:"w-full",onClick:a,children:"Start test"})})]})})}const ks=()=>e.jsx(je,{steps:[e.jsx(ye,{}),e.jsx(Je,{}),e.jsx(ze,{}),e.jsx(Be,{disableOverflow:!0})]});export{ks as default};
