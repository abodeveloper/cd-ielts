import{j as e,d as te,a as se,u as he,t as J,R as fe,r as i,e as xe}from"./index-Dc-rmQkW.js";import{H as ge,u as je,F as we,C as ye}from"./useTestLogic-orzMV7w5.js";import{B as R}from"./button-BX1yFgj9.js";import{C as F,a as ne,c as z,d as re}from"./card-b2V0xSxv.js";import{h as ie,R as ae,u as Se,x as X,y as be,q as ve,s as Ne,L as ke,r as Te,j as Re}from"./index-DWREddIm.js";import{T as Ce,d as qe}from"./tabs-CQO0JCVR.js";import{o as Ae,_ as Fe,u as ze,a as Le}from"./schemas-wWXiDUz1.js";import{l as A}from"./lodash-CynURBul.js";import{u as Ee,F as Me}from"./index.esm-bw4VsoFT.js";import{u as Pe,E as Z}from"./ErrorMessage-BgvG3orv.js";import{c as Ue}from"./utils-CPYLdFy8.js";import{L as ce}from"./LoadingSpinner-D6cIQfJt.js";import"./index-C_JrZxMX.js";import"./index-BdrbzQWw.js";import"./index-4-CQNtZp.js";import"./index-DAOL4aLo.js";import"./index-DIuh16FO.js";import"./index-DUbKewCE.js";import"./index-t3NeXexo.js";import"./index-VSwM3UcU.js";import"./createLucideIcon-B3rbTt4n.js";function _e({onNext:s}){return e.jsx("div",{className:"flex items-center justify-center min-h-screen py-4",children:e.jsxs(F,{className:"w-full max-w-3xl shadow-lg",children:[e.jsxs(ne,{className:"flex items-center space-x-2",children:[e.jsx(ie,{className:"w-12 h-12"}),e.jsx("h1",{className:"scroll-m-20 text-center text-lg font-extrabold tracking-tight text-balance",children:"IELTS Academic Speaking"})]}),e.jsxs(z,{className:"space-y-8",children:[e.jsx("div",{className:"space-y-3",children:e.jsxs("p",{children:[e.jsx("strong",{children:"Time:"})," 11â€“14 minutes"]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h2",{className:"text-md font-semibold",children:"INSTRUCTIONS TO CANDIDATES"}),e.jsxs("ul",{className:"list-disc pl-5 space-y-1",children:[e.jsx("li",{children:"This test will be recorded through your microphone."}),e.jsx("li",{children:"Speak clearly and answer all the questions."}),e.jsx("li",{children:"You cannot pause or repeat the questions."})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h2",{className:"text-md font-semibold",children:"INFORMATION FOR CANDIDATES"}),e.jsxs("ul",{className:"list-disc pl-5 space-y-1",children:[e.jsx("li",{children:"The Speaking test has three parts."}),e.jsx("li",{children:"Part 1: Introduction and interview."}),e.jsx("li",{children:"Part 2: Long turn (1 minute to prepare, 1â€“2 minutes to speak)."}),e.jsx("li",{children:"Part 3: Two-way discussion."})]})]}),e.jsxs("p",{className:"flex gap-2",children:[e.jsx(ae,{})," Check your microphone before starting."]})]}),e.jsx(re,{children:e.jsx(R,{className:"w-full",onClick:s,children:"Start Speaking Test"})})]})})}const Ie=async s=>(await te.get(`/api/speaking/by-material/${s}/`)).data,De=async s=>(await te.post("/api/speaking-answers/",s,{headers:{"Content-Type":"multipart/form-data"}})).data,Be=Ae({record:Fe(File).refine(s=>s.type.startsWith("audio/"),{message:"Faqat audio fayllar qabul qilinadi"})}),ee=s=>Pe({queryKey:["speakings",s],queryFn:()=>Ie(s),enabled:!!s}),He=s=>{const{user:m}=se(),l=he(),p=ee(s),u=A.get(p.data,"material"),f=()=>{if(m?.role===fe.TEACHER)l("/");else if(String(A.get(u,"test_type"))?.toLowerCase()=="mock"){const n=A.get(u,"next_test"),r=A.get(u,"next_test_id");l(n==="listening"&&r?`/listenings/${r}`:n==="speaking"&&r?`/speakings/${r}`:n==="writing"&&r?`/writings/${r}`:"/")}else l("/")},h=()=>{f()},x=ze({mutationFn:n=>De(n),onSuccess:()=>{J.success("Successfully submitted!"),h()},onError:n=>{console.error("Error:",n),J.error(A.get(n,"response.data.error",""))}});return{form:Ee({resolver:Le(Be),defaultValues:{record:void 0}}),speakingMutation:x,onSubmit:n=>{x.isPending||x.mutate(n)},query:ee(s)}},$e=()=>{const[s,m]=i.useState(0),[l,p]=i.useState(0),u=i.useCallback(()=>{m(window.innerWidth),p(window.innerHeight)},[m,p]);return i.useEffect(()=>(window.addEventListener("resize",u),u(),()=>window.removeEventListener("resize",u)),[u]),[s,l]};function Oe(s,m,l,p,u){s.getByteFrequencyData(p),l.fillStyle="#000";const f=m.height/2;var h=Math.ceil(m.width/u)*2.5;let x,a=0;for(var c=0;c<u;c++)x=p[c]/255*f,l.fillStyle="#21C55d",l.fillRect(a,f-x,h,x),a+=h+1}const Ve=({analyzerData:s})=>{const m=i.useRef(null),{dataArray:l,analyzer:p,bufferLength:u}=s,f=(a,c,n)=>{const r=m.current;if(!r||!c)return;const w=r.getContext("2d");if(!w)return;const y=()=>{!m.current||!c||(requestAnimationFrame(y),r.width=r.width,Oe(c,r,w,a,n))};y()};i.useEffect(()=>{f(l,p,u)},[l,p,u]);const[h,x]=$e();return e.jsx("canvas",{ref:m,width:h,height:x,style:{maxWidth:"600px",maxHeight:"100px",marginTop:"16px",width:"100%"}})},We=({part:s,activeTab:m,isLastPart:l,onNextPart:p,onFinish:u,allAudioChunks:f})=>{const[h,x]=i.useState(0),[a,c]=i.useState("preparation"),[n,r]=i.useState(null),[w,y]=i.useState(!1),[L,E]=i.useState(!1),[M,C]=i.useState(null),d=i.useRef(null),N=i.useRef(null),S=i.useRef(null),k=i.useRef(null),T=i.useRef(null),[P,g]=i.useState(!1),b=i.useRef(null),U=s?.question_numbers||[],j=U[h],$=o=>{if(o===null)return"";if(o<60)return e.jsx("div",{className:"w-[50px]",children:`${o} s`});{const t=Math.floor(o/60),H=o%60;return e.jsx("div",{className:"w-[50px]",children:`${t}:${H.toString().padStart(2,"0")}`})}},O=o=>{if(!o)return"";const t=document.createElement("div");return t.innerHTML=o,t.textContent||t.innerText||""},oe=()=>{if(!j||!j.question)return;if(!("speechSynthesis"in window)){console.warn("Text-to-Speech is not supported in this browser.");return}const o=O(j.question).trim();if(!o)return;window.speechSynthesis.cancel();const t=new SpeechSynthesisUtterance(o);t.lang="en-US",t.rate=.95,t.pitch=1,t.onstart=()=>g(!0),t.onend=()=>{g(!1),b.current=null},t.onerror=()=>{g(!1),b.current=null},b.current=t,window.speechSynthesis.speak(t)},le=()=>{"speechSynthesis"in window&&(window.speechSynthesis.cancel(),g(!1),b.current=null)};i.useEffect(()=>{if(!j||!j.question){window.speechSynthesis&&window.speechSynthesis.cancel(),g(!1),b.current=null;return}if(!("speechSynthesis"in window))return;window.speechSynthesis.cancel(),g(!1);const o=O(j.question).trim();if(!o)return;const t=new SpeechSynthesisUtterance(o);return t.lang="en-US",t.rate=.95,t.pitch=1,t.onstart=()=>g(!0),t.onend=()=>{g(!1),b.current=null},t.onerror=()=>{g(!1),b.current=null},b.current=t,window.speechSynthesis.speak(t),()=>{window.speechSynthesis&&window.speechSynthesis.cancel(),g(!1),b.current=null}},[j?.question_number]),i.useEffect(()=>{j&&a==="preparation"&&m===`tab-${s.id}`&&r(s.prep_time)},[h,m,a,j,s.prep_time]),i.useEffect(()=>{if(n===null||a==="paused"||a==="finish")return;if(n<=0){a==="preparation"?(c("answering"),r(s.answer_time),V()):a==="answering"&&(W(),c("paused"),r(0));return}const o=setTimeout(()=>{r(t=>t!==null?t-1:null)},1e3);return()=>clearTimeout(o)},[n,a,s.answer_time]),i.useEffect(()=>{if(a==="paused"&&n===0&&!L){const o=setTimeout(()=>{console.log("Paused phase:",{currentIndex:h,questionsLength:U.length,isLastPart:l}),h<U.length-1?(x(t=>t+1),c("preparation"),r(null)):!l&&p?(p(),x(0),c("preparation"),r(null)):l&&u&&(console.log("onFinish called"),E(!0),ue().finally(()=>{c("finish"),u()}))},1e3);return()=>clearTimeout(o)}},[a,n,h,U.length,l,p,u,L]);const V=async()=>{try{if(d.current&&d.current.state==="paused"){d.current.resume(),y(!0),T.current&&C(T.current);return}if(d.current?.state==="recording")return;const o=await navigator.mediaDevices.getUserMedia({audio:{channelCount:1,sampleRate:44100,sampleSize:16,echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});k.current=o;const t=new(window.AudioContext||window.webkitAudioContext);S.current=t;const H=t.createMediaStreamSource(o),_=t.createBiquadFilter();_.type="highpass",_.frequency.value=120;const I=t.createBiquadFilter();I.type="lowpass",I.frequency.value=8e3;const v=t.createDynamicsCompressor();v.threshold.setValueAtTime(-30,t.currentTime),v.knee.setValueAtTime(30,t.currentTime),v.ratio.setValueAtTime(12,t.currentTime),v.attack.setValueAtTime(.003,t.currentTime),v.release.setValueAtTime(.25,t.currentTime);const G=t.createMediaStreamDestination();H.connect(_),_.connect(I),I.connect(v),v.connect(G);const D=t.createAnalyser();D.fftSize=2048;const K=D.frequencyBinCount,de=new Uint8Array(K);v.connect(D),T.current={analyzer:D,bufferLength:K,dataArray:de},C(T.current);const me=G.stream,Y=["audio/mpeg","audio/webm;codecs=opus","audio/webm"].find(q=>MediaRecorder.isTypeSupported(q)),pe=Y?{mimeType:Y,audioBitsPerSecond:128e3}:{audioBitsPerSecond:128e3},B=new MediaRecorder(me,pe);d.current=B,B.ondataavailable=q=>{q.data.size>0&&f.current.push(q.data)},B.onstop=()=>{y(!1),C(null),T.current=null,d.current=null,k.current&&(k.current.getTracks().forEach(q=>q.stop()),k.current=null),S.current&&(S.current.close(),S.current=null),N.current&&(N.current(),N.current=null)},B.start(),y(!0)}catch(o){console.error("Microphone permission denied:",o),c("paused"),r(0)}},W=()=>{d.current&&d.current.state==="recording"&&(d.current.pause(),y(!1),C(null))},ue=()=>new Promise(o=>{d.current&&d.current.state!=="inactive"?(N.current=()=>o(),d.current.stop()):o()}),Q=async o=>{o.preventDefault(),a==="preparation"?(c("answering"),r(s.answer_time),await V()):a==="answering"&&w&&(W(),c("paused"),r(0))};return j?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-[calc(100vh-225px)] flex flex-col items-center justify-center gap-6 p-[100px]",children:e.jsxs("div",{className:"flex flex-col gap-10",children:[e.jsxs("div",{className:"text-lg font-extrabold",children:[a==="preparation"&&e.jsxs("div",{className:"flex flex-col gap-4 items-center justify-center",children:[e.jsx(Se,{size:80,className:"text-orange-500"}),e.jsxs("div",{className:"text-orange-500 flex items-center gap-2 justify-center",children:[e.jsx("div",{children:"Preparation:"})," ",$(n)]})]}),a==="answering"&&e.jsxs("div",{className:"flex flex-col gap-4 items-center justify-center",children:[e.jsx(X,{size:80,className:"text-green-500"}),e.jsxs("div",{className:"text-green-500 flex items-center gap-2 justify-center",children:[e.jsx("div",{children:"Speaking:"})," ",$(n)]}),w&&M&&e.jsx(Ve,{analyzerData:M})]}),a==="paused"&&e.jsx(ce,{}),a==="finish"&&e.jsxs("div",{className:"flex flex-col gap-4 items-center justify-center",children:[e.jsx(be,{size:80,className:"text-green-500"}),e.jsx("div",{className:"text-green-500",children:"Test Completed"})]})]}),a!=="finish"&&e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsxs("div",{className:"text-2xl font-bold text-center",children:[j.question_number,"."," ",e.jsx(ge,{htmlString:j.question})]}),e.jsx("div",{className:"flex items-center gap-3",children:e.jsx(R,{type:"button",variant:"outline",size:"sm",onClick:P?le:oe,className:"flex items-center gap-2",children:P?e.jsxs(e.Fragment,{children:[e.jsx(ve,{size:18}),e.jsx("span",{children:"Stop Reading"})]}):e.jsxs(e.Fragment,{children:[e.jsx(Ne,{size:18}),e.jsx("span",{children:"Read Question"})]})})})]})]})}),e.jsx(F,{className:"w-full shadow-md p-2 px-5 sticky bottom-0 z-50 rounded-none",children:e.jsx(z,{className:"p-0 flex items-center justify-end gap-2 h-[80px]",children:(a==="preparation"||a==="answering")&&e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[a==="preparation"&&e.jsxs(R,{variant:"success",onClick:Q,className:"flex items-center gap-2",children:[e.jsx(X,{size:20}),"Start Answering"]}),a==="answering"&&w&&e.jsxs(R,{variant:"destructive",onClick:Q,className:"flex items-center gap-2",children:[e.jsx(ke,{size:20}),"Stop and Continue",e.jsx(Te,{size:20})]})]})})})]}):e.jsx("div",{className:"text-center text-lg",children:"No question available"})},Qe=()=>{const{id:s}=xe(),{user:m}=se(),{form:l,onSubmit:p,query:u}=He(s),[f,h]=i.useState(null),[x,a]=i.useState(!1),c=i.useRef([]),n=A.get(u,"data.speaking_parts",[]),{activeTab:r,setActiveTab:w,currentTabIndex:y}=je(null,n,()=>{},!1),L=y===n.length-1,E=n.find(d=>`tab-${d.id}`===r);i.useEffect(()=>{if(f&&URL.revokeObjectURL(f),c.current.length>0){const N=c.current[0].type||"audio/webm",S=new Blob(c.current,{type:N}),k=URL.createObjectURL(S);h(k)}else h(null);return()=>{f&&URL.revokeObjectURL(f)}},[c.current.length]);const M=()=>{y<n.length-1&&w(`tab-${n[y+1].id}`)},C=()=>{if(x){console.log("Submit allaqachon bajarilgan, qayta urinish rad etildi");return}a(!0);const d=new FormData;if(c.current.length>0){const S=c.current[0].type||"audio/webm",T=S.includes("mpeg")||S.includes("mp3")?"mp3":"webm",P=new Blob(c.current,{type:S}),g=new File([P],`speaking-test-combined.${T}`,{type:S});d.append("record",g),d.append("speaking",s||""),console.log("FormData ga qoâ€˜shildi:",{fileName:g.name,fileSize:g.size,fileType:g.type,speakingId:s})}else console.warn("Hech qanday audio yozilmadi"),d.append("speaking",s||"");p(d)};return u.isLoading?e.jsx(ce,{message:"Loading test data..."}):u.isError?e.jsx(Z,{title:"Failed to Load Test",message:"An error occurred while loading the test. Please try again later."}):u.data?.speaking_parts.length===0?e.jsx(Z,{title:"Failed to load test",message:"An error occurred while loading the test questions. Please try again later."}):e.jsx(Me,{...l,children:e.jsxs("form",{className:"min-h-screen",children:[e.jsxs("div",{className:"sticky top-0 z-50 bg-primary-foreground space-y-1",children:[e.jsx(F,{className:"w-full shadow-md rounded-none",children:e.jsxs(z,{className:"p-3 flex justify-between items-center h-[50px]",children:[e.jsxs("div",{className:"text-sm flex items-center gap-2",children:[e.jsx(Re,{}),e.jsx("b",{children:"Candidate:"})," ",m?.username||"Guest"]}),e.jsx("div",{className:"flex items-center gap-8"})]})}),e.jsx(F,{className:"w-full shadow-sm rounded-none",children:e.jsxs(z,{className:"p-3 text-sm h-[70px]",children:[e.jsxs("div",{className:"font-semibold",children:["Part ",E?.speaking_part]}),e.jsx("div",{children:E?.description})]})})]}),e.jsx(Ce,{value:r,onValueChange:w,children:e.jsx("div",{children:n.map(d=>e.jsx(qe,{value:`tab-${d.id}`,className:Ue("h-full bg-muted",r!==`tab-${d.id}`&&"hidden"),children:e.jsx(We,{part:d,activeTab:r,isLastPart:L,onNextPart:M,onFinish:C,allAudioChunks:c})},d.id))})})]})})};function Ge({onNext:s}){const[m,l]=i.useState(!1),[p,u]=i.useState(null),f=i.useRef(null),h=i.useRef([]),x=async()=>{try{const c=await navigator.mediaDevices.getUserMedia({audio:!0}),n=new MediaRecorder(c);f.current=n,h.current=[],n.ondataavailable=r=>{r.data.size>0&&h.current.push(r.data)},n.onstop=()=>{const r=new Blob(h.current,{type:"audio/webm"}),w=URL.createObjectURL(r);u(w)},n.start(),l(!0)}catch(c){console.error("Microphone access denied:",c),alert("Please allow microphone access to continue.")}},a=()=>{f.current?.stop(),l(!1)};return e.jsx("div",{className:"flex items-center justify-center min-h-screen py-4",children:e.jsxs(F,{className:"w-full max-w-xl shadow-lg",children:[e.jsxs(ne,{className:"flex items-center space-x-2",children:[e.jsx(ie,{className:"w-12 h-12"}),e.jsx("h1",{className:"scroll-m-20 text-center text-lg font-extrabold tracking-tight text-balance",children:"Test microphone"})]}),e.jsxs(z,{className:"space-y-6",children:[e.jsx("p",{className:"text-center",children:"Click on the button below and say a few words to check your microphone."}),e.jsx("div",{className:"flex justify-center gap-2",children:m?e.jsx(R,{variant:"destructive",onClick:a,children:"â¹ Stop recording"}):e.jsx(R,{variant:"outline",onClick:x,children:"ðŸŽ¤ Start recording"})}),p&&e.jsxs("div",{className:"flex flex-col items-center space-y-2",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Playback your recording:"}),e.jsx("audio",{controls:!0,src:p})]}),e.jsxs("p",{className:"flex gap-2",children:[e.jsx(ae,{className:"text-destructive"}),"If your voice cannot be heard clearly, please tell the invigilator."]})]}),e.jsx(re,{children:e.jsx(R,{className:"w-full",onClick:s,disabled:!p,children:"Continue"})})]})})}const gt=()=>e.jsx(we,{steps:[e.jsx(ye,{}),e.jsx(_e,{}),e.jsx(Ge,{}),e.jsx(Qe,{})]});export{gt as default};
