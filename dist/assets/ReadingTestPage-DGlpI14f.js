import{a as P,j as e,d as k,u as D,t as A,r as z,R,e as V}from"./index-BxWpwr9K.js";import{u as Y,F as K,C as U}from"./useTestLogic-IcuwJ-1K.js";import{B as S}from"./badge-C8u5UXDS.js";import{B as L}from"./button-CNuY1AEb.js";import{C as M,a as O,c as H,d as $}from"./card-Dk_bWVLs.js";import{T as J,a as W,b as E,c as N,d as X,e as y}from"./table-Dh5MqKeZ.js";import{c as B,e as Z,g as ee,R as Q}from"./index-B49kkQR6.js";import{l as a}from"./lodash-B6TVBKew.js";import{T as se}from"./tabs-C6GgIFvb.js";import{u as te,T as ae,a as b,P as re,C as ne,b as ie}from"./usePreventPageLeave-BgcSb0lh.js";import{o as C,b as le,s as v,c as F,n as I,u as ce,a as oe}from"./schemas-B82KTCYB.js";import{u as de,a as me,F as ue}from"./index.esm-ChS6XLnu.js";import{u as xe,E as q}from"./ErrorMessage-D0ZiHF_2.js";import{L as he}from"./LoadingSpinner-CWTzwFnx.js";import"./index-BdrbzQWw.js";import"./utils-CPYLdFy8.js";import"./index-l1yS5F1P.js";import"./index-BDN4nLcq.js";import"./index-Wh0fB7su.js";import"./index-G9_EqjY3.js";import"./index-BG6d6_mM.js";import"./index-D1JhMIMx.js";import"./index-B0vI_HCU.js";import"./createLucideIcon-CICipjdr.js";import"./select-BN9ZGS1D.js";import"./index-B5emdeup.js";import"./index-BqYe3S9A.js";import"./index-DQnzmU1N.js";import"./form-DYmBEsQu.js";import"./circle-BZ55Rx38.js";import"./input-C5VEc5qf.js";function ge({formData:t}){const{user:d}=P(),i=a.get(t,"finish"),l=a.get(t,"test_type"),r=a.get(t,"overall_score"),h=a.get(t,"percentage_correct_for_material",0),n=a.get(t,"answers",[]),g=a.get(t,"total_answers",0),u=a.get(t,"total_correct_answers",0),p=a.get(t,"total_incorrect_answers",0),m=()=>{i()};return e.jsx("div",{className:"p-4 w-full",children:e.jsxs(M,{className:"w-full shadow-lg",children:[e.jsxs(O,{className:"flex items-center space-x-2",children:[e.jsx(B,{className:"w-12 h-12"}),e.jsx("h1",{className:"text-center text-lg font-extrabold tracking-tight text-balance",children:"IELTS Academic Reading - Results"})]}),e.jsxs(H,{className:"space-y-8",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Candidate:"}),e.jsx("div",{children:a.get(d,"full_name")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Total Questions:"}),e.jsx("div",{children:g})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Correct answers:"}),e.jsx("div",{className:"text-green-500",children:u})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Incorrect answers:"}),e.jsx("div",{className:"text-destructive",children:p})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Percentage correct for material:"}),e.jsxs("div",{children:[h,"%"]})]}),l==="mock"&&e.jsxs("div",{className:"flex items-center gap-2 mt-4",children:[e.jsx("strong",{children:"Overal:"}),e.jsx(S,{variant:"default",children:r})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h2",{className:"text-md font-semibold",children:"Answer Review"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(J,{className:"h-[400px]",children:[e.jsx(W,{children:e.jsxs(E,{children:[e.jsx(N,{children:"Question"}),e.jsx(N,{children:"Your Answer"}),e.jsx(N,{children:"True Answer"}),e.jsx(N,{children:"Status"})]})}),e.jsx(X,{children:n.map(o=>e.jsxs(E,{children:[e.jsx(y,{children:o.question_number}),e.jsx(y,{children:o.answer||e.jsx(S,{className:"bg-orange-500",children:"Not answered"})}),e.jsx(y,{children:o.true_answer}),e.jsx(y,{children:o.is_true?e.jsx(Z,{className:"text-green-500"}):e.jsx(ee,{className:"text-destructive"})})]},o.id))})]})})]})]}),e.jsx($,{children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsxs("p",{className:"flex gap-2",children:[e.jsx(Q,{})," Review and finalize your results."]}),e.jsx(L,{className:"w-64",onClick:()=>m(),children:"Finish"})]})})]})})}const pe=async t=>(await k.get(`/api/reading/by-material/${t}/`)).data,je=async(t,d)=>(await k.post(`/api/reading-answers/${t}/`,d)).data,fe=C({answers:le(C({reading_id:F([I(),v()]).optional(),question_number:F([I(),v()]).optional(),answer:v().nullable().optional()}).nullable()).optional()}),we=t=>xe({queryKey:["readings",t],queryFn:()=>pe(t),enabled:!!t}),Ne=(t,d)=>{const{user:i}=P(),l=D(),r=we(t),h=a.get(r.data,"is_view"),n=a.get(r.data,"material"),g=a.get(r.data,"test_type"),u=()=>{if(i?.role===R.TEACHER)l("/");else if(String(a.get(n,"test_type"))?.toLowerCase()=="mock"){const s=a.get(n,"next_test"),c=a.get(n,"next_test_id");l(s==="listening"&&c?`/listenings/${c}`:s==="speaking"&&c?`/speakings/${c}`:s==="writing"&&c?`/writings/${c}`:"/")}else l("/")},p=s=>{g==="Thematic"?d?.({...s,material:n,finish:u}):i?.role===R.TEACHER?d?.({...s,material:n,finish:u}):h===!0?d?.({...s,material:n}):u()},m=ce({mutationFn:s=>je(t,s),onSuccess:s=>{A.success("Successfully submitted!"),p(s)},onError:s=>{console.error("Error:",s),A.error(a.get(s,"response.data.error",""))}}),o=de({resolver:oe(fe),defaultValues:{answers:[]}}),{fields:_,replace:j}=me({control:o.control,name:"answers"});return z.useEffect(()=>{const s=r.data;if(!Array.isArray(s?.reading_parts)||s.reading_parts.length===0)return;const c=Math.max(...s.reading_parts.flatMap(f=>f?.question_numbers?.map(w=>w.question_number))),x=Array(c)?.fill(null);s.reading_parts.forEach(f=>{f?.question_numbers?.forEach(w=>{const G=w.question_number-1;x[G]={reading_id:f.id,question_number:w.question_number,answer:""}})}),j(x)},[r.data,j]),{form:o,readingMutation:m,onSubmit:s=>{const c=(s.answers??[]).filter(x=>x!=null);m.mutate(c)},answersFields:_,query:r}},ye=({onNext:t})=>{const{id:d}=V(),{form:i,onSubmit:l,query:r,readingMutation:h}=Ne(d,t),n=a.get(r,"data.reading_parts",[]),g=a.get(r,"data.answer_time",null),{timeLeft:u,formatTime:p,activeTab:m,setActiveTab:o,currentTabIndex:_,handlePrevious:j,handleNext:T,isTestFinished:s}=Y(g,n,i.handleSubmit(l));te(!s);const c=n.find(x=>`tab-${x.id}`===m);return r.isLoading?e.jsx(he,{message:"Loading test data..."}):r.isError?e.jsx(q,{title:"Failed to Load Test",message:"An error occurred while loading the test. Please try again later."}):r.data?.reading_parts.length===0?e.jsx(q,{title:"Failed to load test",message:"An error occurred while loading the test questions. Please try again later."}):e.jsx(ue,{...i,children:e.jsxs("form",{onSubmit:i.handleSubmit(l),className:"min-h-screen",children:[e.jsxs("div",{className:"sticky top-0 z-50 bg-primary-foreground space-y-1",children:[e.jsx(ae,{timeLeft:u,formatTime:p,testType:b.READING,type:a.get(r,"data.material.test_type","Mock")}),e.jsx(re,{activePart:c,testType:b.READING})]}),e.jsxs(se,{value:m,onValueChange:o,children:[e.jsx(ne,{data:n,activeTab:m,testType:b.READING,form:i}),e.jsx(ie,{data:n,form:i,testType:b.READING,activeTab:m,setActiveTab:o,currentTabIndex:_,handlePrevious:j,handleNext:T,onSubmit:i.handleSubmit(l),isTestFinished:s,isLoading:h.isPending})]})]})})};function be({onNext:t}){return e.jsx("div",{className:"flex items-center justify-center min-h-screen py-4 w-full",children:e.jsxs(M,{className:"w-full max-w-2xl shadow-lg",children:[e.jsxs(O,{className:"flex items-center space-x-2",children:[e.jsx(B,{className:"w-12 h-12"}),e.jsx("h1",{className:"scroll-m-20 text-center text-lg font-extrabold tracking-tight text-balance",children:"IELTS Academic Reading"})]}),e.jsxs(H,{className:"space-y-8",children:[e.jsx("div",{className:"space-y-3",children:e.jsxs("p",{children:[e.jsx("strong",{children:"Time:"})," 1 hour"]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h2",{className:"text-md font-semibold",children:"INSTRUCTIONS TO CANDIDATES"}),e.jsxs("ul",{className:"list-disc pl-5 space-y-1",children:[e.jsx("li",{children:"Answer all the questions."}),e.jsx("li",{children:"You can change your answers at any time during the test."})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h2",{className:"text-md font-semibold",children:"INFORMATION FOR CANDIDATES"}),e.jsxs("ul",{className:"list-disc pl-5 space-y-1",children:[e.jsx("li",{children:"There are 40 questions in this test."}),e.jsx("li",{children:"Each question carries one mark."}),e.jsx("li",{children:"The test clock will show you when there are 10 minutes and 5 minutes remaining."})]})]}),e.jsxs("p",{className:"flex gap-2",children:[e.jsx(Q,{})," Read instructions and start only when ready."]})]}),e.jsx($,{children:e.jsx(L,{className:"w-full",onClick:t,children:"Start test"})})]})})}const es=()=>e.jsx(K,{steps:[e.jsx(U,{}),e.jsx(be,{}),e.jsx(ye,{}),e.jsx(ge,{disableOverflow:!0})]});export{es as default};
