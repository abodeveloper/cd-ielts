import{j as e,c as C,r as N,e as H}from"./index-Cy9jHuRv.js";import{B as c}from"./badge-IrXRMWhS.js";import{C as M,a as z,b as V,c as U}from"./card-BD9FohpU.js";import{B as ce}from"./BackButton-CgA627_F.js";import{u as F,E as X}from"./ErrorMessage-DNrmBrBl.js";import{L as oe}from"./LoadingSpinner-B72d7kK0.js";import{T as le,U as de,W as me,F as ge,c as ue,b as he,_ as fe,h as xe}from"./index-Csn_CNAh.js";import{l as s}from"./lodash-BBcoGl6R.js";import{a as pe}from"./groups-DzCzvBer.js";import{j as _e,k as we,h as je}from"./test-material-B00FWadq.js";import{D as ve}from"./data-table-CkcK5AN_.js";import{I as Ne}from"./input-Dmuv5Y0O.js";import{u as ye}from"./useDebounce-C0HtNpXM.js";import{b as be}from"./helper-DHn6dyFE.js";import{B as E}from"./button-CiEzOr1B.js";import{T as G,a as O,W as D,P as p,A as Q,b as v,c as ke,F as Te,d as Se,e as Ce}from"./index-vYlAMFR9.js";import"./index-BdrbzQWw.js";import"./utils-CPYLdFy8.js";import"./createLucideIcon-tayhp3_E.js";import"./table-CVudzuY3.js";import"./chevron-right-SLim4-4O.js";import"./index-VMR0j23S.js";function Fe(l){const i=[{accessorKey:"full_name",header:"Student Name",cell:({row:t})=>e.jsx("div",{children:t.getValue("full_name")})},{accessorKey:"created_at",header:"Test performed",cell:({row:t})=>{const a=String(t.getValue("created_at"));return e.jsxs(e.Fragment,{children:[a.slice(0,10)," ",a.slice(11,19)]})}},{accessorKey:"actions",header:"Actions",cell:({row:t})=>{const a=s.get(t.original,"is_call",!1),n=s.get(t.original,"is_sms",!1),o=s.get(t.original,"phone","");return e.jsxs("div",{className:"flex items-center gap-2",children:[a&&e.jsx(E,{variant:"outline",size:"icon",onClick:()=>window.open(`tel:${o}`,"_self"),className:"h-8 w-8",children:e.jsx(le,{className:"h-4 w-4"})}),n&&e.jsx(E,{variant:"outline",size:"icon",onClick:()=>window.open(`sms:${o}`,"_self"),className:"h-8 w-8",children:e.jsx(de,{className:"h-4 w-4"})})]})}}],u=[{accessorKey:"total_questions",header:"Total questions",cell:({row:t})=>e.jsx(c,{variant:"outline",children:s.get(t.original.material_info,"total_questions")})},{accessorKey:"incorrect_answers",header:"Incorrect answers",cell:({row:t})=>e.jsx(c,{variant:"destructive",children:s.get(t.original.material_info,"incorrect_answers")})},{accessorKey:"correct_answers",header:"Correct answers",cell:({row:t})=>e.jsx(c,{variant:"success",children:s.get(t.original.material_info,"correct_answers")})},{accessorKey:"score_percentage",header:"Score percentage (%)",cell:({row:t})=>e.jsx(c,{variant:"secondary",children:s.get(t.original.material_info,"score_percentage")})},{accessorKey:"material_info",header:"Answer review",cell:({row:t})=>{const a=t.original.student_id,n=s.get(t.original.material_info,"id",null);return e.jsx(C,{to:`/teacher/students/${a}/thematic/reading/${n}/view`,className:"text-blue-500",children:"View"})}}],m=[{accessorKey:"total_questions",header:"Total questions",cell:({row:t})=>{const a=t.original.material_info;return e.jsx(c,{variant:"outline",children:s.get(a,"total_questions")})}},{accessorKey:"incorrect_answers",header:"Incorrect answers",cell:({row:t})=>{const a=t.original.material_info;return e.jsx(c,{variant:"destructive",children:s.get(a,"incorrect_answers")})}},{accessorKey:"correct_answers",header:"Correct answers",cell:({row:t})=>{const a=t.original.material_info;return e.jsx(c,{variant:"success",children:s.get(a,"correct_answers")})}},{accessorKey:"score_percentage",header:"Score percentage (%)",cell:({row:t})=>{const a=t.original.material_info;return e.jsx(c,{variant:"secondary",children:s.get(a,"score_percentage")})}},{accessorKey:"material_info",header:"Answer review",cell:({row:t})=>{const a=t.original.student_id,n=t.getValue("material_info"),o=s.get(n,"id",null);return e.jsx(e.Fragment,{children:e.jsx(C,{to:`/teacher/students/${a}/thematic/listening/${o}/view`,className:"text-blue-500",children:"View"})})}}],h=[{accessorKey:"writing_task1_score",header:"Writing (T1) score",cell:({row:t})=>{const a=t.original.material_info,n=s.get(a,"writing_task1"),o=s.get(n,"completed",!1);return e.jsx(e.Fragment,{children:o?e.jsx(c,{variant:"secondary",children:s.get(n,"score")}):e.jsx(c,{variant:"destructive",children:"Not completed"})})}},{accessorKey:"writing_task2_score",header:"Writing (T2) score",cell:({row:t})=>{const a=t.original.material_info,n=s.get(a,"writing_task2"),o=s.get(n,"completed",!1);return e.jsx(e.Fragment,{children:o?e.jsx(c,{variant:"secondary",children:s.get(n,"score")}):e.jsx(c,{variant:"destructive",children:"Not completed"})})}},{accessorKey:"score",header:"Total score",cell:({row:t})=>{const a=t.original.material_info;return e.jsx(c,{variant:"default",children:s.get(a,"score")})}},{accessorKey:"material_info",header:"Answer review",cell:({row:t})=>{const a=t.original.student_id,n=t.getValue("material_info"),o=s.get(n,"id",null);return e.jsx(e.Fragment,{children:e.jsx(C,{to:`/teacher/students/${a}/thematic/writing/${o}/view`,className:"text-blue-500",children:"View"})})}}],f=[{accessorKey:"feedback",header:"Feedback",cell:({row:t})=>{const a=t.original.material_info;return e.jsx(e.Fragment,{children:s.get(a,"feedback")})}},{accessorKey:"score",header:"Score",cell:({row:t})=>{const a=t.original.material_info;return e.jsx(c,{variant:"default",children:s.get(a,"score")})}},{accessorKey:"material_info",header:"Answer review",cell:({row:t})=>{const a=t.original.student_id,n=t.getValue("material_info"),o=s.get(n,"id",null);return e.jsx(e.Fragment,{children:e.jsx(C,{to:`/teacher/students/${a}/thematic/writing/${o}/view`,className:"text-blue-500",children:"View"})})}}];return l==="reading"?[...i,...u]:l==="speaking"?[...i,...f]:l==="listening"?[...i,...m]:l==="writing"?[...i,...h]:i}const Ke=({testData:l,type:i,material_id:u,group_id:m})=>{const[h,f]=N.useState(!1),t=N.useMemo(()=>({material_id:u,group_id:m}),[u,m]),{data:a,fetchStatus:n,refetch:o}=F({queryKey:["thematic-full-results",t],queryFn:()=>_e(i,u,m),enabled:!1}),k=async()=>{f(!0);try{const y=(await o()).data?.results||[];if(y.length===0){console.error("No data fetched from API");return}const T=y[0]?.group_name||"Group Result",K=["No","Student Name","Test Performed"];let j=[];i==="reading"||i==="listening"?j=["Total Questions","Correct Answers","Incorrect Answers","Score Percentage (%)"]:i==="writing"?j=["Writing (T1) Score","Writing (T2) Score","Total Score"]:i==="speaking"&&(j=["Feedback","Score"]);const _=[...K,...j],P=y.map((r,g)=>{const d=r.material_info,q={no:g+1,name:r.full_name,created_at:`${r.created_at.slice(0,10)} ${r.created_at.slice(11,19)}`};let S={};return i==="reading"||i==="listening"?S={total_questions:d.total_questions?.toString()||"-",correct_answers:d.correct_answers?.toString()||"-",incorrect_answers:d.incorrect_answers?.toString()||"-",score_percentage:d.score_percentage?.toString()||"-"}:i==="writing"?S={writing_task1_score:d.writing_task1?.completed&&d.writing_task1?.score?d.writing_task1.score.toString():"Not completed",writing_task2_score:d.writing_task2?.completed&&d.writing_task2?.score?d.writing_task2.score.toString():"Not completed",total_score:d.score?.toString()||"-"}:i==="speaking"&&(S={feedback:d.feedback||"-",score:d.score?.toString()||"-"}),{...q,...S}}),Z=_.length,A=9026,I=[.5,1.8,...Array(Z-2).fill(1)],J=I.reduce((r,g)=>r+g,0),Y=Math.floor(A/J),R=I.map(r=>Math.floor(Y*r)),ee=R.reduce((r,g)=>r+g,0),L=A-ee;L>0&&(R[1]+=L);const $=r=>R[r],te=new G({children:_.map((r,g)=>new O({children:[new p({children:[new v({text:r,bold:!0})],alignment:Q.CENTER})],shading:{fill:"D3D3D3"},width:{size:$(g),type:D.DXA}}))}),se=P.map(r=>{const g=[r.no,r.name,r.created_at];return i==="reading"||i==="listening"?g.push(r.total_questions,r.correct_answers,r.incorrect_answers,r.score_percentage):i==="writing"?g.push(r.writing_task1_score,r.writing_task2_score,r.total_score):i==="speaking"&&g.push(r.feedback,r.score),new G({children:g.map((d,q)=>new O({children:[new p({children:[new v({text:String(d)})],alignment:Q.LEFT})],width:{size:$(q),type:D.DXA}}))})}),ae=new ke({rows:[te,...se],width:{size:A,type:D.DXA},columnWidths:_.map((r,g)=>$(g))}),x=[];l&&(x.push(new p({children:[new v({text:`Test Title: ${l.title}`,size:20})]})),x.push(new p({children:[new v({text:`Test Type: ${l.test_type}`,size:20})]}))),x.push(new p({children:[new v({text:`Group: ${T}`,size:24,bold:!0})]})),x.push(new p({text:""})),x.push(ae);const W=new Date().toLocaleString("en-US",{timeZone:"Asia/Tashkent"});x.push(new p({text:""})),x.push(new p({children:[new v({text:`Generated on: ${W}`,size:20})]}));const re=new Te({sections:[{properties:{page:{size:{orientation:Se.PORTRAIT,width:11906,height:16838},margin:{top:1440,right:1440,bottom:1440,left:1440}}},children:x}]}),ie=await Ce.toBlob(re),B=window.URL.createObjectURL(ie),b=document.createElement("a");b.href=B;const ne=W.replace(/[/:]/g,"-").replace(/,/g,"");b.download=`${T} - Thematic ${i} Results - ${ne}.docx`,document.body.appendChild(b),b.click(),document.body.removeChild(b),window.URL.revokeObjectURL(B)}catch(w){console.error("Error generating Word document:",w)}finally{f(!1)}};return e.jsxs(E,{onClick:k,disabled:h,children:[h?e.jsx(me,{className:"w-5 h-5 animate-spin"}):e.jsx(ge,{className:"w-5 h-5"})," ","Download"]})},Pe=({type:l,material:i})=>{const{material_id:u,group_id:m}=H(),[h,f]=N.useState(1),[t,a]=N.useState(""),n=ye(t),o=N.useMemo(()=>({material_id:u,group_id:m}),[u,m]),k=be(o),{data:w,isLoading:y,isError:T}=F({queryKey:["thematic-reading-results",h,n,k],queryFn:()=>we(l,h,n,"",k)}),K=Fe(l),j=s.get(w,"results",[]),_={totalCount:s.get(w,"count",0),totalPages:s.get(w,"total_pages",1),currentPage:h};return N.useEffect(()=>{f(1)},[n]),T?e.jsx(X,{title:"Failed to Load page",message:"An error occurred while loading the page. Please try again later."}):e.jsx("div",{className:"space-y-8",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"text-xl font-semibold",children:"Results"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(Ne,{placeholder:"Search ...",value:t,onChange:P=>a(P.target.value),className:"max-w-sm w-64"}),e.jsx(Ke,{testData:i,group_id:m,material_id:u,type:l})]})]}),e.jsx("div",{className:"space-y-4",children:e.jsx(ve,{data:j,columns:K,pagination:!0,totalCount:_.totalCount,totalPages:_.totalPages,currentPage:_.currentPage,onPageChange:f,isLoading:y})})]})})},et=()=>{const{group_id:l,material_id:i,skill:u}=H(),{data:m,isLoading:h,isError:f}=F({queryKey:["groups",l],queryFn:()=>pe(l)}),{data:t,isLoading:a,isError:n}=F({queryKey:["test-material-thematic",i],queryFn:()=>je(u,i)});return h||a?e.jsx(oe,{}):f||n?e.jsx(X,{title:"Failed to Load page",message:"An error occurred while loading the page. Please try again later."}):e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"text-xl font-semibold",children:s.get(m,"name")}),e.jsx("div",{className:"flex gap-2",children:e.jsx(ce,{to:`/teacher/tests/thematic/statistics/${i}`,label:"Back to thematic groups"})})]}),e.jsxs(M,{className:"w-full",children:[e.jsx(z,{className:"flex flex-row items-center gap-4",children:e.jsx(V,{children:m?.name})}),e.jsxs(U,{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{className:"text-sm text-primary font-extrabold",children:"Number of students"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:m?.students_count})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{className:"text-sm text-primary font-extrabold",children:"Status:"}),m?.is_active===!0?e.jsx(c,{variant:"success",children:"Active"}):e.jsx(c,{variant:"destructive",children:"Inactive"})]})]})]}),e.jsxs(M,{className:"w-full",children:[e.jsx(z,{className:"flex flex-row items-center gap-4",children:e.jsxs(V,{className:"flex items-center gap-2 text-lg",children:[e.jsx("div",{children:s.get(t,"test_info.type")==="reading"?e.jsx(ue,{className:"h-6 w-6"}):s.get(t,"test_info.type")==="listening"?e.jsx(he,{className:"h-6 w-6"}):s.get(t,"test_info.type")==="writing"?e.jsx(fe,{className:"h-6 w-6"}):e.jsx(xe,{className:"h-6 w-6"})}),e.jsx("div",{children:s.get(t,"test_info.test_title")})]})}),e.jsxs(U,{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{className:"text-sm text-primary font-extrabold",children:"Section title:"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:s.get(t,"material_info.title")})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{className:"text-sm text-primary font-extrabold",children:"Material title:"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:s.get(t,"title")})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{className:"text-sm text-primary font-extrabold",children:"Test type:"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:e.jsx(c,{variant:"default",children:s.get(t,"test_type","N/A")})})]})]})]}),e.jsx(Pe,{type:s.get(t,"test_info.type"),material:t})]})};export{et as default};
