import{a as te,j as e,d as re,u as fe,t as K,r as d,R as D,e as ge}from"./index-Bt-pdlaH.js";import{u as je,F as ye,C as we}from"./useTestLogic-BsOh-iq1.js";import{B as W}from"./badge-BNLnY1eB.js";import{B as H}from"./button-RA2pRBKq.js";import{C as O,a as V,c as B,d as Q}from"./card-zr1CNwId.js";import{T as Se,a as Ne,b as X,c as R,d as ve,e as F}from"./table-Dxr7p8Mq.js";import{b as ne,e as Te,g as be,R as G,O as _e}from"./index-DGTRiiB-.js";import{l as o}from"./lodash-BhID_2fr.js";import{T as Ae}from"./tabs-QX8njZtU.js";import{u as Ee,T as Ce,a as q,P as Ie,C as Le,b as Pe}from"./usePreventPageLeave-CrC0kIED.js";import{o as Z,b as ke,s as $,n as ee,u as Re,a as Fe}from"./schemas-1FCy6UIf.js";import{u as qe,a as He,F as Me}from"./index.esm--iXEkVC3.js";import{u as $e,E as se}from"./ErrorMessage-BQakeyLQ.js";import{L as Oe}from"./LoadingSpinner-ZeBVhBUU.js";import"./index-BdrbzQWw.js";import"./utils-CPYLdFy8.js";import"./index-BmukFGyk.js";import"./index-B13PRFNR.js";import"./index-yJJQo6BU.js";import"./index-pHpo7QK4.js";import"./index-DdiNrlHi.js";import"./index-BKxkpbEq.js";import"./index-hNh4YyHk.js";import"./createLucideIcon-BgYwkBAP.js";import"./select-Dtrq0PMy.js";import"./index-CTbkl1w8.js";import"./index-CUhEEW-r.js";import"./index-JNisKIu1.js";import"./form-Bys5BACm.js";import"./circle-IWvm6FWE.js";import"./input-C6dbuEvi.js";import"./index-Bze7nPcH.js";function Ve({formData:r}){const{user:x}=te(),m=o.get(r,"finish"),u=o.get(r,"test_type"),a=o.get(r,"overall_score"),A=o.get(r,"percentage_correct_for_material",0),E=o.get(r,"answers",[]),j=o.get(r,"total_answers",0),i=o.get(r,"total_correct_answers",0),C=o.get(r,"total_incorrect_answers",0),_=()=>{m()};return e.jsx("div",{className:"p-4 w-full",children:e.jsxs(O,{className:"w-full shadow-lg",children:[e.jsxs(V,{className:"flex items-center space-x-2",children:[e.jsx(ne,{className:"w-12 h-12"}),e.jsx("h1",{className:"text-center text-lg font-extrabold tracking-tight text-balance",children:"IELTS Academic Listening - Results"})]}),e.jsxs(B,{className:"space-y-8",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Candidate:"}),e.jsx("div",{children:o.get(x,"full_name")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Total Questions:"}),e.jsx("div",{children:j})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Correct answers:"}),e.jsx("div",{className:"text-green-500",children:i})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Incorrect answers:"}),e.jsx("div",{className:"text-destructive",children:C})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Percentage correct for material:"}),e.jsxs("div",{children:[A,"%"]})]}),u==="mock"&&e.jsxs("div",{className:"flex items-center gap-2 mt-4",children:[e.jsx("strong",{children:"Overal:"}),e.jsx(W,{variant:"default",children:a})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h2",{className:"text-md font-semibold",children:"Answer Review"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(Se,{className:"h-[400px]",children:[e.jsx(Ne,{children:e.jsxs(X,{children:[e.jsx(R,{children:"Question"}),e.jsx(R,{children:"Your Answer"}),e.jsx(R,{children:"True Answer"}),e.jsx(R,{children:"Status"})]})}),e.jsx(ve,{children:E.map(g=>e.jsxs(X,{children:[e.jsx(F,{children:g.question_number}),e.jsx(F,{children:g.answer||e.jsx(W,{className:"bg-orange-500",children:"Not answered"})}),e.jsx(F,{children:g.true_answer}),e.jsx(F,{children:g.is_true?e.jsx(Te,{className:"text-green-500"}):e.jsx(be,{className:"text-destructive"})})]},g.id))})]})})]})]}),e.jsx(Q,{children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsxs("p",{className:"flex gap-2",children:[e.jsx(G,{})," Review and finalize your results."]}),e.jsx(H,{className:"w-64",onClick:()=>_(),children:"Finish"})]})})]})})}const Be=async r=>(await re.get(`/api/listening/by-material/${r}/`)).data,Qe=async(r,x)=>(await re.post(`/api/listening-answers/${r}/`,x)).data,Ge=Z({answers:ke(Z({listening_id:ee().optional()||$().optional(),question_number:ee().optional()||$().optional(),answer:$().nullable().optional()}).nullable()).optional()}),Ue=r=>$e({queryKey:["listenings",r],queryFn:()=>Be(r),enabled:!!r}),ae=(r=[])=>[...r].sort((x,m)=>{const u=(x.listening_section??0)-(m.listening_section??0);return u!==0?u:x.id-m.id}),Ye=(r,x)=>{const{user:m}=te(),u=fe(),a=Ue(r),A=m?.id||"guest",E=o.get(a.data,"is_view"),j=o.get(a.data,"material"),i=()=>{if(m?.role===D.TEACHER)u("/");else if(String(o.get(j,"test_type"))?.toLowerCase()=="mock"){const t=o.get(j,"next_test"),l=o.get(j,"next_test_id");u(t==="listening"&&l?`/listenings/${l}`:t==="reading"&&l?`/readings/${l}`:t==="speaking"&&l?`/speakings/${l}`:t==="writing"&&l?`/writings/${l}`:"/")}else u("/")},C=t=>{m?.role===D.TEACHER?x?.({...t,material:j,finish:i}):E===!0?x?.({...t,material:j}):i()},_=Re({mutationFn:t=>Qe(r,t),onSuccess:t=>{K.success("Successfully submitted!"),C(t)},onError:t=>{console.error("Error:",t),K.error(o.get(t,"response.data.error",""))}}),g=qe({resolver:Fe(Ge),defaultValues:{answers:[]}}),{fields:I,replace:L}=He({control:g.control,name:"answers"}),f=`listening_answers_${A}_${r}`;return d.useEffect(()=>{const t=a.data,l=Array.isArray(t?.listening_parts)?ae(t.listening_parts):[];if(l.length===0)return;const p=Math.max(...l.flatMap(h=>h?.question_numbers?.map(y=>y.question_number))),s=Array(p).fill(null);l.forEach(h=>{h?.question_numbers?.forEach(y=>{const N=y.question_number-1;s[N]={listening_id:h.id,question_number:y.question_number,answer:""}})});try{const h=localStorage.getItem(f);if(h){const y=JSON.parse(h);s.forEach((N,S)=>{y[S]&&y[S].answer&&(s[S].answer=y[S].answer)})}}catch(h){console.warn("Failed to load saved answers:",h)}L(s)},[a.data,L,f]),d.useEffect(()=>{const t=g.watch(l=>{if(l.answers&&l.answers.length>0)try{localStorage.setItem(f,JSON.stringify(l.answers))}catch(p){console.warn("Failed to save answers:",p)}});return()=>t.unsubscribe()},[g,f]),{form:g,listeningMutation:_,onSubmit:t=>{const l=(t.answers??[]).filter(p=>p!=null);_.mutate(l);try{localStorage.removeItem(f)}catch(p){console.warn("Failed to clear saved answers:",p)}},answersFields:I,query:a,finish:i}};function ze({onNext:r}){const[x,m]=d.useState(!1),u=d.useRef(null),a=()=>{x?u.current?.pause():u.current?.play(),m(!x)};return e.jsx("div",{className:"flex items-center justify-center min-h-screen py-4",children:e.jsxs(O,{className:"w-full max-w-xl shadow-lg",children:[e.jsxs(V,{className:"flex items-center space-x-2",children:[e.jsx(_e,{className:"w-12 h-12"}),e.jsx("h1",{className:"scroll-m-20 text-center text-lg font-extrabold tracking-tight text-balance",children:"Test sound"})]}),e.jsxs(B,{className:"space-y-6",children:[e.jsx("p",{className:"text-center",children:"Put on your headphones and click on the Play sound button to play a sample sound."}),e.jsx("div",{className:"flex justify-center",children:e.jsx(H,{variant:"outline",onClick:a,children:x?"Stop sound":"Play sound"})}),e.jsxs("p",{className:"flex gap-2",children:[e.jsx(G,{className:"text-destructive"})," If you cannot hear the sound clearly, please tell the invigilator."]}),e.jsx("audio",{ref:u,src:"https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3"})]}),e.jsx(Q,{children:e.jsx(H,{className:"w-full",onClick:r,children:"Continue"})})]})})}const Je=({onNext:r})=>{const{id:x}=ge(),{form:m,onSubmit:u,query:a,listeningMutation:A,finish:E}=Ye(x,r),j=o.get(a,"data.listening_parts",[]),i=d.useMemo(()=>ae(Array.isArray(j)?j:[]),[j]),C=o.get(a,"data.answer_time",null),[_,g]=d.useState(!1),[I,L]=d.useState(!0),[f,P]=d.useState(0),[t,l]=d.useState(!1),p=d.useRef([]),s=d.useRef(null),[h,y]=d.useState(()=>{const n=localStorage.getItem("audioVolume");return n?parseFloat(n):1}),[N,S]=d.useState(!1),[U,ie]=d.useState(!1),[v,M]=d.useState(!1);d.useEffect(()=>{a.data&&(o.get(a,"data.material.test_type","Mock")==="Thematic"?(S(!0),M(!1)):(S(!1),M(!0)))},[a.data]);const{timeLeft:oe,formatTime:le,activeTab:k,setActiveTab:Y,currentTabIndex:ce,handlePrevious:de,handleNext:ue,isTestFinished:z}=je(C,i,m.handleSubmit(u),_,E);Ee(!z),d.useEffect(()=>{if(a.isSuccess&&i.length>0&&!t){let n=0;const c=[];i.forEach((T,b)=>{const w=new Audio;w.src=T.audio,w.preload="auto",w.volume=h,c[b]=w,w.oncanplaythrough=()=>{n++,n===i.length&&(l(!0),p.current=c)},w.onerror=pe=>{console.error(`Audio yuklashda xato (part ${T.id}):`,pe),n++,n===i.length&&(l(!0),p.current=c)}})}},[a.isSuccess,i,t,h]);const me=()=>{L(!1),p.current.length>0&&(s.current=p.current[0],o.get(a,"data.material.test_type","Mock")==="Mock"&&s.current.play().catch(c=>{console.error("Birinchi audio ijro etishda xato:",c)}))};d.useEffect(()=>{localStorage.setItem("audioVolume",h.toString()),p.current.forEach(n=>{n.volume=h})},[h]),d.useEffect(()=>{a.data&&t&&o.get(a,"data.material.test_type","Mock")==="Thematic"&&s.current&&(s.current.pause(),s.current.currentTime=0)},[a.data,t]),d.useEffect(()=>{if(I||!t||i.length===0)return;const n=o.get(a,"data.material.test_type","Mock");if(n==="Thematic"&&!v)return;const c=s.current,T=()=>{f<i.length-1?(c&&(c.pause(),c.currentTime=0),P(b=>b+1)):(g(!0),c&&(c.pause(),c.currentTime=0))};if(f<i.length){const b=p.current[f];b&&b!==c?(c&&(c.pause(),c.currentTime=0,c.removeEventListener("ended",T)),s.current=b,s.current.volume=h,n==="Thematic"&&!v&&(s.current.pause(),s.current.currentTime=0),!N&&v&&s.current.play().catch(w=>{console.error(`Audio ijro etishda xato (part ${i[f].id}):`,w)}),s.current.addEventListener("ended",T)):c&&(c.paused&&!N&&v&&c.play().catch(w=>{console.error("Audio ijro etishda xato:",w)}),c.addEventListener("ended",T))}return()=>{s.current&&(s.current.pause(),s.current.removeEventListener("ended",T))}},[f,i,I,t,h,N,v]),d.useEffect(()=>{"mediaSession"in navigator&&(navigator.mediaSession.setActionHandler("play",()=>{s.current&&s.current.paused&&v&&s.current.play()}),navigator.mediaSession.setActionHandler("pause",()=>{s.current&&!s.current.paused&&s.current.pause()}),navigator.mediaSession.setActionHandler("stop",()=>{s.current&&(s.current.pause(),s.current.currentTime=0)}),navigator.mediaSession.setActionHandler("nexttrack",()=>{f<i.length-1&&P(n=>n+1)}),navigator.mediaSession.setActionHandler("previoustrack",()=>{f>0&&P(n=>n-1)}))},[f,i.length,v]);const J=n=>{y(n)},he=()=>{if(s.current)if(N){s.current.play(),S(!1),M(!0);const{user:n}=useAuthStore.getState();n?.role===Role.STUDENT&&ie(!0)}else{const{user:n}=useAuthStore.getState();(n?.role===Role.TEACHER||!U)&&(s.current.pause(),S(!0))}},xe=i.find(n=>`tab-${n.id}`===k);return a.isLoading||!t?e.jsx(Oe,{message:"Loading test data and audio files..."}):a.isError?e.jsx(se,{title:"Failed to Load Test",message:"An error occurred while loading the test. Please try again later."}):a.data?.listening_parts.length===0?e.jsx(se,{title:"Failed to load test",message:"An error occurred while loading the test questions. Please try again later."}):e.jsx(e.Fragment,{children:I?e.jsx(ze,{onNext:me,onVolumeChange:J,initialVolume:h,audioElements:p.current}):e.jsx(Me,{...m,children:e.jsxs("form",{onSubmit:m.handleSubmit(u),className:"min-h-screen",children:[e.jsxs("div",{className:"sticky top-0 z-50 bg-primary-foreground space-y-1",children:[e.jsx(Ce,{timeLeft:oe,formatTime:le,testType:q.LISTENING,type:o.get(a,"data.material.test_type","Mock"),audioRef:s,handleVolumeChange:J,handlePauseToggle:he,isPaused:N,studentHasStarted:U,userHasStarted:v}),e.jsx(Ie,{activePart:xe,testType:q.LISTENING})]}),e.jsxs(Ae,{value:k,onValueChange:Y,children:[e.jsx(Le,{data:i,activeTab:k,testType:q.LISTENING,form:m,testId:x}),e.jsx(Pe,{data:i,testType:q.LISTENING,form:m,activeTab:k,setActiveTab:Y,currentTabIndex:ce,handlePrevious:de,handleNext:ue,onSubmit:m.handleSubmit(u),isTestFinished:z,isLoading:A.isPending})]})]})})})};function Ke({onNext:r}){return e.jsx("div",{className:"flex items-center justify-center min-h-screen py-4",children:e.jsxs(O,{className:"w-full max-w-3xl shadow-lg",children:[e.jsxs(V,{className:"flex items-center space-x-2",children:[e.jsx(ne,{className:"w-12 h-12"}),e.jsx("h1",{className:"scroll-m-20 text-center text-lg font-extrabold tracking-tight text-balance",children:"IELTS Academic Listening"})]}),e.jsxs(B,{className:"space-y-8",children:[e.jsx("div",{className:"space-y-3",children:e.jsxs("p",{children:[e.jsx("strong",{children:"Time:"})," Approximately 30 minutes"]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h2",{className:"text-md font-semibold",children:"INSTRUCTIONS TO CANDIDATES"}),e.jsxs("ul",{className:"list-disc pl-5 space-y-1",children:[e.jsx("li",{children:"Answer all the questions."}),e.jsx("li",{children:"You can change your answers at any time during the test."})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h2",{className:"text-md font-semibold",children:"INFORMATION FOR CANDIDATES"}),e.jsxs("ul",{className:"list-disc pl-5 space-y-1",children:[e.jsx("li",{children:"There are 40 questions in this test."}),e.jsx("li",{children:"Each question carries one mark."}),e.jsx("li",{children:"There are four parts to the test."}),e.jsx("li",{children:"You will hear each part once."}),e.jsx("li",{children:"For each part of the test there will be time for you to look through the questions and time for you to check your answers."})]})]}),e.jsxs("p",{className:"flex gap-2",children:[e.jsx(G,{})," Read instructions and start only when ready."]})]}),e.jsx(Q,{children:e.jsx(H,{className:"w-full",onClick:r,children:"Start test"})})]})})}const Es=()=>e.jsx(ye,{steps:[e.jsx(we,{}),e.jsx(Ke,{}),e.jsx(Je,{}),e.jsx(Ve,{disableOverflow:!0})]});export{Es as default};
