import{a as ae,j as e,d as ne,u as ye,t as W,r as d,R as X,e as we}from"./index-C9n7polI.js";import{u as Se,F as Te,C as ve}from"./useTestLogic-DM85ShQ3.js";import{B as Z}from"./badge-CETUtAy0.js";import{B as O}from"./button-DUMtW0hL.js";import{C as Q,a as G,c as U,d as Y}from"./card-BNOjpMXc.js";import{T as Ne,a as be,b as ee,c as H,d as _e,e as M}from"./table-CafL_8hk.js";import{b as ie,e as Ae,g as Ee,R as z,O as Ce}from"./index-BBH-RmWy.js";import{l as o}from"./lodash-BQbGx-gA.js";import{T as Ie}from"./tabs-BOVdB8bT.js";import{u as Le,T as ke,a as $,P as Pe,C as Re,b as Fe}from"./usePreventPageLeave-CVExtZNq.js";import{o as se,b as qe,s as B,n as te,u as He,a as Me}from"./schemas-BlOts8Bb.js";import{u as $e,a as Oe,F as Ve}from"./index.esm-CnDZ_wpV.js";import{u as Be,E as re}from"./ErrorMessage-BwaoKaaM.js";import{L as Qe}from"./LoadingSpinner-CwXBvz4P.js";import"./index-BdrbzQWw.js";import"./utils-CPYLdFy8.js";import"./index-H52uSeXi.js";import"./index-DpNRSTko.js";import"./index-C9tS9l4r.js";import"./index-x7Eh_Cm0.js";import"./index-Bmxh5Nqr.js";import"./index-D3hs_IWB.js";import"./index-CGzEKUVT.js";import"./createLucideIcon-BXHNmlwy.js";import"./select--PasFZ9k.js";import"./index-Cpqqu-g8.js";import"./index-B9-ji6YN.js";import"./index-BXbacmtM.js";import"./form-CDg5v4lv.js";import"./circle-DP0WCC1e.js";import"./input-DhgAi3x7.js";import"./index-rPqMwytk.js";function Ge({formData:t}){const{user:h}=ae(),m=o.get(t,"finish"),u=o.get(t,"test_type"),r=o.get(t,"overall_score"),A=o.get(t,"percentage_correct_for_material",0),E=o.get(t,"answers",[]),w=o.get(t,"total_answers",0),l=o.get(t,"total_correct_answers",0),v=o.get(t,"total_incorrect_answers",0),C=()=>{m()};return e.jsx("div",{className:"p-4 w-full",children:e.jsxs(Q,{className:"w-full shadow-lg",children:[e.jsxs(G,{className:"flex items-center space-x-2",children:[e.jsx(ie,{className:"w-12 h-12"}),e.jsx("h1",{className:"text-center text-lg font-extrabold tracking-tight text-balance",children:"IELTS Academic Listening - Results"})]}),e.jsxs(U,{className:"space-y-8",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Candidate:"}),e.jsx("div",{children:o.get(h,"full_name")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Total Questions:"}),e.jsx("div",{children:w})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Correct answers:"}),e.jsx("div",{className:"text-green-500",children:l})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Incorrect answers:"}),e.jsx("div",{className:"text-destructive",children:v})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Percentage correct for material:"}),e.jsxs("div",{children:[A,"%"]})]}),u==="mock"&&e.jsxs("div",{className:"flex items-center gap-2 mt-4",children:[e.jsx("strong",{children:"Overal:"}),e.jsx(Z,{variant:"default",children:r})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h2",{className:"text-md font-semibold",children:"Answer Review"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(Ne,{className:"h-[400px]",children:[e.jsx(be,{children:e.jsxs(ee,{children:[e.jsx(H,{children:"Question"}),e.jsx(H,{children:"Your Answer"}),e.jsx(H,{children:"True Answer"}),e.jsx(H,{children:"Status"})]})}),e.jsx(_e,{children:E.map(x=>e.jsxs(ee,{children:[e.jsx(M,{children:x.question_number}),e.jsx(M,{children:x.answer||e.jsx(Z,{className:"bg-orange-500",children:"Not answered"})}),e.jsx(M,{children:x.true_answer}),e.jsx(M,{children:x.is_true?e.jsx(Ae,{className:"text-green-500"}):e.jsx(Ee,{className:"text-destructive"})})]},x.id))})]})})]})]}),e.jsx(Y,{children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsxs("p",{className:"flex gap-2",children:[e.jsx(z,{})," Review and finalize your results."]}),e.jsx(O,{className:"w-64",onClick:()=>C(),children:"Finish"})]})})]})})}const Ue=async t=>(await ne.get(`/api/listening/by-material/${t}/`)).data,Ye=async(t,h)=>(await ne.post(`/api/listening-answers/${t}/`,h)).data,ze=se({answers:qe(se({listening_id:te().optional()||B().optional(),question_number:te().optional()||B().optional(),answer:B().nullable().optional()}).nullable()).optional()}),De=t=>Be({queryKey:["listenings",t],queryFn:()=>Ue(t),enabled:!!t}),oe=(t=[])=>[...t].sort((h,m)=>{const u=(h.listening_section??0)-(m.listening_section??0);return u!==0?u:h.id-m.id}),Je=(t,h)=>{const{user:m}=ae(),u=ye(),r=De(t),A=m?.id||"guest",E=o.get(r.data,"is_view"),w=o.get(r.data,"material"),l=()=>{if(m?.role===X.TEACHER)u("/");else if(String(o.get(w,"test_type"))?.toLowerCase()=="mock"){const i=o.get(w,"next_test"),a=o.get(w,"next_test_id");u(i==="listening"&&a?`/listenings/${a}`:i==="reading"&&a?`/readings/${a}`:i==="speaking"&&a?`/speakings/${a}`:i==="writing"&&a?`/writings/${a}`:"/")}else u("/")},v=i=>{m?.role===X.TEACHER?h?.({...i,material:w,finish:l}):E===!0?h?.({...i,material:w}):l()},C=He({mutationFn:i=>Ye(t,i),onSuccess:i=>{W.success("Successfully submitted!"),v(i)},onError:i=>{console.error("Error:",i),W.error(o.get(i,"response.data.error",""))}}),x=$e({resolver:Me(ze),defaultValues:{answers:[]}}),{fields:L,replace:k}=Oe({control:x.control,name:"answers"}),N=`listening_answers_${A}_${t}`;return d.useEffect(()=>{const i=r.data,a=Array.isArray(i?.listening_parts)?oe(i.listening_parts):[];if(a.length===0)return;const g=Math.max(...a.flatMap(y=>y?.question_numbers?.map(p=>p.question_number))),j=Array(g).fill(null);a.forEach(y=>{y?.question_numbers?.forEach(p=>{const s=p.question_number-1;j[s]={listening_id:y.id,question_number:p.question_number,answer:""}})});try{const y=localStorage.getItem(N);if(y){const p=JSON.parse(y);j.forEach((s,f)=>{p[f]&&p[f].answer&&(j[f].answer=p[f].answer)})}}catch(y){console.warn("Failed to load saved answers:",y)}k(j)},[r.data,k,N]),d.useEffect(()=>{const i=x.watch(a=>{if(a.answers&&a.answers.length>0)try{localStorage.setItem(N,JSON.stringify(a.answers))}catch(g){console.warn("Failed to save answers:",g)}});return()=>i.unsubscribe()},[x,N]),{form:x,listeningMutation:C,onSubmit:i=>{const a=(i.answers??[]).filter(g=>g!=null);C.mutate(a);try{localStorage.removeItem(N)}catch(g){console.warn("Failed to clear saved answers:",g)}},answersFields:L,query:r,finish:l}};function Ke({onNext:t}){const[h,m]=d.useState(!1),u=d.useRef(null),r=()=>{h?u.current?.pause():u.current?.play(),m(!h)};return e.jsx("div",{className:"flex items-center justify-center min-h-screen py-4",children:e.jsxs(Q,{className:"w-full max-w-xl shadow-lg",children:[e.jsxs(G,{className:"flex items-center space-x-2",children:[e.jsx(Ce,{className:"w-12 h-12"}),e.jsx("h1",{className:"scroll-m-20 text-center text-lg font-extrabold tracking-tight text-balance",children:"Test sound"})]}),e.jsxs(U,{className:"space-y-6",children:[e.jsx("p",{className:"text-center",children:"Put on your headphones and click on the Play sound button to play a sample sound."}),e.jsx("div",{className:"flex justify-center",children:e.jsx(O,{variant:"outline",onClick:r,children:h?"Stop sound":"Play sound"})}),e.jsxs("p",{className:"flex gap-2",children:[e.jsx(z,{className:"text-destructive"})," If you cannot hear the sound clearly, please tell the invigilator."]}),e.jsx("audio",{ref:u,src:"https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3"})]}),e.jsx(Y,{children:e.jsx(O,{className:"w-full",onClick:t,children:"Continue"})})]})})}const We=({onNext:t})=>{const{id:h}=we(),{form:m,onSubmit:u,query:r,listeningMutation:A,finish:E}=Je(h,t),w=o.get(r,"data.listening_parts",[]),l=d.useMemo(()=>oe(Array.isArray(w)?w:[]),[w]),v=o.get(r,"data.answer_time",null),x=(o.get(r,"data.material.test_type","Mock")||"Mock").toString().toLowerCase()==="mock",L=typeof v=="number"&&v>0,[k,N]=d.useState(!1),[P,i]=d.useState(!0),[a,g]=d.useState(0),[j,y]=d.useState(!1),p=d.useRef([]),s=d.useRef(null),[f,le]=d.useState(()=>{const n=localStorage.getItem("audioVolume");return n?parseFloat(n):1}),[I,R]=d.useState(!1),[D,ce]=d.useState(!1),[T,V]=d.useState(!1);d.useEffect(()=>{r.data&&(o.get(r,"data.material.test_type","Mock")==="Thematic"?(R(!0),V(!1)):(R(!1),V(!0)))},[r.data]);const{timeLeft:de,formatTime:ue,activeTab:F,setActiveTab:J,currentTabIndex:me,handlePrevious:he,handleNext:pe,isTestFinished:q}=Se(v,l,m.handleSubmit(u),k,E);Le(!q),d.useEffect(()=>{if(r.isSuccess&&l.length>0&&!j){let n=0;const c=[];l.forEach((b,_)=>{const S=new Audio;S.src=b.audio,S.preload="auto",S.volume=f,c[_]=S,S.oncanplaythrough=()=>{n++,n===l.length&&(y(!0),p.current=c)},S.onerror=je=>{console.error(`Audio yuklashda xato (part ${b.id}):`,je),n++,n===l.length&&(y(!0),p.current=c)}})}},[r.isSuccess,l,j,f]);const xe=()=>{i(!1),p.current.length>0&&(s.current=p.current[0],o.get(r,"data.material.test_type","Mock")==="Mock"&&s.current.play().catch(c=>{console.error("Birinchi audio ijro etishda xato:",c)}))};d.useEffect(()=>{localStorage.setItem("audioVolume",f.toString()),p.current.forEach(n=>{n.volume=f})},[f]),d.useEffect(()=>{r.data&&j&&o.get(r,"data.material.test_type","Mock")==="Thematic"&&s.current&&(s.current.pause(),s.current.currentTime=0)},[r.data,j]),d.useEffect(()=>{if(P||!j||l.length===0)return;const n=o.get(r,"data.material.test_type","Mock");if(n==="Thematic"&&!T)return;const c=s.current,b=()=>{a<l.length-1?(c&&(c.pause(),c.currentTime=0),g(_=>_+1)):(N(!0),c&&(c.pause(),c.currentTime=0))};if(a<l.length){const _=p.current[a];_&&_!==c?(c&&(c.pause(),c.currentTime=0,c.removeEventListener("ended",b)),s.current=_,s.current.volume=f,n==="Thematic"&&!T&&(s.current.pause(),s.current.currentTime=0),!I&&T&&s.current.play().catch(S=>{console.error(`Audio ijro etishda xato (part ${l[a].id}):`,S)}),s.current.addEventListener("ended",b)):c&&(c.paused&&!I&&T&&c.play().catch(S=>{console.error("Audio ijro etishda xato:",S)}),c.addEventListener("ended",b))}return()=>{s.current&&(s.current.pause(),s.current.removeEventListener("ended",b))}},[a,l,P,j,f,I,T]),d.useEffect(()=>{"mediaSession"in navigator&&(navigator.mediaSession.setActionHandler("play",()=>{s.current&&s.current.paused&&T&&s.current.play()}),navigator.mediaSession.setActionHandler("pause",()=>{s.current&&!s.current.paused&&s.current.pause()}),navigator.mediaSession.setActionHandler("stop",()=>{s.current&&(s.current.pause(),s.current.currentTime=0)}),navigator.mediaSession.setActionHandler("nexttrack",()=>{a<l.length-1&&g(n=>n+1)}),navigator.mediaSession.setActionHandler("previoustrack",()=>{a>0&&g(n=>n-1)}))},[a,l.length,T]);const K=n=>{le(n)},fe=()=>{if(s.current)if(I){s.current.play(),R(!1),V(!0);const{user:n}=useAuthStore.getState();n?.role===Role.STUDENT&&ce(!0)}else{const{user:n}=useAuthStore.getState();(n?.role===Role.TEACHER||!D)&&(s.current.pause(),R(!0))}},ge=l.find(n=>`tab-${n.id}`===F);return r.isLoading||!j?e.jsx(Qe,{message:"Loading test data and audio files..."}):r.isError?e.jsx(re,{title:"Failed to Load Test",message:"An error occurred while loading the test. Please try again later."}):r.data?.listening_parts.length===0?e.jsx(re,{title:"Failed to load test",message:"An error occurred while loading the test questions. Please try again later."}):e.jsx(e.Fragment,{children:P?e.jsx(Ke,{onNext:xe,onVolumeChange:K,initialVolume:f,audioElements:p.current}):e.jsx(Ve,{...m,children:e.jsxs("form",{onSubmit:m.handleSubmit(u),className:"min-h-screen",children:[e.jsxs("div",{className:"sticky top-0 z-50 bg-primary-foreground space-y-1",children:[e.jsx(ke,{timeLeft:de,formatTime:ue,testType:$.LISTENING,type:o.get(r,"data.material.test_type","Mock"),audioRef:s,handleVolumeChange:K,handlePauseToggle:fe,isPaused:I,studentHasStarted:D,userHasStarted:T}),e.jsx(Pe,{activePart:ge,testType:$.LISTENING})]}),e.jsxs(Ie,{value:F,onValueChange:J,children:[e.jsx(Re,{data:l,activeTab:F,testType:$.LISTENING,form:m,testId:h}),e.jsx(Fe,{data:l,testType:$.LISTENING,form:m,activeTab:F,setActiveTab:J,currentTabIndex:me,handlePrevious:he,handleNext:pe,onSubmit:m.handleSubmit(u),isTestFinished:q,isLoading:A.isPending,disableSubmit:x&&L&&!q,disableSubmitReason:x&&L&&!q?"Submission will be available after the answer time finishes.":void 0})]})]})})})};function Xe({onNext:t}){return e.jsx("div",{className:"flex items-center justify-center min-h-screen py-4",children:e.jsxs(Q,{className:"w-full max-w-3xl shadow-lg",children:[e.jsxs(G,{className:"flex items-center space-x-2",children:[e.jsx(ie,{className:"w-12 h-12"}),e.jsx("h1",{className:"scroll-m-20 text-center text-lg font-extrabold tracking-tight text-balance",children:"IELTS Academic Listening"})]}),e.jsxs(U,{className:"space-y-8",children:[e.jsx("div",{className:"space-y-3",children:e.jsxs("p",{children:[e.jsx("strong",{children:"Time:"})," Approximately 30 minutes"]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h2",{className:"text-md font-semibold",children:"INSTRUCTIONS TO CANDIDATES"}),e.jsxs("ul",{className:"list-disc pl-5 space-y-1",children:[e.jsx("li",{children:"Answer all the questions."}),e.jsx("li",{children:"You can change your answers at any time during the test."})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h2",{className:"text-md font-semibold",children:"INFORMATION FOR CANDIDATES"}),e.jsxs("ul",{className:"list-disc pl-5 space-y-1",children:[e.jsx("li",{children:"There are 40 questions in this test."}),e.jsx("li",{children:"Each question carries one mark."}),e.jsx("li",{children:"There are four parts to the test."}),e.jsx("li",{children:"You will hear each part once."}),e.jsx("li",{children:"For each part of the test there will be time for you to look through the questions and time for you to check your answers."})]})]}),e.jsxs("p",{className:"flex gap-2",children:[e.jsx(z,{})," Read instructions and start only when ready."]})]}),e.jsx(Y,{children:e.jsx(O,{className:"w-full",onClick:t,children:"Start test"})})]})})}const Ls=()=>e.jsx(Te,{steps:[e.jsx(ve,{}),e.jsx(Xe,{}),e.jsx(We,{}),e.jsx(Ge,{disableOverflow:!0})]});export{Ls as default};
