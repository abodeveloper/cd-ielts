import{a as M,j as e,d as H,u as V,t as C,r as F,R as I,e as Y}from"./index-B6eUZfGU.js";import{u as U,a as W,F as X,C as Z}from"./useTestLogic-Cyz-CkGR.js";import{B as q}from"./badge-Bz3IQDjK.js";import{B}from"./button-CSv0Gv0d.js";import{C as Q,a as G,c as D,d as z}from"./card-BQ7It8du.js";import{T as ee,a as se,b as P,c as _,d as te,e as v}from"./table-Dyrs00FE.js";import{c as J,e as ae,g as re,R as K}from"./index-D7GAVcfz.js";import{l as a}from"./lodash-LJkcx2n7.js";import{T as ne}from"./tabs-DlITFVGh.js";import{T as ie,a as T,P as le,C as oe,b as ce}from"./TestNavigation-CBKgVfTh.js";import{o as k,b as de,s as A,c as L,n as O,u as me,a as ue}from"./schemas-B5NBPSJv.js";import{u as xe,a as he,F as ge}from"./index.esm-whTdjBUC.js";import{u as pe,E as $}from"./ErrorMessage-wQVpPDYt.js";import{L as je}from"./LoadingSpinner-BwuNGIsQ.js";import"./index-CFCzzCQl.js";import"./index-BdrbzQWw.js";import"./utils-CPYLdFy8.js";import"./index-CE1QKPHE.js";import"./index-DBiroZTn.js";import"./index-D1KBliLR.js";import"./index-BqtDt963.js";import"./index-BM_DmqeQ.js";import"./index-C6VH4ObW.js";import"./index-DwOVKCMQ.js";import"./createLucideIcon-CczI2Ewr.js";import"./index-Ds69CUhZ.js";import"./index-CnhuVgPO.js";import"./index-CF_dvKsm.js";import"./form-BWh-OGk2.js";import"./dropdown-menu-CLB1rU2v.js";import"./chevron-right-Qj5Z2owm.js";import"./input--eYUhpDY.js";import"./select-ayFrA9y7.js";import"./index-jHgdDP8y.js";import"./slider-BosbDj7i.js";import"./index-DY1L9T8r.js";function fe({formData:t}){const{user:o}=M(),i=a.get(t,"finish"),l=a.get(t,"test_type"),n=a.get(t,"overall_score"),w=a.get(t,"percentage_correct_for_material",0),x=a.get(t,"answers",[]),m=a.get(t,"total_answers",0),N=a.get(t,"total_correct_answers",0),h=a.get(t,"total_incorrect_answers",0),g=()=>{i()};return e.jsx("div",{className:"p-4 w-full",children:e.jsxs(Q,{className:"w-full shadow-lg",children:[e.jsxs(G,{className:"flex items-center space-x-2",children:[e.jsx(J,{className:"w-12 h-12"}),e.jsx("h1",{className:"text-center text-lg font-extrabold tracking-tight text-balance",children:"IELTS Academic Reading - Results"})]}),e.jsxs(D,{className:"space-y-8",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Candidate:"}),e.jsx("div",{children:a.get(o,"full_name")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Total Questions:"}),e.jsx("div",{children:m})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Correct answers:"}),e.jsx("div",{className:"text-green-500",children:N})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Incorrect answers:"}),e.jsx("div",{className:"text-destructive",children:h})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Percentage correct for material:"}),e.jsxs("div",{children:[w,"%"]})]}),l==="mock"&&e.jsxs("div",{className:"flex items-center gap-2 mt-4",children:[e.jsx("strong",{children:"Overal:"}),e.jsx(q,{variant:"default",children:n})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h2",{className:"text-md font-semibold",children:"Answer Review"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(ee,{className:"h-[400px]",children:[e.jsx(se,{children:e.jsxs(P,{children:[e.jsx(_,{children:"Question"}),e.jsx(_,{children:"Your Answer"}),e.jsx(_,{children:"True Answer"}),e.jsx(_,{children:"Status"})]})}),e.jsx(te,{children:x.map(c=>e.jsxs(P,{children:[e.jsx(v,{children:c.question_number}),e.jsx(v,{children:c.answer||e.jsx(q,{className:"bg-orange-500",children:"Not answered"})}),e.jsx(v,{children:c.true_answer}),e.jsx(v,{children:c.is_true?e.jsx(ae,{className:"text-green-500"}):e.jsx(re,{className:"text-destructive"})})]},c.id))})]})})]})]}),e.jsx(z,{children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsxs("p",{className:"flex gap-2",children:[e.jsx(K,{})," Review and finalize your results."]}),e.jsx(B,{className:"w-64",onClick:()=>g(),children:"Finish"})]})})]})})}const we=async t=>(await H.get(`/api/reading/by-material/${t}/`)).data,Ne=async(t,o)=>(await H.post(`/api/reading-answers/${t}/`,o)).data,ye=k({answers:de(k({reading_id:L([O(),A()]).optional(),question_number:L([O(),A()]).optional(),answer:A().nullable().optional()}).nullable()).optional()}),be=t=>pe({queryKey:["readings",t],queryFn:()=>we(t),enabled:!!t}),_e=(t,o)=>{const{user:i}=M(),l=V(),n=be(t),w=i?.id||"guest",x=a.get(n.data,"is_view"),m=a.get(n.data,"material"),N=a.get(n.data,"test_type"),h=()=>{if(i?.role===I.TEACHER)l("/");else if(String(a.get(m,"test_type"))?.toLowerCase()=="mock"){const s=a.get(m,"next_test"),r=a.get(m,"next_test_id");l(s==="listening"&&r?`/listenings/${r}`:s==="reading"&&r?`/readings/${r}`:s==="speaking"&&r?`/speakings/${r}`:s==="writing"&&r?`/writings/${r}`:"/")}else l("/")},g=s=>{N==="Thematic"?o?.({...s,material:m,finish:h}):i?.role===I.TEACHER?o?.({...s,material:m,finish:h}):x===!0?o?.({...s,material:m}):h()},c=me({mutationFn:s=>Ne(t,s),onSuccess:s=>{C.success("Successfully submitted!"),g(s)},onError:s=>{console.error("Error:",s),C.error(a.get(s,"response.data.error",""))}}),f=xe({resolver:ue(ye),defaultValues:{answers:[]}}),{fields:S,replace:y}=he({control:f.control,name:"answers"}),p=`reading_answers_${w}_${t}`;return F.useEffect(()=>{const s=n.data;if(!Array.isArray(s?.reading_parts)||s.reading_parts.length===0)return;const r=Math.max(...s.reading_parts.flatMap(u=>u?.question_numbers?.map(j=>j.question_number))),d=Array(r)?.fill(null);s.reading_parts.forEach(u=>{u?.question_numbers?.forEach(j=>{const E=j.question_number-1;d[E]={reading_id:u.id,question_number:j.question_number,answer:""}})});try{const u=localStorage.getItem(p);if(u){const j=JSON.parse(u);d.forEach((E,b)=>{j[b]&&j[b].answer&&(d[b].answer=j[b].answer)})}}catch(u){console.warn("Failed to load saved answers:",u)}y(d)},[n.data,y,p]),F.useEffect(()=>{const s=f.watch(r=>{if(r.answers&&r.answers.length>0)try{localStorage.setItem(p,JSON.stringify(r.answers))}catch(d){console.warn("Failed to save answers:",d)}});return()=>s.unsubscribe()},[f,p]),{form:f,readingMutation:c,onSubmit:s=>{const r=(s.answers??[]).filter(d=>d!=null);c.mutate(r);try{localStorage.removeItem(p)}catch(d){console.warn("Failed to clear saved answers:",d)}},answersFields:S,query:n,finish:h}},ve=({onNext:t})=>{const{id:o}=Y(),{form:i,onSubmit:l,query:n,readingMutation:w}=_e(o,t),x=a.get(n,"data.reading_parts",[]),m=a.get(n,"data.answer_time",null),{timeLeft:N,formatTime:h,activeTab:g,setActiveTab:c,currentTabIndex:f,handlePrevious:S,handleNext:y,isTestFinished:p}=U(m,x,i.handleSubmit(l),!0);W(!p);const R=x.find(s=>`tab-${s.id}`===g);return n.isLoading?e.jsx(je,{message:"Loading test data..."}):n.isError?e.jsx($,{title:"Failed to Load Test",message:"An error occurred while loading the test. Please try again later."}):n.data?.reading_parts.length===0?e.jsx($,{title:"Failed to load test",message:"An error occurred while loading the test questions. Please try again later."}):e.jsx(ge,{...i,children:e.jsxs("form",{onSubmit:i.handleSubmit(l),className:"min-h-screen",children:[e.jsxs("div",{className:"sticky top-0 z-50 bg-primary-foreground space-y-1",children:[e.jsx(ie,{timeLeft:N,formatTime:h,testType:T.READING,type:a.get(n,"data.material.test_type","Mock")}),e.jsx(le,{activePart:R,testType:T.READING})]}),e.jsxs(ne,{value:g,onValueChange:c,children:[e.jsx(oe,{data:x,activeTab:g,testType:T.READING,form:i,testId:o}),e.jsx(ce,{data:x,form:i,testType:T.READING,activeTab:g,setActiveTab:c,currentTabIndex:f,handlePrevious:S,handleNext:y,onSubmit:i.handleSubmit(l),isTestFinished:p,isLoading:w.isPending})]})]})})};function Te({onNext:t}){return e.jsx("div",{className:"flex items-center justify-center min-h-screen py-4 w-full",children:e.jsxs(Q,{className:"w-full max-w-2xl shadow-lg",children:[e.jsxs(G,{className:"flex items-center space-x-2",children:[e.jsx(J,{className:"w-12 h-12"}),e.jsx("h1",{className:"scroll-m-20 text-center text-lg font-extrabold tracking-tight text-balance",children:"IELTS Academic Reading"})]}),e.jsxs(D,{className:"space-y-8",children:[e.jsx("div",{className:"space-y-3",children:e.jsxs("p",{children:[e.jsx("strong",{children:"Time:"})," 1 hour"]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h2",{className:"text-md font-semibold",children:"INSTRUCTIONS TO CANDIDATES"}),e.jsxs("ul",{className:"list-disc pl-5 space-y-1",children:[e.jsx("li",{children:"Answer all the questions."}),e.jsx("li",{children:"You can change your answers at any time during the test."})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h2",{className:"text-md font-semibold",children:"INFORMATION FOR CANDIDATES"}),e.jsxs("ul",{className:"list-disc pl-5 space-y-1",children:[e.jsx("li",{children:"There are 40 questions in this test."}),e.jsx("li",{children:"Each question carries one mark."}),e.jsx("li",{children:"The test clock will show you when there are 10 minutes and 5 minutes remaining."})]})]}),e.jsxs("p",{className:"flex gap-2",children:[e.jsx(K,{})," Read instructions and start only when ready."]})]}),e.jsx(z,{children:e.jsx(B,{className:"w-full",onClick:t,children:"Start test"})})]})})}const os=()=>e.jsx(X,{steps:[e.jsx(Z,{}),e.jsx(Te,{}),e.jsx(ve,{}),e.jsx(fe,{disableOverflow:!0})]});export{os as default};
