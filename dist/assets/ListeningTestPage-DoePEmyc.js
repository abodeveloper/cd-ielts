import{a as se,j as e,d as te,u as pe,t as J,r as d,R as K,e as xe}from"./index-CwxirhWB.js";import{u as fe,F as ge,C as je}from"./useTestLogic-CBEcl3E7.js";import{B as D}from"./badge-HNMHLiIo.js";import{B as F}from"./button-BLDaD6WZ.js";import{C as $,a as O,c as V,d as B}from"./card-Cu0LwOn4.js";import{T as ye,a as we,b as W,c as k,d as Se,e as R}from"./table-U3GL7qNp.js";import{b as re,e as Ne,g as ve,R as Q,O as Te}from"./index-BZYcU9zo.js";import{l}from"./lodash-CwxYmA9C.js";import{T as be}from"./tabs-OoYfrzwv.js";import{u as _e,T as Ae,a as P,P as Ee,C as Ce,b as Ie}from"./usePreventPageLeave-BsjJorJn.js";import{o as X,b as Le,s as M,n as Z,u as ke,a as Re}from"./schemas-B-ZJsds3.js";import{u as Pe,a as Fe,F as qe}from"./index.esm-CXQp8oKO.js";import{u as He,E as ee}from"./ErrorMessage-DqHAmZc9.js";import{L as Me}from"./LoadingSpinner-DSiRdXBg.js";import"./index-BdrbzQWw.js";import"./utils-CPYLdFy8.js";import"./index-DrUrsE95.js";import"./index-CRbAYwbf.js";import"./index-BRTLPeh9.js";import"./index-BLaBgYv4.js";import"./index-BQzLEYJo.js";import"./index-jomFHtgw.js";import"./index-DBORmBR9.js";import"./createLucideIcon-C4Z7YXAM.js";import"./select-UnpDhEjM.js";import"./index-DNhsxQRF.js";import"./index-DldyDhO1.js";import"./index-V3AwEoFl.js";import"./form-Y7dO-aOq.js";import"./circle-BnfojBR6.js";import"./input-CJ8aA-OI.js";import"./index-BkzstEBz.js";function $e({formData:r}){const{user:p}=se(),h=l.get(r,"finish"),m=l.get(r,"test_type"),a=l.get(r,"overall_score"),E=l.get(r,"percentage_correct_for_material",0),C=l.get(r,"answers",[]),i=l.get(r,"total_answers",0),T=l.get(r,"total_correct_answers",0),I=l.get(r,"total_incorrect_answers",0),A=()=>{h()};return e.jsx("div",{className:"p-4 w-full",children:e.jsxs($,{className:"w-full shadow-lg",children:[e.jsxs(O,{className:"flex items-center space-x-2",children:[e.jsx(re,{className:"w-12 h-12"}),e.jsx("h1",{className:"text-center text-lg font-extrabold tracking-tight text-balance",children:"IELTS Academic Listening - Results"})]}),e.jsxs(V,{className:"space-y-8",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Candidate:"}),e.jsx("div",{children:l.get(p,"full_name")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Total Questions:"}),e.jsx("div",{children:i})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Correct answers:"}),e.jsx("div",{className:"text-green-500",children:T})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Incorrect answers:"}),e.jsx("div",{className:"text-destructive",children:I})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Percentage correct for material:"}),e.jsxs("div",{children:[E,"%"]})]}),m==="mock"&&e.jsxs("div",{className:"flex items-center gap-2 mt-4",children:[e.jsx("strong",{children:"Overal:"}),e.jsx(D,{variant:"default",children:a})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h2",{className:"text-md font-semibold",children:"Answer Review"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(ye,{className:"h-[400px]",children:[e.jsx(we,{children:e.jsxs(W,{children:[e.jsx(k,{children:"Question"}),e.jsx(k,{children:"Your Answer"}),e.jsx(k,{children:"True Answer"}),e.jsx(k,{children:"Status"})]})}),e.jsx(Se,{children:C.map(x=>e.jsxs(W,{children:[e.jsx(R,{children:x.question_number}),e.jsx(R,{children:x.answer||e.jsx(D,{className:"bg-orange-500",children:"Not answered"})}),e.jsx(R,{children:x.true_answer}),e.jsx(R,{children:x.is_true?e.jsx(Ne,{className:"text-green-500"}):e.jsx(ve,{className:"text-destructive"})})]},x.id))})]})})]})]}),e.jsx(B,{children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsxs("p",{className:"flex gap-2",children:[e.jsx(Q,{})," Review and finalize your results."]}),e.jsx(F,{className:"w-64",onClick:()=>A(),children:"Finish"})]})})]})})}const Oe=async r=>(await te.get(`/api/listening/by-material/${r}/`)).data,Ve=async(r,p)=>(await te.post(`/api/listening-answers/${r}/`,p)).data,Be=X({answers:Le(X({listening_id:Z().optional()||M().optional(),question_number:Z().optional()||M().optional(),answer:M().nullable().optional()}).nullable()).optional()}),Qe=r=>He({queryKey:["listenings",r],queryFn:()=>Oe(r),enabled:!!r}),Ge=(r,p)=>{const{user:h}=se(),m=pe(),a=Qe(r),E=h?.id||"guest",C=l.get(a.data,"is_view"),i=l.get(a.data,"material"),T=()=>{if(h?.role===K.TEACHER)m("/");else if(String(l.get(i,"test_type"))?.toLowerCase()=="mock"){const n=l.get(i,"next_test"),o=l.get(i,"next_test_id");m(n==="listening"&&o?`/listenings/${o}`:n==="reading"&&o?`/readings/${o}`:n==="speaking"&&o?`/speakings/${o}`:n==="writing"&&o?`/writings/${o}`:"/")}else m("/")},I=n=>{h?.role===K.TEACHER?p?.({...n,material:i,finish:T}):C===!0?p?.({...n,material:i}):T()},A=ke({mutationFn:n=>Ve(r,n),onSuccess:n=>{J.success("Successfully submitted!"),I(n)},onError:n=>{console.error("Error:",n),J.error(l.get(n,"response.data.error",""))}}),x=Pe({resolver:Re(Be),defaultValues:{answers:[]}}),{fields:q,replace:f}=Fe({control:x.control,name:"answers"}),y=`listening_answers_${E}_${r}`;return d.useEffect(()=>{const n=a.data;if(!Array.isArray(n?.listening_parts)||n.listening_parts.length===0)return;const o=Math.max(...n.listening_parts.flatMap(u=>u?.question_numbers?.map(g=>g.question_number))),s=Array(o).fill(null);n.listening_parts.forEach(u=>{u?.question_numbers?.forEach(g=>{const N=g.question_number-1;s[N]={listening_id:u.id,question_number:g.question_number,answer:""}})});try{const u=localStorage.getItem(y);if(u){const g=JSON.parse(u);s.forEach((N,w)=>{g[w]&&g[w].answer&&(s[w].answer=g[w].answer)})}}catch(u){console.warn("Failed to load saved answers:",u)}f(s)},[a.data,f,y]),d.useEffect(()=>{const n=x.watch(o=>{if(o.answers&&o.answers.length>0)try{localStorage.setItem(y,JSON.stringify(o.answers))}catch(s){console.warn("Failed to save answers:",s)}});return()=>n.unsubscribe()},[x,y]),{form:x,listeningMutation:A,onSubmit:n=>{const o=(n.answers??[]).filter(s=>s!=null);A.mutate(o);try{localStorage.removeItem(y)}catch(s){console.warn("Failed to clear saved answers:",s)}},answersFields:q,query:a,finish:T}};function Ue({onNext:r}){const[p,h]=d.useState(!1),m=d.useRef(null),a=()=>{p?m.current?.pause():m.current?.play(),h(!p)};return e.jsx("div",{className:"flex items-center justify-center min-h-screen py-4",children:e.jsxs($,{className:"w-full max-w-xl shadow-lg",children:[e.jsxs(O,{className:"flex items-center space-x-2",children:[e.jsx(Te,{className:"w-12 h-12"}),e.jsx("h1",{className:"scroll-m-20 text-center text-lg font-extrabold tracking-tight text-balance",children:"Test sound"})]}),e.jsxs(V,{className:"space-y-6",children:[e.jsx("p",{className:"text-center",children:"Put on your headphones and click on the Play sound button to play a sample sound."}),e.jsx("div",{className:"flex justify-center",children:e.jsx(F,{variant:"outline",onClick:a,children:p?"Stop sound":"Play sound"})}),e.jsxs("p",{className:"flex gap-2",children:[e.jsx(Q,{className:"text-destructive"})," If you cannot hear the sound clearly, please tell the invigilator."]}),e.jsx("audio",{ref:m,src:"https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3"})]}),e.jsx(B,{children:e.jsx(F,{className:"w-full",onClick:r,children:"Continue"})})]})})}const Ye=({onNext:r})=>{const{id:p}=xe(),{form:h,onSubmit:m,query:a,listeningMutation:E,finish:C}=Ge(p,r),i=l.get(a,"data.listening_parts",[]),T=l.get(a,"data.answer_time",null),[I,A]=d.useState(!1),[x,q]=d.useState(!0),[f,y]=d.useState(0),[S,n]=d.useState(!1),o=d.useRef([]),s=d.useRef(null),[u,g]=d.useState(()=>{const t=localStorage.getItem("audioVolume");return t?parseFloat(t):1}),[N,w]=d.useState(!1),[G,ae]=d.useState(!1),[v,H]=d.useState(!1);d.useEffect(()=>{a.data&&(l.get(a,"data.material.test_type","Mock")==="Thematic"?(w(!0),H(!1)):(w(!1),H(!0)))},[a.data]);const{timeLeft:ne,formatTime:ie,activeTab:L,setActiveTab:U,currentTabIndex:oe,handlePrevious:le,handleNext:ce,isTestFinished:Y}=fe(T,i,h.handleSubmit(m),I,C);_e(!Y),d.useEffect(()=>{if(a.isSuccess&&i.length>0&&!S){let t=0;const c=[];i.forEach((b,_)=>{const j=new Audio;j.src=b.audio,j.preload="auto",j.volume=u,c[_]=j,j.oncanplaythrough=()=>{t++,t===i.length&&(n(!0),o.current=c)},j.onerror=he=>{console.error(`Audio yuklashda xato (part ${b.id}):`,he),t++,t===i.length&&(n(!0),o.current=c)}})}},[a.isSuccess,i,S,u]);const de=()=>{q(!1),o.current.length>0&&(s.current=o.current[0],l.get(a,"data.material.test_type","Mock")==="Mock"&&s.current.play().catch(c=>{console.error("Birinchi audio ijro etishda xato:",c)}))};d.useEffect(()=>{localStorage.setItem("audioVolume",u.toString()),o.current.forEach(t=>{t.volume=u})},[u]),d.useEffect(()=>{a.data&&S&&l.get(a,"data.material.test_type","Mock")==="Thematic"&&s.current&&(s.current.pause(),s.current.currentTime=0)},[a.data,S]),d.useEffect(()=>{if(x||!S||i.length===0)return;const t=l.get(a,"data.material.test_type","Mock");if(t==="Thematic"&&!v)return;const c=s.current,b=()=>{f<i.length-1?(c&&(c.pause(),c.currentTime=0),y(_=>_+1)):(A(!0),c&&(c.pause(),c.currentTime=0))};if(f<i.length){const _=o.current[f];_&&_!==c?(c&&(c.pause(),c.currentTime=0,c.removeEventListener("ended",b)),s.current=_,s.current.volume=u,t==="Thematic"&&!v&&(s.current.pause(),s.current.currentTime=0),!N&&v&&s.current.play().catch(j=>{console.error(`Audio ijro etishda xato (part ${i[f].id}):`,j)}),s.current.addEventListener("ended",b)):c&&(c.paused&&!N&&v&&c.play().catch(j=>{console.error("Audio ijro etishda xato:",j)}),c.addEventListener("ended",b))}return()=>{s.current&&(s.current.pause(),s.current.removeEventListener("ended",b))}},[f,i,x,S,u,N,v]),d.useEffect(()=>{"mediaSession"in navigator&&(navigator.mediaSession.setActionHandler("play",()=>{s.current&&s.current.paused&&v&&s.current.play()}),navigator.mediaSession.setActionHandler("pause",()=>{s.current&&!s.current.paused&&s.current.pause()}),navigator.mediaSession.setActionHandler("stop",()=>{s.current&&(s.current.pause(),s.current.currentTime=0)}),navigator.mediaSession.setActionHandler("nexttrack",()=>{f<i.length-1&&y(t=>t+1)}),navigator.mediaSession.setActionHandler("previoustrack",()=>{f>0&&y(t=>t-1)}))},[f,i.length,v]);const z=t=>{g(t)},ue=()=>{if(s.current)if(N){s.current.play(),w(!1),H(!0);const{user:t}=useAuthStore.getState();t?.role===Role.STUDENT&&ae(!0)}else{const{user:t}=useAuthStore.getState();(t?.role===Role.TEACHER||!G)&&(s.current.pause(),w(!0))}},me=i.find(t=>`tab-${t.id}`===L);return a.isLoading||!S?e.jsx(Me,{message:"Loading test data and audio files..."}):a.isError?e.jsx(ee,{title:"Failed to Load Test",message:"An error occurred while loading the test. Please try again later."}):a.data?.listening_parts.length===0?e.jsx(ee,{title:"Failed to load test",message:"An error occurred while loading the test questions. Please try again later."}):e.jsx(e.Fragment,{children:x?e.jsx(Ue,{onNext:de,onVolumeChange:z,initialVolume:u,audioElements:o.current}):e.jsx(qe,{...h,children:e.jsxs("form",{onSubmit:h.handleSubmit(m),className:"min-h-screen",children:[e.jsxs("div",{className:"sticky top-0 z-50 bg-primary-foreground space-y-1",children:[e.jsx(Ae,{timeLeft:ne,formatTime:ie,testType:P.LISTENING,type:l.get(a,"data.material.test_type","Mock"),audioRef:s,handleVolumeChange:z,handlePauseToggle:ue,isPaused:N,studentHasStarted:G,userHasStarted:v}),e.jsx(Ee,{activePart:me,testType:P.LISTENING})]}),e.jsxs(be,{value:L,onValueChange:U,children:[e.jsx(Ce,{data:i,activeTab:L,testType:P.LISTENING,form:h,testId:p}),e.jsx(Ie,{data:i,testType:P.LISTENING,form:h,activeTab:L,setActiveTab:U,currentTabIndex:oe,handlePrevious:le,handleNext:ce,onSubmit:h.handleSubmit(m),isTestFinished:Y,isLoading:E.isPending})]})]})})})};function ze({onNext:r}){return e.jsx("div",{className:"flex items-center justify-center min-h-screen py-4",children:e.jsxs($,{className:"w-full max-w-3xl shadow-lg",children:[e.jsxs(O,{className:"flex items-center space-x-2",children:[e.jsx(re,{className:"w-12 h-12"}),e.jsx("h1",{className:"scroll-m-20 text-center text-lg font-extrabold tracking-tight text-balance",children:"IELTS Academic Listening"})]}),e.jsxs(V,{className:"space-y-8",children:[e.jsx("div",{className:"space-y-3",children:e.jsxs("p",{children:[e.jsx("strong",{children:"Time:"})," Approximately 30 minutes"]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h2",{className:"text-md font-semibold",children:"INSTRUCTIONS TO CANDIDATES"}),e.jsxs("ul",{className:"list-disc pl-5 space-y-1",children:[e.jsx("li",{children:"Answer all the questions."}),e.jsx("li",{children:"You can change your answers at any time during the test."})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h2",{className:"text-md font-semibold",children:"INFORMATION FOR CANDIDATES"}),e.jsxs("ul",{className:"list-disc pl-5 space-y-1",children:[e.jsx("li",{children:"There are 40 questions in this test."}),e.jsx("li",{children:"Each question carries one mark."}),e.jsx("li",{children:"There are four parts to the test."}),e.jsx("li",{children:"You will hear each part once."}),e.jsx("li",{children:"For each part of the test there will be time for you to look through the questions and time for you to check your answers."})]})]}),e.jsxs("p",{className:"flex gap-2",children:[e.jsx(Q,{})," Read instructions and start only when ready."]})]}),e.jsx(B,{children:e.jsx(F,{className:"w-full",onClick:r,children:"Start test"})})]})})}const _s=()=>e.jsx(ge,{steps:[e.jsx(je,{}),e.jsx(ze,{}),e.jsx(Ye,{}),e.jsx($e,{disableOverflow:!0})]});export{_s as default};
