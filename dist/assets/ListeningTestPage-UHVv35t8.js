import{a as re,j as e,u as pe,t as W,r as c,R as X,e as fe}from"./index-4kS3dc92.js";import{u as je,a as ye,F as we,C as Se}from"./useTestLogic-mAzPVtB1.js";import{B as Z}from"./badge-kS4BdgrN.js";import{B as q}from"./button-DbvuEKFN.js";import{C as V,a as B,c as Q,d as G}from"./card-BhQ0nrJq.js";import{T as Ne,a as ve,b as ee,c as P,d as Te,e as R}from"./table-CNnoRbys.js";import{b as ne,e as be,g as Ae,R as U,O as _e}from"./index-BG-AEQrd.js";import{l}from"./lodash-Cfwg2KdB.js";import{T as Ee}from"./tabs-BX0jSQDB.js";import{T as Ce,a as F,P as Ie,C as ke,b as Le}from"./TestNavigation-8HPOJcCG.js";import{o as se,b as Pe,s as $,n as te,u as Re,a as Fe}from"./schemas-Cq6yk9i5.js";import{u as qe,a as He,F as Me}from"./index.esm-CW-DEv0J.js";import{g as Oe,p as $e}from"./listening-Dg02KGqq.js";import{u as Ve,E as ae}from"./ErrorMessage-BOcr_lnl.js";import{L as Be}from"./LoadingSpinner-BtnFZCDF.js";import"./index-Cif9kCc3.js";import"./index-BdrbzQWw.js";import"./utils-CPYLdFy8.js";import"./index-C5Edetr2.js";import"./index-7Jc_Rc96.js";import"./index-Bq1TzI-k.js";import"./index-C7PJrxHK.js";import"./index-Bq6uM4er.js";import"./index-CGLyUDTa.js";import"./index-aQQWtKiN.js";import"./createLucideIcon-DBG_za26.js";import"./index-DgA9cSMV.js";import"./index-jjaSeT8C.js";import"./index-DkbMH4tl.js";import"./form-bTVnrJ3r.js";import"./dropdown-menu-BN__AY_A.js";import"./chevron-right-LDCTISZ0.js";import"./input-Cg-vDzte.js";import"./select-C_NPWb6e.js";import"./index-DBe9nV3H.js";import"./slider-D7lS_Iji.js";import"./index-CTRBCi4p.js";function Qe({formData:n}){const{user:h}=re(),m=l.get(n,"finish"),d=l.get(n,"test_type"),t=l.get(n,"overall_score"),I=l.get(n,"percentage_correct_for_material",0),v=l.get(n,"answers",[]),i=l.get(n,"total_answers",0),T=l.get(n,"total_correct_answers",0),k=l.get(n,"total_incorrect_answers",0),C=()=>{m()};return e.jsx("div",{className:"p-4 w-full",children:e.jsxs(V,{className:"w-full shadow-lg",children:[e.jsxs(B,{className:"flex items-center space-x-2",children:[e.jsx(ne,{className:"w-12 h-12"}),e.jsx("h1",{className:"text-center text-lg font-extrabold tracking-tight text-balance",children:"IELTS Academic Listening - Results"})]}),e.jsxs(Q,{className:"space-y-8",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Candidate:"}),e.jsx("div",{children:l.get(h,"full_name")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Total Questions:"}),e.jsx("div",{children:i})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Correct answers:"}),e.jsx("div",{className:"text-green-500",children:T})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Incorrect answers:"}),e.jsx("div",{className:"text-destructive",children:k})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Percentage correct for material:"}),e.jsxs("div",{children:[I,"%"]})]}),d==="mock"&&e.jsxs("div",{className:"flex items-center gap-2 mt-4",children:[e.jsx("strong",{children:"Overal:"}),e.jsx(Z,{variant:"default",children:t})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h2",{className:"text-md font-semibold",children:"Answer Review"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(Ne,{className:"h-[400px]",children:[e.jsx(ve,{children:e.jsxs(ee,{children:[e.jsx(P,{children:"Question"}),e.jsx(P,{children:"Your Answer"}),e.jsx(P,{children:"True Answer"}),e.jsx(P,{children:"Status"})]})}),e.jsx(Te,{children:v.map(g=>e.jsxs(ee,{children:[e.jsx(R,{children:g.question_number}),e.jsx(R,{children:g.answer||e.jsx(Z,{className:"bg-orange-500",children:"Not answered"})}),e.jsx(R,{children:g.true_answer}),e.jsx(R,{children:g.is_true?e.jsx(be,{className:"text-green-500"}):e.jsx(Ae,{className:"text-destructive"})})]},g.id))})]})})]})]}),e.jsx(G,{children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsxs("p",{className:"flex gap-2",children:[e.jsx(U,{})," Review and finalize your results."]}),e.jsx(q,{className:"w-64",onClick:()=>C(),children:"Finish"})]})})]})})}const Ge=se({answers:Pe(se({listening_id:te().optional()||$().optional(),question_number:te().optional()||$().optional(),answer:$().nullable().optional()}).nullable()).optional()}),Ue=n=>Ve({queryKey:["listenings",n],queryFn:()=>Oe(n),enabled:!!n}),ie=(n=[])=>[...n].sort((h,m)=>{const d=(h.listening_section??0)-(m.listening_section??0);return d!==0?d:h.id-m.id}),Ye=(n,h)=>{const{user:m}=re(),d=pe(),t=Ue(n),I=m?.id||"guest",v=l.get(t.data,"is_view"),i=l.get(t.data,"material"),T=()=>{if(m?.role===X.TEACHER)d("/");else if(String(l.get(i,"test_type"))?.toLowerCase()=="mock"){const o=l.get(i,"next_test"),r=l.get(i,"next_test_id");d(o==="listening"&&r?`/listenings/${r}`:o==="reading"&&r?`/readings/${r}`:o==="speaking"&&r?`/speakings/${r}`:o==="writing"&&r?`/writings/${r}`:"/")}else d("/")},k=o=>{m?.role===X.TEACHER?h?.({...o,material:i,finish:T}):v===!0?h?.({...o,material:i}):T()},C=Re({mutationFn:o=>$e(n,o),onSuccess:o=>{W.success("Successfully submitted!"),k(o)},onError:o=>{console.error("Error:",o),W.error(l.get(o,"response.data.error",""))}}),g=qe({resolver:Fe(Ge),defaultValues:{answers:[]}}),{fields:H,replace:j}=He({control:g.control,name:"answers"}),w=`listening_answers_${I}_${n}`;return c.useEffect(()=>{const o=t.data,r=Array.isArray(o?.listening_parts)?ie(o.listening_parts):[];if(r.length===0)return;const s=Math.max(...r.flatMap(y=>y?.question_numbers?.map(x=>x.question_number))),p=Array(s).fill(null);r.forEach(y=>{y?.question_numbers?.forEach(x=>{const b=x.question_number-1;p[b]={listening_id:y.id,question_number:x.question_number,answer:""}})});try{const y=localStorage.getItem(w);if(y){const x=JSON.parse(y);p.forEach((b,A)=>{x[A]&&x[A].answer&&(p[A].answer=x[A].answer)})}}catch(y){console.warn("Failed to load saved answers:",y)}j(p)},[t.data,j,w]),c.useEffect(()=>{const o=g.watch(r=>{if(r.answers&&r.answers.length>0)try{localStorage.setItem(w,JSON.stringify(r.answers))}catch(s){console.warn("Failed to save answers:",s)}});return()=>o.unsubscribe()},[g,w]),{form:g,listeningMutation:C,onSubmit:o=>{const r=(o.answers??[]).filter(s=>s!=null);C.mutate(r);try{localStorage.removeItem(w)}catch(s){console.warn("Failed to clear saved answers:",s)}},answersFields:H,query:t,finish:T}};function ze({onNext:n}){const[h,m]=c.useState(!1),d=c.useRef(null),t=()=>{h?d.current?.pause():d.current?.play(),m(!h)};return e.jsx("div",{className:"flex items-center justify-center min-h-screen py-4",children:e.jsxs(V,{className:"w-full max-w-xl shadow-lg",children:[e.jsxs(B,{className:"flex items-center space-x-2",children:[e.jsx(_e,{className:"w-12 h-12"}),e.jsx("h1",{className:"scroll-m-20 text-center text-lg font-extrabold tracking-tight text-balance",children:"Test sound"})]}),e.jsxs(Q,{className:"space-y-6",children:[e.jsx("p",{className:"text-center",children:"Put on your headphones and click on the Play sound button to play a sample sound."}),e.jsx("div",{className:"flex justify-center",children:e.jsx(q,{variant:"default",onClick:t,className:"bg-black hover:bg-gray-800 border-black text-white",children:h?"Stop sound":"Play sound"})}),e.jsxs("p",{className:"flex gap-2",children:[e.jsx(U,{className:"text-destructive"})," If you cannot hear the sound clearly, please tell the invigilator."]}),e.jsx("audio",{ref:d,src:"https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3"})]}),e.jsx(G,{children:e.jsx(q,{className:"w-full",onClick:n,children:"Continue"})})]})})}const Je=({onNext:n})=>{const{id:h}=fe(),{form:m,onSubmit:d,query:t,listeningMutation:I}=Ye(h,n),v=l.get(t,"data.listening_parts",[]),i=c.useMemo(()=>ie(Array.isArray(v)?v:[]),[v]),T=l.get(t,"data.answer_time",null);(l.get(t,"data.material.test_type","Mock")||"Mock").toString().toLowerCase();const[k,C]=c.useState(!1),[g,H]=c.useState(!0),[j,w]=c.useState(0),[S,o]=c.useState(!1),r=c.useRef([]),s=c.useRef(null),[p,y]=c.useState(()=>{const a=localStorage.getItem("audioVolume");return a?parseFloat(a):1}),[x,b]=c.useState(!1),[A,oe]=c.useState(!1),[N,M]=c.useState(!1),[Y,O]=c.useState(!1);c.useEffect(()=>{t.data&&(l.get(t,"data.material.test_type","Mock")==="Thematic"?(b(!0),M(!1)):(b(!1),M(!0)))},[t.data]);const{timeLeft:z,formatTime:le,activeTab:L,setActiveTab:J,currentTabIndex:ce,handlePrevious:ue,handleNext:de,isTestFinished:K}=je(T,i,m.handleSubmit(d),k);ye({shouldBlock:!K,audioRef:s,timeLeft:z,isAudioPlaying:Y,customMessage:"Listening test tugamaguncha va audio yakunlanmaguncha sahifadan chiqish taqiqlangan!"}),c.useEffect(()=>{if(t.isSuccess&&i.length>0&&!S){let a=0;const u=[];i.forEach((_,E)=>{const f=new Audio;f.src=_.audio,f.preload="auto",f.volume=p,u[E]=f,f.oncanplaythrough=()=>{a++,a===i.length&&(o(!0),r.current=u)},f.onplay=()=>{O(!0)},f.onpause=()=>{O(!1)},f.onended=()=>{O(!1)},f.onerror=xe=>{console.error(`Audio yuklashda xato (part ${_.id}):`,xe),a++,a===i.length&&(o(!0),r.current=u)}})}},[t.isSuccess,i,S,p]);const me=()=>{H(!1),r.current.length>0&&(s.current=r.current[0],l.get(t,"data.material.test_type","Mock")==="Mock"&&s.current.play().catch(u=>{console.error("Birinchi audio ijro etishda xato:",u)}))};c.useEffect(()=>{localStorage.setItem("audioVolume",p.toString()),r.current.forEach(a=>{a.volume=p})},[p]),c.useEffect(()=>{t.data&&S&&l.get(t,"data.material.test_type","Mock")==="Thematic"&&s.current&&(s.current.pause(),s.current.currentTime=0)},[t.data,S]),c.useEffect(()=>{if(g||!S||i.length===0)return;const a=l.get(t,"data.material.test_type","Mock");if(a==="Thematic"&&!N)return;const u=s.current,_=()=>{j<i.length-1?(u&&(u.pause(),u.currentTime=0),w(E=>E+1)):(C(!0),u&&(u.pause(),u.currentTime=0))};if(j<i.length){const E=r.current[j];E&&E!==u?(u&&(u.pause(),u.currentTime=0,u.removeEventListener("ended",_)),s.current=E,s.current.volume=p,a==="Thematic"&&!N&&(s.current.pause(),s.current.currentTime=0),!x&&N&&s.current.play().catch(f=>{console.error(`Audio ijro etishda xato (part ${i[j].id}):`,f)}),s.current.addEventListener("ended",_)):u&&(u.paused&&!x&&N&&u.play().catch(f=>{console.error("Audio ijro etishda xato:",f)}),u.addEventListener("ended",_))}return()=>{s.current&&(s.current.pause(),s.current.removeEventListener("ended",_))}},[j,i,g,S,p,x,N]),c.useEffect(()=>{"mediaSession"in navigator&&(navigator.mediaSession.setActionHandler("play",()=>{s.current&&s.current.paused&&N&&s.current.play()}),navigator.mediaSession.setActionHandler("pause",()=>{s.current&&!s.current.paused&&s.current.pause()}),navigator.mediaSession.setActionHandler("stop",()=>{s.current&&(s.current.pause(),s.current.currentTime=0)}),navigator.mediaSession.setActionHandler("nexttrack",()=>{j<i.length-1&&w(a=>a+1)}),navigator.mediaSession.setActionHandler("previoustrack",()=>{j>0&&w(a=>a-1)}))},[j,i.length,N]);const D=a=>{y(a)},he=()=>{if(s.current)if(x){s.current.play(),b(!1),M(!0);const{user:a}=useAuthStore.getState();a?.role===Role.STUDENT&&oe(!0)}else{const{user:a}=useAuthStore.getState();(a?.role===Role.TEACHER||!A)&&(s.current.pause(),b(!0))}},ge=i.find(a=>`tab-${a.id}`===L);return t.isLoading||!S?e.jsx(Be,{message:"Loading test data and audio files..."}):t.isError?e.jsx(ae,{title:"Failed to Load Test",message:"An error occurred while loading the test. Please try again later."}):t.data?.listening_parts.length===0?e.jsx(ae,{title:"Failed to load test",message:"An error occurred while loading the test questions. Please try again later."}):e.jsx(e.Fragment,{children:g?e.jsx(ze,{onNext:me,onVolumeChange:D,initialVolume:p,audioElements:r.current}):e.jsx(Me,{...m,children:e.jsxs("form",{onSubmit:m.handleSubmit(d),className:"min-h-screen",children:[e.jsxs("div",{className:"sticky top-0 z-50 bg-primary-foreground space-y-1",children:[e.jsx(Ce,{timeLeft:z,formatTime:le,testType:F.LISTENING,type:l.get(t,"data.material.test_type","Mock"),audioRef:s,handleVolumeChange:D,handlePauseToggle:he,isPaused:x,studentHasStarted:A,userHasStarted:N,isAudioPlaying:Y}),e.jsx(Ie,{activePart:ge,testType:F.LISTENING})]}),e.jsxs(Ee,{value:L,onValueChange:J,children:[e.jsx(ke,{data:i,activeTab:L,testType:F.LISTENING,form:m,testId:h}),e.jsx(Le,{data:i,testType:F.LISTENING,form:m,activeTab:L,setActiveTab:J,currentTabIndex:ce,handlePrevious:ue,handleNext:de,onSubmit:m.handleSubmit(d),isTestFinished:K,isLoading:I.isPending})]})]})})})};function Ke({onNext:n}){return e.jsx("div",{className:"flex items-center justify-center min-h-screen py-4",children:e.jsxs(V,{className:"w-full max-w-3xl shadow-lg",children:[e.jsxs(B,{className:"flex items-center space-x-2",children:[e.jsx(ne,{className:"w-12 h-12"}),e.jsx("h1",{className:"scroll-m-20 text-center text-lg font-extrabold tracking-tight text-balance",children:"IELTS Academic Listening"})]}),e.jsxs(Q,{className:"space-y-8",children:[e.jsx("div",{className:"space-y-3",children:e.jsxs("p",{children:[e.jsx("strong",{children:"Time:"})," Approximately 30 minutes"]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h2",{className:"text-md font-semibold",children:"INSTRUCTIONS TO CANDIDATES"}),e.jsxs("ul",{className:"list-disc pl-5 space-y-1",children:[e.jsx("li",{children:"Answer all the questions."}),e.jsx("li",{children:"You can change your answers at any time during the test."})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h2",{className:"text-md font-semibold",children:"INFORMATION FOR CANDIDATES"}),e.jsxs("ul",{className:"list-disc pl-5 space-y-1",children:[e.jsx("li",{children:"There are 40 questions in this test."}),e.jsx("li",{children:"Each question carries one mark."}),e.jsx("li",{children:"There are four parts to the test."}),e.jsx("li",{children:"You will hear each part once."}),e.jsx("li",{children:"For each part of the test there will be time for you to look through the questions and time for you to check your answers."})]})]}),e.jsxs("p",{className:"flex gap-2",children:[e.jsx(U,{})," Read instructions and start only when ready."]})]}),e.jsx(G,{children:e.jsx(q,{className:"w-full",onClick:n,children:"Start test"})})]})})}const Ps=()=>e.jsx(we,{steps:[e.jsx(Se,{}),e.jsx(Ke,{}),e.jsx(Je,{}),e.jsx(Qe,{disableOverflow:!0})]});export{Ps as default};
