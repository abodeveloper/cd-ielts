import{j as e,d as H,a as $,u as J,t as U,R as X,r as i,e as Z}from"./index-BxWpwr9K.js";import{H as ee,u as se,F as te,C as ne}from"./useTestLogic-IcuwJ-1K.js";import{B as S}from"./button-CNuY1AEb.js";import{C as k,a as O,c as R,d as W}from"./card-Dk_bWVLs.js";import{h as Q,R as G,u as ae,x as M,y as re,L as ie,r as ce,j as oe}from"./index-B49kkQR6.js";import{T as le,d as de}from"./tabs-C6GgIFvb.js";import{o as ue,_ as me,u as he,a as pe}from"./schemas-B82KTCYB.js";import{l as N}from"./lodash-B6TVBKew.js";import{u as xe,F as fe}from"./index.esm-ChS6XLnu.js";import{u as ge,E as D}from"./ErrorMessage-D0ZiHF_2.js";import{c as je}from"./utils-CPYLdFy8.js";import{L as V}from"./LoadingSpinner-CWTzwFnx.js";import"./index-l1yS5F1P.js";import"./index-BdrbzQWw.js";import"./index-BDN4nLcq.js";import"./index-Wh0fB7su.js";import"./index-G9_EqjY3.js";import"./index-BG6d6_mM.js";import"./index-D1JhMIMx.js";import"./index-B0vI_HCU.js";import"./createLucideIcon-CICipjdr.js";function we({onNext:s}){return e.jsx("div",{className:"flex items-center justify-center min-h-screen py-4",children:e.jsxs(k,{className:"w-full max-w-3xl shadow-lg",children:[e.jsxs(O,{className:"flex items-center space-x-2",children:[e.jsx(Q,{className:"w-12 h-12"}),e.jsx("h1",{className:"scroll-m-20 text-center text-lg font-extrabold tracking-tight text-balance",children:"IELTS Academic Speaking"})]}),e.jsxs(R,{className:"space-y-8",children:[e.jsx("div",{className:"space-y-3",children:e.jsxs("p",{children:[e.jsx("strong",{children:"Time:"})," 11â€“14 minutes"]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h2",{className:"text-md font-semibold",children:"INSTRUCTIONS TO CANDIDATES"}),e.jsxs("ul",{className:"list-disc pl-5 space-y-1",children:[e.jsx("li",{children:"This test will be recorded through your microphone."}),e.jsx("li",{children:"Speak clearly and answer all the questions."}),e.jsx("li",{children:"You cannot pause or repeat the questions."})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h2",{className:"text-md font-semibold",children:"INFORMATION FOR CANDIDATES"}),e.jsxs("ul",{className:"list-disc pl-5 space-y-1",children:[e.jsx("li",{children:"The Speaking test has three parts."}),e.jsx("li",{children:"Part 1: Introduction and interview."}),e.jsx("li",{children:"Part 2: Long turn (1 minute to prepare, 1â€“2 minutes to speak)."}),e.jsx("li",{children:"Part 3: Two-way discussion."})]})]}),e.jsxs("p",{className:"flex gap-2",children:[e.jsx(G,{})," Check your microphone before starting."]})]}),e.jsx(W,{children:e.jsx(S,{className:"w-full",onClick:s,children:"Start Speaking Test"})})]})})}const be=async s=>(await H.get(`/api/speaking/by-material/${s}/`)).data,ye=async s=>(await H.post("/api/speaking-answers/",s,{headers:{"Content-Type":"multipart/form-data"}})).data,Ne=ue({record:me(File).refine(s=>s.type.startsWith("audio/"),{message:"Faqat audio fayllar qabul qilinadi"})}),B=s=>ge({queryKey:["speakings",s],queryFn:()=>be(s),enabled:!!s}),Se=s=>{const{user:u}=$(),c=J(),d=B(s),o=N.get(d.data,"material"),p=()=>{if(u?.role===X.TEACHER)c("/");else if(String(N.get(o,"test_type"))?.toLowerCase()=="mock"){const t=N.get(o,"next_test"),n=N.get(o,"next_test_id");c(t==="listening"&&n?`/listenings/${n}`:t==="speaking"&&n?`/speakings/${n}`:t==="writing"&&n?`/writings/${n}`:"/")}else c("/")},m=()=>{p()},x=he({mutationFn:t=>ye(t),onSuccess:()=>{U.success("Successfully submitted!"),m()},onError:t=>{console.error("Error:",t),U.error(N.get(t,"response.data.error",""))}});return{form:xe({resolver:pe(Ne),defaultValues:{record:void 0}}),speakingMutation:x,onSubmit:t=>{x.isPending||x.mutate(t)},query:B(s)}},ve=()=>{const[s,u]=i.useState(0),[c,d]=i.useState(0),o=i.useCallback(()=>{u(window.innerWidth),d(window.innerHeight)},[u,d]);return i.useEffect(()=>(window.addEventListener("resize",o),o(),()=>window.removeEventListener("resize",o)),[o]),[s,c]};function ke(s,u,c,d,o){s.getByteFrequencyData(d),c.fillStyle="#000";const p=u.height/2;var m=Math.ceil(u.width/o)*2.5;let x,a=0;for(var r=0;r<o;r++)x=d[r]/255*p,c.fillStyle="#21C55d",c.fillRect(a,p-x,m,x),a+=m+1}const Re=({analyzerData:s})=>{const u=i.useRef(null),{dataArray:c,analyzer:d,bufferLength:o}=s,p=(a,r,t)=>{const n=u.current;if(!n||!r)return;const j=n.getContext("2d"),w=()=>{!u.current||!r||(requestAnimationFrame(w),n.width=n.width,ke(r,n,j,a,t))};w()};i.useEffect(()=>{p(c,d,o)},[c,d,o]);const[m,x]=ve();return e.jsx("canvas",{ref:u,width:m,height:x,style:{maxWidth:"600px",maxHeight:"100px",marginTop:"16px",width:"100%"}})},Ce=({part:s,activeTab:u,isLastPart:c,onNextPart:d,onFinish:o,allAudioChunks:p})=>{const[m,x]=i.useState(0),[a,r]=i.useState("preparation"),[t,n]=i.useState(null),[j,w]=i.useState(!1),[C,T]=i.useState(!1),[A,F]=i.useState(null),h=i.useRef(null),y=i.useRef([]),b=i.useRef(null),q=i.useRef(null),L=s?.question_numbers||[],v=L[m],E=l=>{if(l===null)return"";if(l<60)return e.jsx("div",{className:"w-[50px]",children:`${l} s`});{const f=Math.floor(l/60),g=l%60;return e.jsx("div",{className:"w-[50px]",children:`${f}:${g.toString().padStart(2,"0")}`})}},K=l=>{const f=new(window.AudioContext||window.webkitAudioContext);q.current=f;const g=f.createAnalyser();g.fftSize=2048;const z=g.frequencyBinCount,Y=new Uint8Array(z);f.createMediaStreamSource(l).connect(g),F({analyzer:g,bufferLength:z,dataArray:Y})};i.useEffect(()=>{v&&a==="preparation"&&u===`tab-${s.id}`&&n(s.prep_time)},[m,u,a,v,s.prep_time]),i.useEffect(()=>{if(t===null||a==="paused"||a==="finish")return;if(t<=0){a==="preparation"?(r("answering"),n(s.answer_time),I()):a==="answering"&&_().then(()=>{r("paused"),n(0)});return}const l=setTimeout(()=>{n(f=>f!==null?f-1:null)},1e3);return()=>clearTimeout(l)},[t,a,s.answer_time]),i.useEffect(()=>{if(a==="paused"&&t===0&&!C){const l=setTimeout(()=>{console.log("Paused phase:",{currentIndex:m,questionsLength:L.length,isLastPart:c}),m<L.length-1?(x(f=>f+1),r("preparation"),n(null)):!c&&d?(d(),x(0),r("preparation"),n(null)):c&&o&&(console.log("onFinish called"),T(!0),r("finish"),o())},1e3);return()=>clearTimeout(l)}},[a,t,m,L.length,c,d,o,C]);const I=async()=>{try{const l=await navigator.mediaDevices.getUserMedia({audio:!0}),f=new MediaRecorder(l);h.current=f,y.current=[],K(l),f.ondataavailable=g=>{g.data.size>0&&y.current.push(g.data)},f.onstop=()=>{const g=new Blob(y.current,{type:"audio/webm"});g.size>0&&(p.current.push(g),console.log("Audio Blob added:",{partId:s.id,questionIndex:m,blobSize:g.size})),b.current&&(b.current(),b.current=null),l.getTracks().forEach(z=>z.stop()),h.current=null,q.current&&(q.current.close(),q.current=null),F(null)},f.start(),w(!0)}catch(l){console.error("Microphone permission denied:",l),r("paused"),n(0)}},_=()=>new Promise(l=>{h.current&&h.current.state==="recording"?(b.current=l,h.current.stop(),w(!1)):l()}),P=async l=>{l.preventDefault(),a==="preparation"?(r("answering"),n(s.answer_time),I()):a==="answering"&&j&&(await _(),r("paused"),n(0))};return v?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-[calc(100vh-225px)] flex flex-col items-center justify-center gap-6 p-[100px]",children:e.jsxs("div",{className:"flex flex-col gap-10",children:[e.jsxs("div",{className:"text-lg font-extrabold",children:[a==="preparation"&&e.jsxs("div",{className:"flex flex-col gap-4 items-center justify-center",children:[e.jsx(ae,{size:80,className:"text-orange-500"}),e.jsxs("div",{className:"text-orange-500 flex items-center gap-2 justify-center",children:[e.jsx("div",{children:"Preparation:"})," ",E(t)]})]}),a==="answering"&&e.jsxs("div",{className:"flex flex-col gap-4 items-center justify-center",children:[e.jsx(M,{size:80,className:"text-green-500"}),e.jsxs("div",{className:"text-green-500 flex items-center gap-2 justify-center",children:[e.jsx("div",{children:"Speaking:"})," ",E(t)]}),j&&A&&e.jsx(Re,{analyzerData:A})]}),a==="paused"&&e.jsx(V,{}),a==="finish"&&e.jsxs("div",{className:"flex flex-col gap-4 items-center justify-center",children:[e.jsx(re,{size:80,className:"text-green-500"}),e.jsx("div",{className:"text-green-500",children:"Test Completed"})]})]}),a!=="finish"&&e.jsxs("div",{className:"text-2xl font-bold text-center",children:[v.question_number,"."," ",e.jsx(ee,{htmlString:v.question})]})]})}),e.jsx(k,{className:"w-full shadow-md p-2 px-5 sticky bottom-0 z-50 rounded-none",children:e.jsx(R,{className:"p-0 flex items-center justify-end gap-2 h-[80px]",children:(a==="preparation"||a==="answering")&&e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[a==="preparation"&&e.jsxs(S,{variant:"success",onClick:P,className:"flex items-center gap-2",children:[e.jsx(M,{size:20}),"Start Answering"]}),a==="answering"&&j&&e.jsxs(S,{variant:"destructive",onClick:P,className:"flex items-center gap-2",children:[e.jsx(ie,{size:20}),"Stop and Continue",e.jsx(ce,{size:20})]})]})})})]}):e.jsx("div",{className:"text-center text-lg",children:"No question available"})},Te=()=>{const{id:s}=Z(),{user:u}=$(),{form:c,onSubmit:d,query:o}=Se(s),[p,m]=i.useState(null),[x,a]=i.useState(!1),r=i.useRef([]),t=N.get(o,"data.speaking_parts",[]),{activeTab:n,setActiveTab:j,currentTabIndex:w}=se(null,t,c.handleSubmit(d)),C=w===t.length-1,T=t.find(h=>`tab-${h.id}`===n);i.useEffect(()=>{if(p&&URL.revokeObjectURL(p),r.current.length>0){const h=new Blob(r.current,{type:"audio/webm"}),y=URL.createObjectURL(h);m(y)}else m(null);return()=>{p&&URL.revokeObjectURL(p)}},[r.current.length]);const A=()=>{w<t.length-1&&j(`tab-${t[w+1].id}`)},F=()=>{if(x){console.log("Submit allaqachon bajarilgan, qayta urinish rad etildi");return}a(!0);const h=new FormData;if(r.current.length>0){const y=new Blob(r.current,{type:"audio/webm"}),b=new File([y],"speaking-test-combined.webm",{type:"audio/webm"});h.append("record",b),h.append("speaking",s||""),console.log("FormData ga qoâ€˜shildi:",{fileName:b.name,fileSize:b.size,fileType:b.type,speakingId:s})}else console.warn("Hech qanday audio yozilmadi"),h.append("speaking",s||"");d(h)};return o.isLoading?e.jsx(V,{message:"Loading test data..."}):o.isError?e.jsx(D,{title:"Failed to Load Test",message:"An error occurred while loading the test. Please try again later."}):o.data?.speaking_parts.length===0?e.jsx(D,{title:"Failed to load test",message:"An error occurred while loading the test questions. Please try again later."}):e.jsx(fe,{...c,children:e.jsxs("form",{className:"min-h-screen",children:[e.jsxs("div",{className:"sticky top-0 z-50 bg-primary-foreground space-y-1",children:[e.jsx(k,{className:"w-full shadow-md rounded-none",children:e.jsxs(R,{className:"p-3 flex justify-between items-center h-[50px]",children:[e.jsxs("div",{className:"text-sm flex items-center gap-2",children:[e.jsx(oe,{}),e.jsx("b",{children:"Candidate:"})," ",u?.username||"Guest"]}),e.jsx("div",{className:"flex items-center gap-8"})]})}),e.jsx(k,{className:"w-full shadow-sm rounded-none",children:e.jsxs(R,{className:"p-3 text-sm h-[70px]",children:[e.jsxs("div",{className:"font-semibold",children:["Part ",T?.speaking_part]}),e.jsx("div",{children:T?.description})]})})]}),e.jsx(le,{value:n,onValueChange:j,children:e.jsx("div",{children:t.map(h=>e.jsx(de,{value:`tab-${h.id}`,className:je("h-full bg-muted",n!==`tab-${h.id}`&&"hidden"),children:e.jsx(Ce,{part:h,activeTab:n,isLastPart:C,onNextPart:A,onFinish:F,allAudioChunks:r})},h.id))})})]})})};function Ae({onNext:s}){const[u,c]=i.useState(!1),[d,o]=i.useState(null),p=i.useRef(null),m=i.useRef([]),x=async()=>{try{const r=await navigator.mediaDevices.getUserMedia({audio:!0}),t=new MediaRecorder(r);p.current=t,m.current=[],t.ondataavailable=n=>{n.data.size>0&&m.current.push(n.data)},t.onstop=()=>{const n=new Blob(m.current,{type:"audio/webm"}),j=URL.createObjectURL(n);o(j)},t.start(),c(!0)}catch(r){console.error("Microphone access denied:",r),alert("Please allow microphone access to continue.")}},a=()=>{p.current?.stop(),c(!1)};return e.jsx("div",{className:"flex items-center justify-center min-h-screen py-4",children:e.jsxs(k,{className:"w-full max-w-xl shadow-lg",children:[e.jsxs(O,{className:"flex items-center space-x-2",children:[e.jsx(Q,{className:"w-12 h-12"}),e.jsx("h1",{className:"scroll-m-20 text-center text-lg font-extrabold tracking-tight text-balance",children:"Test microphone"})]}),e.jsxs(R,{className:"space-y-6",children:[e.jsx("p",{className:"text-center",children:"Click on the button below and say a few words to check your microphone."}),e.jsx("div",{className:"flex justify-center gap-2",children:u?e.jsx(S,{variant:"destructive",onClick:a,children:"â¹ Stop recording"}):e.jsx(S,{variant:"outline",onClick:x,children:"ðŸŽ¤ Start recording"})}),d&&e.jsxs("div",{className:"flex flex-col items-center space-y-2",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Playback your recording:"}),e.jsx("audio",{controls:!0,src:d})]}),e.jsxs("p",{className:"flex gap-2",children:[e.jsx(G,{className:"text-destructive"}),"If your voice cannot be heard clearly, please tell the invigilator."]})]}),e.jsx(W,{children:e.jsx(S,{className:"w-full",onClick:s,disabled:!d,children:"Continue"})})]})})}const Xe=()=>e.jsx(te,{steps:[e.jsx(ne,{}),e.jsx(we,{}),e.jsx(Ae,{}),e.jsx(Te,{})]});export{Xe as default};
