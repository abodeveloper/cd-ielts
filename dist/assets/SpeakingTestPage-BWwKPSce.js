import{j as e,d as se,a as ne,u as he,t as X,R as fe,r as a,e as xe}from"./index-D47OC3gi.js";import{H as ge,u as je,a as we,F as ye,C as Se}from"./useTestLogic-DltcpRAa.js";import{B as C}from"./button-CIMYou_Y.js";import{C as L,a as re,c as E,d as ae}from"./card-Ce5_OClf.js";import{h as ie,R as ce,x as be,y as Z,A as ve,q as Ne,s as ke,L as Te,r as Re,j as Ce}from"./index-2Max2227.js";import{T as qe,d as Fe}from"./tabs-B1fvyOWM.js";import{o as Ae,_ as ze,u as Le,a as Ee}from"./schemas-C7T5lkrp.js";import{l as F}from"./lodash-D2H_-A1O.js";import{u as Me,F as Pe}from"./index.esm-cp6JUPbj.js";import{u as De,E as ee}from"./ErrorMessage-BOXZBuON.js";import{c as Ue}from"./utils-CPYLdFy8.js";import{L as oe}from"./LoadingSpinner-BDmv0Xtl.js";import"./index-C9OSF_H1.js";import"./index-Bu1BO-s4.js";import"./index-BdrbzQWw.js";import"./index-xwShXBaa.js";import"./index-CrnI_A4y.js";import"./index-CkuRAd1p.js";import"./index-ha4kwZoz.js";import"./index-vR0F2UW8.js";import"./index-C5NPKzky.js";import"./createLucideIcon-Lo4gAoW8.js";function _e({onNext:s}){return e.jsx("div",{className:"flex items-center justify-center min-h-screen py-4",children:e.jsxs(L,{className:"w-full max-w-3xl shadow-lg",children:[e.jsxs(re,{className:"flex items-center space-x-2",children:[e.jsx(ie,{className:"w-12 h-12"}),e.jsx("h1",{className:"scroll-m-20 text-center text-lg font-extrabold tracking-tight text-balance",children:"IELTS Academic Speaking"})]}),e.jsxs(E,{className:"space-y-8",children:[e.jsx("div",{className:"space-y-3",children:e.jsxs("p",{children:[e.jsx("strong",{children:"Time:"})," 11â€“14 minutes"]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h2",{className:"text-md font-semibold",children:"INSTRUCTIONS TO CANDIDATES"}),e.jsxs("ul",{className:"list-disc pl-5 space-y-1",children:[e.jsx("li",{children:"This test will be recorded through your microphone."}),e.jsx("li",{children:"Speak clearly and answer all the questions."}),e.jsx("li",{children:"You cannot pause or repeat the questions."})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h2",{className:"text-md font-semibold",children:"INFORMATION FOR CANDIDATES"}),e.jsxs("ul",{className:"list-disc pl-5 space-y-1",children:[e.jsx("li",{children:"The Speaking test has three parts."}),e.jsx("li",{children:"Part 1: Introduction and interview."}),e.jsx("li",{children:"Part 2: Long turn (1 minute to prepare, 1â€“2 minutes to speak)."}),e.jsx("li",{children:"Part 3: Two-way discussion."})]})]}),e.jsxs("p",{className:"flex gap-2",children:[e.jsx(ce,{})," Check your microphone before starting."]})]}),e.jsx(ae,{children:e.jsx(C,{className:"w-full",onClick:s,children:"Start Speaking Test"})})]})})}const Ie=async s=>(await se.get(`/api/speaking/by-material/${s}/`)).data,Be=async s=>(await se.post("/api/speaking-answers/",s,{headers:{"Content-Type":"multipart/form-data"}})).data,He=Ae({record:ze(File).refine(s=>s.type.startsWith("audio/"),{message:"Faqat audio fayllar qabul qilinadi"})}),te=s=>De({queryKey:["speakings",s],queryFn:()=>Ie(s),enabled:!!s}),$e=s=>{const{user:m}=ne(),u=he(),p=te(s),l=F.get(p.data,"material"),h=()=>{if(m?.role===fe.TEACHER)u("/");else if(String(F.get(l,"test_type"))?.toLowerCase()=="mock"){const n=F.get(l,"next_test"),r=F.get(l,"next_test_id");u(n==="listening"&&r?`/listenings/${r}`:n==="speaking"&&r?`/speakings/${r}`:n==="writing"&&r?`/writings/${r}`:"/")}else u("/")},f=()=>{h()},x=Le({mutationFn:n=>Be(n),onSuccess:()=>{X.success("Successfully submitted!"),f()},onError:n=>{console.error("Error:",n),X.error(F.get(n,"response.data.error",""))}});return{form:Me({resolver:Ee(He),defaultValues:{record:void 0}}),speakingMutation:x,onSubmit:n=>{x.isPending||x.mutate(n)},query:te(s)}},Oe=()=>{const[s,m]=a.useState(0),[u,p]=a.useState(0),l=a.useCallback(()=>{m(window.innerWidth),p(window.innerHeight)},[m,p]);return a.useEffect(()=>(window.addEventListener("resize",l),l(),()=>window.removeEventListener("resize",l)),[l]),[s,u]};function Ve(s,m,u,p,l){s.getByteFrequencyData(p),u.fillStyle="#000";const h=m.height/2;var f=Math.ceil(m.width/l)*2.5;let x,i=0;for(var c=0;c<l;c++)x=p[c]/255*h,u.fillStyle="#21C55d",u.fillRect(i,h-x,f,x),i+=f+1}const We=({analyzerData:s})=>{const m=a.useRef(null),{dataArray:u,analyzer:p,bufferLength:l}=s,h=(i,c,n)=>{const r=m.current;if(!r||!c)return;const b=r.getContext("2d");if(!b)return;const v=()=>{!m.current||!c||(requestAnimationFrame(v),r.width=r.width,Ve(c,r,b,i,n))};v()};a.useEffect(()=>{h(u,p,l)},[u,p,l]);const[f,x]=Oe();return e.jsx("canvas",{ref:m,width:f,height:x,style:{maxWidth:"600px",maxHeight:"100px",marginTop:"16px",width:"100%"}})},Qe=({part:s,activeTab:m,isLastPart:u,onNextPart:p,onFinish:l,allAudioChunks:h})=>{const[f,x]=a.useState(0),[i,c]=a.useState("preparation"),[n,r]=a.useState(null),[b,v]=a.useState(!1),[M,B]=a.useState(!1),[A,q]=a.useState(null),d=a.useRef(null),g=a.useRef(null),R=a.useRef(null),N=a.useRef(null),k=a.useRef(null),[P,y]=a.useState(!1),j=a.useRef(null),D=s?.question_numbers||[],S=D[f],O=o=>{if(o===null)return"";if(o<60)return e.jsx("div",{className:"w-[50px]",children:`${o} s`});{const t=Math.floor(o/60),$=o%60;return e.jsx("div",{className:"w-[50px]",children:`${t}:${$.toString().padStart(2,"0")}`})}},V=o=>{if(!o)return"";const t=document.createElement("div");return t.innerHTML=o,t.textContent||t.innerText||""},le=()=>{if(!S||!S.question)return;if(!("speechSynthesis"in window)){console.warn("Text-to-Speech is not supported in this browser.");return}const o=V(S.question).trim();if(!o)return;window.speechSynthesis.cancel();const t=new SpeechSynthesisUtterance(o);t.lang="en-US",t.rate=.95,t.pitch=1,t.onstart=()=>y(!0),t.onend=()=>{y(!1),j.current=null},t.onerror=()=>{y(!1),j.current=null},j.current=t,window.speechSynthesis.speak(t)},H=()=>{"speechSynthesis"in window&&(window.speechSynthesis.cancel(),y(!1),j.current=null)};a.useEffect(()=>{if(!S||!S.question){window.speechSynthesis&&window.speechSynthesis.cancel(),y(!1),j.current=null;return}if(!("speechSynthesis"in window))return;window.speechSynthesis.cancel(),y(!1);const o=V(S.question).trim();if(!o)return;const t=new SpeechSynthesisUtterance(o);return t.lang="en-US",t.rate=.95,t.pitch=1,t.onstart=()=>y(!0),t.onend=()=>{y(!1),j.current=null},t.onerror=()=>{y(!1),j.current=null},j.current=t,window.speechSynthesis.speak(t),()=>{window.speechSynthesis&&window.speechSynthesis.cancel(),y(!1),j.current=null}},[S?.question_number]),a.useEffect(()=>{S&&i==="preparation"&&m===`tab-${s.id}`&&r(s.prep_time)},[f,m,i,S,s.prep_time]),a.useEffect(()=>{if(n===null||i==="paused"||i==="finish")return;if(n<=0){i==="preparation"?(c("answering"),r(s.answer_time),W()):i==="answering"&&(Q(),c("paused"),r(0));return}const o=setTimeout(()=>{r(t=>t!==null?t-1:null)},1e3);return()=>clearTimeout(o)},[n,i,s.answer_time]),a.useEffect(()=>{if(i==="paused"&&n===0&&!M){const o=setTimeout(()=>{console.log("Paused phase:",{currentIndex:f,questionsLength:D.length,isLastPart:u}),f<D.length-1?(x(t=>t+1),c("preparation"),r(null)):!u&&p?(p(),x(0),c("preparation"),r(null)):u&&l&&(console.log("onFinish called"),B(!0),ue().finally(()=>{c("finish"),l()}))},1e3);return()=>clearTimeout(o)}},[i,n,f,D.length,u,p,l,M]);const W=async()=>{try{if(d.current&&d.current.state==="paused"){try{d.current.requestData()}catch(w){console.warn("Could not request data before resume:",w)}d.current.resume(),v(!0),k.current&&q(k.current),console.log("Recording resumed. Total chunks:",h.current.length);return}if(d.current?.state==="recording")return;const o=await navigator.mediaDevices.getUserMedia({audio:{channelCount:1,sampleRate:44100,sampleSize:16,echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});N.current=o;const t=new(window.AudioContext||window.webkitAudioContext);R.current=t;const $=t.createMediaStreamSource(o),U=t.createBiquadFilter();U.type="highpass",U.frequency.value=120;const _=t.createBiquadFilter();_.type="lowpass",_.frequency.value=8e3;const T=t.createDynamicsCompressor();T.threshold.setValueAtTime(-30,t.currentTime),T.knee.setValueAtTime(30,t.currentTime),T.ratio.setValueAtTime(12,t.currentTime),T.attack.setValueAtTime(.003,t.currentTime),T.release.setValueAtTime(.25,t.currentTime);const K=t.createMediaStreamDestination();$.connect(U),U.connect(_),_.connect(T),T.connect(K);const I=t.createAnalyser();I.fftSize=2048;const Y=I.frequencyBinCount,de=new Uint8Array(Y);T.connect(I),k.current={analyzer:I,bufferLength:Y,dataArray:de},q(k.current);const me=K.stream,J=["audio/mpeg","audio/webm;codecs=opus","audio/webm"].find(w=>MediaRecorder.isTypeSupported(w)),pe=J?{mimeType:J,audioBitsPerSecond:128e3}:{audioBitsPerSecond:128e3},z=new MediaRecorder(me,pe);d.current=z,z.ondataavailable=w=>{w.data&&w.data.size>0&&(console.log("Audio chunk received:",w.data.size,"bytes"),h.current.push(w.data))},z.onerror=w=>{console.error("MediaRecorder error:",w)},z.onstop=()=>{if(d.current&&d.current.state!=="inactive")try{d.current.requestData()}catch(w){console.warn("Could not request final data:",w)}v(!1),q(null),k.current=null,console.log("Recording stopped. Total chunks:",h.current.length),setTimeout(()=>{d.current=null,N.current&&(N.current.getTracks().forEach(w=>w.stop()),N.current=null),R.current&&(R.current.close(),R.current=null),g.current&&(g.current(),g.current=null)},100)},z.start(1e3),v(!0),console.log("Recording started with timeslice 1000ms")}catch(o){console.error("Microphone permission denied:",o),c("paused"),r(0)}},Q=()=>{d.current&&d.current.state==="recording"&&(d.current.requestData(),d.current.pause(),v(!1),q(null),console.log("Recording paused. Total chunks:",h.current.length))},ue=()=>new Promise(o=>{if(d.current&&d.current.state!=="inactive"){try{d.current.state==="recording"&&d.current.requestData()}catch(t){console.warn("Could not request final data before stop:",t)}g.current=()=>{console.log("Recording fully stopped. Final chunk count:",h.current.length),o()},d.current.stop()}else o()}),G=async o=>{o.preventDefault(),i==="preparation"?(H(),c("answering"),r(s.answer_time),await W()):i==="answering"&&b&&(H(),Q(),c("paused"),r(0))};return S?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-[calc(100vh-225px)] flex flex-col items-center justify-center gap-6 p-[100px]",children:e.jsxs("div",{className:"flex flex-col gap-10",children:[e.jsxs("div",{className:"text-lg font-extrabold",children:[i==="preparation"&&e.jsxs("div",{className:"flex flex-col gap-4 items-center justify-center",children:[e.jsx(be,{size:80,className:"text-orange-500"}),e.jsxs("div",{className:"text-orange-500 flex items-center gap-2 justify-center",children:[e.jsx("div",{children:"Preparation:"})," ",O(n)]})]}),i==="answering"&&e.jsxs("div",{className:"flex flex-col gap-4 items-center justify-center",children:[e.jsx(Z,{size:80,className:"text-green-500"}),e.jsxs("div",{className:"text-green-500 flex items-center gap-2 justify-center",children:[e.jsx("div",{children:"Speaking:"})," ",O(n)]}),b&&A&&e.jsx(We,{analyzerData:A})]}),i==="paused"&&e.jsx(oe,{}),i==="finish"&&e.jsxs("div",{className:"flex flex-col gap-4 items-center justify-center",children:[e.jsx(ve,{size:80,className:"text-green-500"}),e.jsx("div",{className:"text-green-500",children:"Test Completed"})]})]}),i!=="finish"&&e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsxs("div",{className:"text-2xl font-bold text-center",children:[S.question_number,"."," ",e.jsx(ge,{htmlString:S.question})]}),e.jsx("div",{className:"flex items-center gap-3",children:e.jsx(C,{type:"button",variant:"outline",size:"sm",onClick:P?H:le,className:"flex items-center gap-2",children:P?e.jsxs(e.Fragment,{children:[e.jsx(Ne,{size:18}),e.jsx("span",{children:"Stop Reading"})]}):e.jsxs(e.Fragment,{children:[e.jsx(ke,{size:18}),e.jsx("span",{children:"Read Question"})]})})})]})]})}),e.jsx(L,{className:"w-full shadow-md p-2 px-5 sticky bottom-0 z-50 rounded-none",children:e.jsx(E,{className:"p-0 flex items-center justify-end gap-2 h-[80px]",children:(i==="preparation"||i==="answering")&&e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[i==="preparation"&&e.jsxs(C,{variant:"success",onClick:G,className:"flex items-center gap-2",children:[e.jsx(Z,{size:20}),"Start Answering"]}),i==="answering"&&b&&e.jsxs(C,{variant:"destructive",onClick:G,className:"flex items-center gap-2",children:[e.jsx(Te,{size:20}),"Stop and Continue",e.jsx(Re,{size:20})]})]})})})]}):e.jsx("div",{className:"text-center text-lg",children:"No question available"})},Ge=()=>{const{id:s}=xe(),{user:m}=ne(),{form:u,onSubmit:p,query:l}=$e(s),[h,f]=a.useState(null),[x,i]=a.useState(!1),c=a.useRef([]),n=F.get(l,"data.speaking_parts",[]),{activeTab:r,setActiveTab:b,currentTabIndex:v}=je(null,n,()=>{},!1),M=l.isSuccess&&n.length>0;we(M&&!x);const B=v===n.length-1,A=n.find(g=>`tab-${g.id}`===r);a.useEffect(()=>{if(h&&URL.revokeObjectURL(h),c.current.length>0){const R=c.current[0].type||"audio/webm",N=new Blob(c.current,{type:R}),k=URL.createObjectURL(N);f(k)}else f(null);return()=>{h&&URL.revokeObjectURL(h)}},[c.current.length]);const q=()=>{v<n.length-1&&b(`tab-${n[v+1].id}`)},d=()=>{if(x){console.log("Submit allaqachon bajarilgan, qayta urinish rad etildi");return}i(!0);const g=new FormData;if(c.current.length>0){const N=c.current[0].type||"audio/webm",P=N.includes("mpeg")||N.includes("mp3")?"mp3":"webm",y=new Blob(c.current,{type:N}),j=new File([y],`speaking-test-combined.${P}`,{type:N});g.append("record",j),g.append("speaking",s||""),console.log("FormData ga qoâ€˜shildi:",{fileName:j.name,fileSize:j.size,fileType:j.type,speakingId:s})}else console.warn("Hech qanday audio yozilmadi"),g.append("speaking",s||"");p(g)};return l.isLoading?e.jsx(oe,{message:"Loading test data..."}):l.isError?e.jsx(ee,{title:"Failed to Load Test",message:"An error occurred while loading the test. Please try again later."}):l.data?.speaking_parts.length===0?e.jsx(ee,{title:"Failed to load test",message:"An error occurred while loading the test questions. Please try again later."}):e.jsx(Pe,{...u,children:e.jsxs("form",{className:"min-h-screen",children:[e.jsxs("div",{className:"sticky top-0 z-50 bg-primary-foreground space-y-1",children:[e.jsx(L,{className:"w-full shadow-md rounded-none",children:e.jsxs(E,{className:"p-3 flex justify-between items-center h-[50px]",children:[e.jsxs("div",{className:"text-sm flex items-center gap-2",children:[e.jsx(Ce,{}),e.jsx("b",{children:"Candidate:"})," ",m?.username||"Guest"]}),e.jsx("div",{className:"flex items-center gap-8"})]})}),e.jsx(L,{className:"w-full shadow-sm rounded-none",children:e.jsxs(E,{className:"p-3 text-sm h-[70px]",children:[e.jsxs("div",{className:"font-semibold",children:["Part ",A?.speaking_part]}),e.jsx("div",{children:A?.description})]})})]}),e.jsx(qe,{value:r,onValueChange:b,children:e.jsx("div",{children:n.map(g=>e.jsx(Fe,{value:`tab-${g.id}`,className:Ue("h-full bg-muted",r!==`tab-${g.id}`&&"hidden"),children:e.jsx(Qe,{part:g,activeTab:r,isLastPart:B,onNextPart:q,onFinish:d,allAudioChunks:c})},g.id))})})]})})};function Ke({onNext:s}){const[m,u]=a.useState(!1),[p,l]=a.useState(null),h=a.useRef(null),f=a.useRef([]),x=async()=>{try{const c=await navigator.mediaDevices.getUserMedia({audio:!0}),n=new MediaRecorder(c);h.current=n,f.current=[],n.ondataavailable=r=>{r.data.size>0&&f.current.push(r.data)},n.onstop=()=>{const r=new Blob(f.current,{type:"audio/webm"}),b=URL.createObjectURL(r);l(b)},n.start(),u(!0)}catch(c){console.error("Microphone access denied:",c),alert("Please allow microphone access to continue.")}},i=()=>{h.current?.stop(),u(!1)};return e.jsx("div",{className:"flex items-center justify-center min-h-screen py-4",children:e.jsxs(L,{className:"w-full max-w-xl shadow-lg",children:[e.jsxs(re,{className:"flex items-center space-x-2",children:[e.jsx(ie,{className:"w-12 h-12"}),e.jsx("h1",{className:"scroll-m-20 text-center text-lg font-extrabold tracking-tight text-balance",children:"Test microphone"})]}),e.jsxs(E,{className:"space-y-6",children:[e.jsx("p",{className:"text-center",children:"Click on the button below and say a few words to check your microphone."}),e.jsx("div",{className:"flex justify-center gap-2",children:m?e.jsx(C,{variant:"destructive",onClick:i,children:"â¹ Stop recording"}):e.jsx(C,{variant:"outline",onClick:x,children:"ðŸŽ¤ Start recording"})}),p&&e.jsxs("div",{className:"flex flex-col items-center space-y-2",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Playback your recording:"}),e.jsx("audio",{controls:!0,src:p})]}),e.jsxs("p",{className:"flex gap-2",children:[e.jsx(ce,{className:"text-destructive"}),"If your voice cannot be heard clearly, please tell the invigilator."]})]}),e.jsx(ae,{children:e.jsx(C,{className:"w-full",onClick:s,disabled:!p,children:"Continue"})})]})})}const wt=()=>e.jsx(ye,{steps:[e.jsx(Se,{}),e.jsx(_e,{}),e.jsx(Ke,{}),e.jsx(Ge,{})]});export{wt as default};
