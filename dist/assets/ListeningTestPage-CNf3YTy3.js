import{a as ne,j as e,u as fe,t as X,r as l,R as Z,e as je}from"./index-CwtWxuzi.js";import{u as ye,a as we,F as Se,C as Ne}from"./useTestLogic-DrwSSi1Q.js";import{B as ee}from"./badge-BT5C1trt.js";import{B as H}from"./button-D3kpZICD.js";import{C as V,a as B,c as Q,d as G}from"./card-D02_R5C_.js";import{T as ve,a as Te,b as se,c as R,d as be,e as F}from"./table-BcTrh5Ag.js";import{b as ie,e as Ae,g as _e,R as U,O as Ee}from"./index-Baci5kEp.js";import{l as i}from"./lodash-BvngGpUb.js";import{T as Ce}from"./tabs-DqS3U9j0.js";import{T as Ie,a as q,P as ke,C as Le,b as Pe}from"./TestNavigation-SrBgwTSX.js";import{o as te,b as Re,s as $,n as ae,u as Fe,a as qe}from"./schemas-Dp_BDo1h.js";import{u as He,a as Me,F as Oe}from"./index.esm-sVnwrcWs.js";import{g as $e,p as Ve}from"./listening-BRPa9TcO.js";import{u as Be,E as re}from"./ErrorMessage-BvvT8gXk.js";import{L as Qe}from"./LoadingSpinner-C6Xu0xqI.js";import"./index-CTaSObxt.js";import"./index-BdrbzQWw.js";import"./utils-CPYLdFy8.js";import"./index-6ASP5Y_r.js";import"./index-Dfn6srHJ.js";import"./index-BjTfhiqu.js";import"./index-BqxPuVWw.js";import"./index-BTEpwRt_.js";import"./index-CkFf3sOu.js";import"./index-BJ84DOP6.js";import"./createLucideIcon-C_MKdDV1.js";import"./index-DpND36gs.js";import"./index-Ctt8U4zB.js";import"./index-yUAH5ZsI.js";import"./form-CjwliyCv.js";import"./dropdown-menu-yhVQDvy_.js";import"./chevron-right-LhqbuYIe.js";import"./input-DgijvZTb.js";import"./select-DHX_5Vmg.js";import"./index-BMQCObg6.js";import"./slider-DJvOlbDo.js";import"./index-M0q7im0-.js";function Ge({formData:n}){const{user:x}=ne(),h=i.get(n,"finish"),d=i.get(n,"test_type"),a=i.get(n,"overall_score"),_=i.get(n,"percentage_correct_for_material",0),E=i.get(n,"answers",[]),y=i.get(n,"total_answers",0),o=i.get(n,"total_correct_answers",0),C=i.get(n,"total_incorrect_answers",0),A=()=>{h()};return e.jsx("div",{className:"p-4 w-full",children:e.jsxs(V,{className:"w-full shadow-lg",children:[e.jsxs(B,{className:"flex items-center space-x-2",children:[e.jsx(ie,{className:"w-12 h-12"}),e.jsx("h1",{className:"text-center text-lg font-extrabold tracking-tight text-balance",children:"IELTS Academic Listening - Results"})]}),e.jsxs(Q,{className:"space-y-8",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Candidate:"}),e.jsx("div",{children:i.get(x,"full_name")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Total Questions:"}),e.jsx("div",{children:y})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Correct answers:"}),e.jsx("div",{className:"text-green-500",children:o})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Incorrect answers:"}),e.jsx("div",{className:"text-destructive",children:C})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Percentage correct for material:"}),e.jsxs("div",{children:[_,"%"]})]}),d==="mock"&&e.jsxs("div",{className:"flex items-center gap-2 mt-4",children:[e.jsx("strong",{children:"Overal:"}),e.jsx(ee,{variant:"default",children:a})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h2",{className:"text-md font-semibold",children:"Answer Review"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(ve,{className:"h-[400px]",children:[e.jsx(Te,{children:e.jsxs(se,{children:[e.jsx(R,{children:"Question"}),e.jsx(R,{children:"Your Answer"}),e.jsx(R,{children:"True Answer"}),e.jsx(R,{children:"Status"})]})}),e.jsx(be,{children:E.map(j=>e.jsxs(se,{children:[e.jsx(F,{children:j.question_number}),e.jsx(F,{children:j.answer||e.jsx(ee,{className:"bg-orange-500",children:"Not answered"})}),e.jsx(F,{children:j.true_answer}),e.jsx(F,{children:j.is_true?e.jsx(Ae,{className:"text-green-500"}):e.jsx(_e,{className:"text-destructive"})})]},j.id))})]})})]})]}),e.jsx(G,{children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsxs("p",{className:"flex gap-2",children:[e.jsx(U,{})," Review and finalize your results."]}),e.jsx(H,{className:"w-64",onClick:()=>A(),children:"Finish"})]})})]})})}const Ue=te({answers:Re(te({listening_id:ae().optional()||$().optional(),question_number:ae().optional()||$().optional(),answer:$().nullable().optional()}).nullable()).optional()}),Ye=n=>Be({queryKey:["listenings",n],queryFn:()=>$e(n),enabled:!!n}),oe=(n=[])=>[...n].sort((x,h)=>{const d=(x.listening_section??0)-(h.listening_section??0);return d!==0?d:x.id-h.id}),ze=(n,x)=>{const{user:h}=ne(),d=fe(),a=Ye(n),_=h?.id||"guest",E=i.get(a.data,"is_view"),y=i.get(a.data,"material"),o=()=>{if(h?.role===Z.TEACHER)d("/");else if(String(i.get(y,"test_type"))?.toLowerCase()=="mock"){const t=i.get(y,"next_test"),c=i.get(y,"next_test_id");d(t==="listening"&&c?`/listenings/${c}`:t==="reading"&&c?`/readings/${c}`:t==="speaking"&&c?`/speakings/${c}`:t==="writing"&&c?`/writings/${c}`:"/")}else d("/")},C=t=>{h?.role===Z.TEACHER?x?.({...t,material:y,finish:o}):E===!0?x?.({...t,material:y}):o()},A=Fe({mutationFn:t=>Ve(n,t),onSuccess:t=>{X.success("Successfully submitted!"),C(t)},onError:t=>{console.error("Error:",t),X.error(i.get(t,"response.data.error",""))}}),j=He({resolver:qe(Ue),defaultValues:{answers:[]}}),{fields:I,replace:k}=Me({control:j.control,name:"answers"}),p=`listening_answers_${_}_${n}`;return l.useEffect(()=>{const t=a.data,c=Array.isArray(t?.listening_parts)?oe(t.listening_parts):[];if(c.length===0)return;const g=Math.max(...c.flatMap(m=>m?.question_numbers?.map(w=>w.question_number))),s=Array(g).fill(null);c.forEach(m=>{m?.question_numbers?.forEach(w=>{const N=w.question_number-1;s[N]={listening_id:m.id,question_number:w.question_number,answer:""}})});try{const m=localStorage.getItem(p);if(m){const w=JSON.parse(m);s.forEach((N,S)=>{w[S]&&w[S].answer&&(s[S].answer=w[S].answer)})}}catch(m){console.warn("Failed to load saved answers:",m)}k(s)},[a.data,k,p]),l.useEffect(()=>{const t=j.watch(c=>{if(c.answers&&c.answers.length>0)try{localStorage.setItem(p,JSON.stringify(c.answers))}catch(g){console.warn("Failed to save answers:",g)}});return()=>t.unsubscribe()},[j,p]),{form:j,listeningMutation:A,onSubmit:t=>{const c=(t.answers??[]).filter(g=>g!=null);A.mutate(c);try{localStorage.removeItem(p)}catch(g){console.warn("Failed to clear saved answers:",g)}},answersFields:I,query:a,finish:o}};function Je({onNext:n}){const[x,h]=l.useState(!1),d=l.useRef(null),a=()=>{x?d.current?.pause():d.current?.play(),h(!x)};return e.jsx("div",{className:"flex items-center justify-center min-h-screen py-4",children:e.jsxs(V,{className:"w-full max-w-xl shadow-lg",children:[e.jsxs(B,{className:"flex items-center space-x-2",children:[e.jsx(Ee,{className:"w-12 h-12"}),e.jsx("h1",{className:"scroll-m-20 text-center text-lg font-extrabold tracking-tight text-balance",children:"Test sound"})]}),e.jsxs(Q,{className:"space-y-6",children:[e.jsx("p",{className:"text-center",children:"Put on your headphones and click on the Play sound button to play a sample sound."}),e.jsx("div",{className:"flex justify-center",children:e.jsx(H,{variant:"default",onClick:a,className:"bg-black hover:bg-gray-800 border-black text-white",children:x?"Stop sound":"Play sound"})}),e.jsxs("p",{className:"flex gap-2",children:[e.jsx(U,{className:"text-destructive"})," If you cannot hear the sound clearly, please tell the invigilator."]}),e.jsx("audio",{ref:d,src:"https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3"})]}),e.jsx(G,{children:e.jsx(H,{className:"w-full",onClick:n,children:"Continue"})})]})})}const Ke=({onNext:n})=>{const{id:x}=je(),{form:h,onSubmit:d,query:a,listeningMutation:_,finish:E}=ze(x,n),y=i.get(a,"data.listening_parts",[]),o=l.useMemo(()=>oe(Array.isArray(y)?y:[]),[y]),C=i.get(a,"data.answer_time",null);(i.get(a,"data.material.test_type","Mock")||"Mock").toString().toLowerCase();const[A,j]=l.useState(!1),[I,k]=l.useState(!0),[p,L]=l.useState(0),[t,c]=l.useState(!1),g=l.useRef([]),s=l.useRef(null),[m,w]=l.useState(()=>{const r=localStorage.getItem("audioVolume");return r?parseFloat(r):1}),[N,S]=l.useState(!1),[Y,le]=l.useState(!1),[v,M]=l.useState(!1),[z,O]=l.useState(!1);l.useEffect(()=>{a.data&&(i.get(a,"data.material.test_type","Mock")==="Thematic"?(S(!0),M(!1)):(S(!1),M(!0)))},[a.data]);const{timeLeft:J,formatTime:ce,activeTab:P,setActiveTab:K,currentTabIndex:ue,handlePrevious:de,handleNext:me,isTestFinished:D}=ye(C,o,h.handleSubmit(d),A,E);we({shouldBlock:!D,audioRef:s,timeLeft:J,isAudioPlaying:z,customMessage:"Listening test tugamaguncha va audio yakunlanmaguncha sahifadan chiqish taqiqlangan!"}),l.useEffect(()=>{if(a.isSuccess&&o.length>0&&!t){let r=0;const u=[];o.forEach((T,b)=>{const f=new Audio;f.src=T.audio,f.preload="auto",f.volume=m,u[b]=f,f.oncanplaythrough=()=>{r++,r===o.length&&(c(!0),g.current=u)},f.onplay=()=>{O(!0)},f.onpause=()=>{O(!1)},f.onended=()=>{O(!1)},f.onerror=pe=>{console.error(`Audio yuklashda xato (part ${T.id}):`,pe),r++,r===o.length&&(c(!0),g.current=u)}})}},[a.isSuccess,o,t,m]);const he=()=>{k(!1),g.current.length>0&&(s.current=g.current[0],i.get(a,"data.material.test_type","Mock")==="Mock"&&s.current.play().catch(u=>{console.error("Birinchi audio ijro etishda xato:",u)}))};l.useEffect(()=>{localStorage.setItem("audioVolume",m.toString()),g.current.forEach(r=>{r.volume=m})},[m]),l.useEffect(()=>{a.data&&t&&i.get(a,"data.material.test_type","Mock")==="Thematic"&&s.current&&(s.current.pause(),s.current.currentTime=0)},[a.data,t]),l.useEffect(()=>{if(I||!t||o.length===0)return;const r=i.get(a,"data.material.test_type","Mock");if(r==="Thematic"&&!v)return;const u=s.current,T=()=>{p<o.length-1?(u&&(u.pause(),u.currentTime=0),L(b=>b+1)):(j(!0),u&&(u.pause(),u.currentTime=0))};if(p<o.length){const b=g.current[p];b&&b!==u?(u&&(u.pause(),u.currentTime=0,u.removeEventListener("ended",T)),s.current=b,s.current.volume=m,r==="Thematic"&&!v&&(s.current.pause(),s.current.currentTime=0),!N&&v&&s.current.play().catch(f=>{console.error(`Audio ijro etishda xato (part ${o[p].id}):`,f)}),s.current.addEventListener("ended",T)):u&&(u.paused&&!N&&v&&u.play().catch(f=>{console.error("Audio ijro etishda xato:",f)}),u.addEventListener("ended",T))}return()=>{s.current&&(s.current.pause(),s.current.removeEventListener("ended",T))}},[p,o,I,t,m,N,v]),l.useEffect(()=>{"mediaSession"in navigator&&(navigator.mediaSession.setActionHandler("play",()=>{s.current&&s.current.paused&&v&&s.current.play()}),navigator.mediaSession.setActionHandler("pause",()=>{s.current&&!s.current.paused&&s.current.pause()}),navigator.mediaSession.setActionHandler("stop",()=>{s.current&&(s.current.pause(),s.current.currentTime=0)}),navigator.mediaSession.setActionHandler("nexttrack",()=>{p<o.length-1&&L(r=>r+1)}),navigator.mediaSession.setActionHandler("previoustrack",()=>{p>0&&L(r=>r-1)}))},[p,o.length,v]);const W=r=>{w(r)},ge=()=>{if(s.current)if(N){s.current.play(),S(!1),M(!0);const{user:r}=useAuthStore.getState();r?.role===Role.STUDENT&&le(!0)}else{const{user:r}=useAuthStore.getState();(r?.role===Role.TEACHER||!Y)&&(s.current.pause(),S(!0))}},xe=o.find(r=>`tab-${r.id}`===P);return a.isLoading||!t?e.jsx(Qe,{message:"Loading test data and audio files..."}):a.isError?e.jsx(re,{title:"Failed to Load Test",message:"An error occurred while loading the test. Please try again later."}):a.data?.listening_parts.length===0?e.jsx(re,{title:"Failed to load test",message:"An error occurred while loading the test questions. Please try again later."}):e.jsx(e.Fragment,{children:I?e.jsx(Je,{onNext:he,onVolumeChange:W,initialVolume:m,audioElements:g.current}):e.jsx(Oe,{...h,children:e.jsxs("form",{onSubmit:h.handleSubmit(d),className:"min-h-screen",children:[e.jsxs("div",{className:"sticky top-0 z-50 bg-primary-foreground space-y-1",children:[e.jsx(Ie,{timeLeft:J,formatTime:ce,testType:q.LISTENING,type:i.get(a,"data.material.test_type","Mock"),audioRef:s,handleVolumeChange:W,handlePauseToggle:ge,isPaused:N,studentHasStarted:Y,userHasStarted:v,isAudioPlaying:z}),e.jsx(ke,{activePart:xe,testType:q.LISTENING})]}),e.jsxs(Ce,{value:P,onValueChange:K,children:[e.jsx(Le,{data:o,activeTab:P,testType:q.LISTENING,form:h,testId:x}),e.jsx(Pe,{data:o,testType:q.LISTENING,form:h,activeTab:P,setActiveTab:K,currentTabIndex:ue,handlePrevious:de,handleNext:me,onSubmit:h.handleSubmit(d),isTestFinished:D,isLoading:_.isPending})]})]})})})};function De({onNext:n}){return e.jsx("div",{className:"flex items-center justify-center min-h-screen py-4",children:e.jsxs(V,{className:"w-full max-w-3xl shadow-lg",children:[e.jsxs(B,{className:"flex items-center space-x-2",children:[e.jsx(ie,{className:"w-12 h-12"}),e.jsx("h1",{className:"scroll-m-20 text-center text-lg font-extrabold tracking-tight text-balance",children:"IELTS Academic Listening"})]}),e.jsxs(Q,{className:"space-y-8",children:[e.jsx("div",{className:"space-y-3",children:e.jsxs("p",{children:[e.jsx("strong",{children:"Time:"})," Approximately 30 minutes"]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h2",{className:"text-md font-semibold",children:"INSTRUCTIONS TO CANDIDATES"}),e.jsxs("ul",{className:"list-disc pl-5 space-y-1",children:[e.jsx("li",{children:"Answer all the questions."}),e.jsx("li",{children:"You can change your answers at any time during the test."})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h2",{className:"text-md font-semibold",children:"INFORMATION FOR CANDIDATES"}),e.jsxs("ul",{className:"list-disc pl-5 space-y-1",children:[e.jsx("li",{children:"There are 40 questions in this test."}),e.jsx("li",{children:"Each question carries one mark."}),e.jsx("li",{children:"There are four parts to the test."}),e.jsx("li",{children:"You will hear each part once."}),e.jsx("li",{children:"For each part of the test there will be time for you to look through the questions and time for you to check your answers."})]})]}),e.jsxs("p",{className:"flex gap-2",children:[e.jsx(U,{})," Read instructions and start only when ready."]})]}),e.jsx(G,{children:e.jsx(H,{className:"w-full",onClick:n,children:"Start test"})})]})})}const Rs=()=>e.jsx(Se,{steps:[e.jsx(Ne,{}),e.jsx(De,{}),e.jsx(Ke,{}),e.jsx(Ge,{disableOverflow:!0})]});export{Rs as default};
