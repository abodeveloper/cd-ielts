import{j as e,c as C,r as y,_ as he,e as Q}from"./index-x8u20K9c.js";import{B as o}from"./badge-sP1IP7gS.js";import{C as z,a as O,b as U,c as G}from"./card-pj2_oIhs.js";import{B as fe}from"./BackButton-Dtm_0n-h.js";import{u as P,E as H}from"./ErrorMessage-DASnKxHi.js";import{L as xe}from"./LoadingSpinner-CCmmZw_H.js";import{U as pe,F as _e,c as we,b as je,_ as ve,h as ye}from"./index-xH9p-mai.js";import{l as r}from"./lodash-BfwN313r.js";import{a as Ne}from"./groups-ByV_lFeG.js";import{j as be,k as Te,h as ke}from"./test-material-slxaB12h.js";import{D as Se}from"./data-table-CwmpSRN8.js";import{I as Ce}from"./input-136_Gzk7.js";import{u as Pe}from"./useDebounce-DLeT2K2n.js";import{b as Fe}from"./helper-DHn6dyFE.js";import{B as Ke}from"./button-CEk6aIhe.js";import"./index-BdrbzQWw.js";import"./utils-CPYLdFy8.js";import"./createLucideIcon-OAtobG9R.js";import"./table-BnVQCl16.js";import"./chevron-right-CUIRr8L6.js";import"./index-NCJt2kZ7.js";function Re(d){const n=[{accessorKey:"full_name",header:"Student Name",cell:({row:t})=>e.jsx("div",{children:t.getValue("full_name")})},{accessorKey:"created_at",header:"Test performed",cell:({row:t})=>{const s=String(t.getValue("created_at"));return e.jsxs(e.Fragment,{children:[s.slice(0,10)," ",s.slice(11,19)]})}}],u=[{accessorKey:"total_questions",header:"Total questions",cell:({row:t})=>e.jsx(o,{variant:"outline",children:r.get(t.original.material_info,"total_questions")})},{accessorKey:"incorrect_answers",header:"Incorrect answers",cell:({row:t})=>e.jsx(o,{variant:"destructive",children:r.get(t.original.material_info,"incorrect_answers")})},{accessorKey:"correct_answers",header:"Correct answers",cell:({row:t})=>e.jsx(o,{variant:"success",children:r.get(t.original.material_info,"correct_answers")})},{accessorKey:"score_percentage",header:"Score percentage (%)",cell:({row:t})=>e.jsx(o,{variant:"secondary",children:r.get(t.original.material_info,"score_percentage")})},{accessorKey:"material_info",header:"Answer review",cell:({row:t})=>{const s=t.original.student_id,i=r.get(t.original.material_info,"id",null);return e.jsx(C,{to:`/teacher/students/${s}/thematic/reading/${i}/view`,className:"text-blue-500",children:"View"})}}],m=[{accessorKey:"total_questions",header:"Total questions",cell:({row:t})=>{const s=t.original.material_info;return e.jsx(o,{variant:"outline",children:r.get(s,"total_questions")})}},{accessorKey:"incorrect_answers",header:"Incorrect answers",cell:({row:t})=>{const s=t.original.material_info;return e.jsx(o,{variant:"destructive",children:r.get(s,"incorrect_answers")})}},{accessorKey:"correct_answers",header:"Correct answers",cell:({row:t})=>{const s=t.original.material_info;return e.jsx(o,{variant:"success",children:r.get(s,"correct_answers")})}},{accessorKey:"score_percentage",header:"Score percentage (%)",cell:({row:t})=>{const s=t.original.material_info;return e.jsx(o,{variant:"secondary",children:r.get(s,"score_percentage")})}},{accessorKey:"material_info",header:"Answer review",cell:({row:t})=>{const s=t.original.student_id,i=t.getValue("material_info"),g=r.get(i,"id",null);return e.jsx(e.Fragment,{children:e.jsx(C,{to:`/teacher/students/${s}/thematic/listening/${g}/view`,className:"text-blue-500",children:"View"})})}}],h=[{accessorKey:"writing_task1_score",header:"Writing (T1) score",cell:({row:t})=>{const s=t.original.material_info,i=r.get(s,"writing_task1"),g=r.get(i,"completed",!1);return e.jsx(e.Fragment,{children:g?e.jsx(o,{variant:"secondary",children:r.get(i,"score")}):e.jsx(o,{variant:"destructive",children:"Not completed"})})}},{accessorKey:"writing_task2_score",header:"Writing (T2) score",cell:({row:t})=>{const s=t.original.material_info,i=r.get(s,"writing_task2"),g=r.get(i,"completed",!1);return e.jsx(e.Fragment,{children:g?e.jsx(o,{variant:"secondary",children:r.get(i,"score")}):e.jsx(o,{variant:"destructive",children:"Not completed"})})}},{accessorKey:"score",header:"Total score",cell:({row:t})=>{const s=t.original.material_info;return e.jsx(o,{variant:"default",children:r.get(s,"score")})}},{accessorKey:"material_info",header:"Answer review",cell:({row:t})=>{const s=t.original.student_id,i=t.getValue("material_info"),g=r.get(i,"id",null);return e.jsx(e.Fragment,{children:e.jsx(C,{to:`/teacher/students/${s}/thematic/writing/${g}/view`,className:"text-blue-500",children:"View"})})}}],x=[{accessorKey:"feedback",header:"Feedback",cell:({row:t})=>{const s=t.original.material_info;return e.jsx(e.Fragment,{children:r.get(s,"feedback")})}},{accessorKey:"score",header:"Score",cell:({row:t})=>{const s=t.original.material_info;return e.jsx(o,{variant:"default",children:r.get(s,"score")})}},{accessorKey:"material_info",header:"Answer review",cell:({row:t})=>{const s=t.original.student_id,i=t.getValue("material_info"),g=r.get(i,"id",null);return e.jsx(e.Fragment,{children:e.jsx(C,{to:`/teacher/students/${s}/thematic/writing/${g}/view`,className:"text-blue-500",children:"View"})})}}];return d==="reading"?[...n,...u]:d==="speaking"?[...n,...x]:d==="listening"?[...n,...m]:d==="writing"?[...n,...h]:n}const Ae=({testData:d,type:n,material_id:u,group_id:m})=>{const[h,x]=y.useState(!1),t=y.useMemo(()=>({material_id:u,group_id:m}),[u,m]),{data:s,fetchStatus:i,refetch:g}=P({queryKey:["thematic-full-results",t],queryFn:()=>be(n,u,m),enabled:!1}),T=async()=>{x(!0);try{const{Document:w,Packer:F,Paragraph:f,Table:K,TableCell:k,TableRow:j,TextRun:p,WidthType:R,AlignmentType:I,PageOrientation:X}=await he(async()=>{const{Document:a,Packer:l,Paragraph:c,Table:b,TableCell:v,TableRow:le,TextRun:de,WidthType:me,AlignmentType:ge,PageOrientation:ue}=await import("./index-Bh8N9vQq.js");return{Document:a,Packer:l,Paragraph:c,Table:b,TableCell:v,TableRow:le,TextRun:de,WidthType:me,AlignmentType:ge,PageOrientation:ue}},[]),A=(await g()).data?.results||[];if(A.length===0){console.error("No data fetched from API");return}const L=A[0]?.group_name||"Group Result",Z=["No","Student Name","Test Performed"];let S=[];n==="reading"||n==="listening"?S=["Total Questions","Correct Answers","Incorrect Answers","Score Percentage (%)"]:n==="writing"?S=["Writing (T1) Score","Writing (T2) Score","Total Score"]:n==="speaking"&&(S=["Feedback","Score"]);const D=[...Z,...S],J=A.map((a,l)=>{const c=a.material_info,b={no:l+1,name:a.full_name,created_at:`${a.created_at.slice(0,10)} ${a.created_at.slice(11,19)}`};let v={};return n==="reading"||n==="listening"?v={total_questions:c.total_questions?.toString()||"-",correct_answers:c.correct_answers?.toString()||"-",incorrect_answers:c.incorrect_answers?.toString()||"-",score_percentage:c.score_percentage?.toString()||"-"}:n==="writing"?v={writing_task1_score:c.writing_task1?.completed&&c.writing_task1?.score?c.writing_task1.score.toString():"Not completed",writing_task2_score:c.writing_task2?.completed&&c.writing_task2?.score?c.writing_task2.score.toString():"Not completed",total_score:c.score?.toString()||"-"}:n==="speaking"&&(v={feedback:c.feedback||"-",score:c.score?.toString()||"-"}),{...b,...v}}),Y=D.length,q=9026,W=[.5,1.8,...Array(Y-2).fill(1)],ee=W.reduce((a,l)=>a+l,0),te=Math.floor(q/ee),E=W.map(a=>Math.floor(te*a)),se=E.reduce((a,l)=>a+l,0),B=q-se;B>0&&(E[1]+=B);const $=a=>E[a],re=new j({children:D.map((a,l)=>new k({children:[new f({children:[new p({text:a,bold:!0})],alignment:I.CENTER})],shading:{fill:"D3D3D3"},width:{size:$(l),type:R.DXA}}))}),ae=J.map(a=>{const l=[a.no,a.name,a.created_at];return n==="reading"||n==="listening"?l.push(a.total_questions,a.correct_answers,a.incorrect_answers,a.score_percentage):n==="writing"?l.push(a.writing_task1_score,a.writing_task2_score,a.total_score):n==="speaking"&&l.push(a.feedback,a.score),new j({children:l.map((c,b)=>new k({children:[new f({children:[new p({text:String(c)})],alignment:I.LEFT})],width:{size:$(b),type:R.DXA}}))})}),ne=new K({rows:[re,...ae],width:{size:q,type:R.DXA},columnWidths:D.map((a,l)=>$(l))}),_=[];d&&(_.push(new f({children:[new p({text:`Test Title: ${d.title}`,size:20})]})),_.push(new f({children:[new p({text:`Test Type: ${d.test_type}`,size:20})]}))),_.push(new f({children:[new p({text:`Group: ${L}`,size:24,bold:!0})]})),_.push(new f({text:""})),_.push(ne);const M=new Date().toLocaleString("en-US",{timeZone:"Asia/Tashkent"});_.push(new f({text:""})),_.push(new f({children:[new p({text:`Generated on: ${M}`,size:20})]}));const ie=new w({sections:[{properties:{page:{size:{orientation:X.PORTRAIT,width:11906,height:16838},margin:{top:1440,right:1440,bottom:1440,left:1440}}},children:_}]}),ce=await F.toBlob(ie),V=window.URL.createObjectURL(ce),N=document.createElement("a");N.href=V;const oe=M.replace(/[/:]/g,"-").replace(/,/g,"");N.download=`${L} - Thematic ${n} Results - ${oe}.docx`,document.body.appendChild(N),N.click(),document.body.removeChild(N),window.URL.revokeObjectURL(V)}catch(w){console.error("Error generating Word document:",w)}finally{x(!1)}};return e.jsxs(Ke,{onClick:T,disabled:h,children:[h?e.jsx(pe,{className:"w-5 h-5 animate-spin"}):e.jsx(_e,{className:"w-5 h-5"})," ","Download"]})},De=({type:d,material:n})=>{const{material_id:u,group_id:m}=Q(),[h,x]=y.useState(1),[t,s]=y.useState(""),i=Pe(t),g=y.useMemo(()=>({material_id:u,group_id:m}),[u,m]),T=Fe(g),{data:w,isLoading:F,isError:f}=P({queryKey:["thematic-reading-results",h,i,T],queryFn:()=>Te(d,h,i,"",T)}),K=Re(d),k=r.get(w,"results",[]),j={totalCount:r.get(w,"count",0),totalPages:r.get(w,"total_pages",1),currentPage:h};return y.useEffect(()=>{x(1)},[i]),f?e.jsx(H,{title:"Failed to Load page",message:"An error occurred while loading the page. Please try again later."}):e.jsx("div",{className:"space-y-8",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"text-xl font-semibold",children:"Results"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(Ce,{placeholder:"Search ...",value:t,onChange:p=>s(p.target.value),className:"max-w-sm w-64"}),e.jsx(Ae,{testData:n,group_id:m,material_id:u,type:d})]})]}),e.jsx("div",{className:"space-y-4",children:e.jsx(Se,{data:k,columns:K,pagination:!0,totalCount:j.totalCount,totalPages:j.totalPages,currentPage:j.currentPage,onPageChange:x,isLoading:F})})]})})},rt=()=>{const{group_id:d,material_id:n,skill:u}=Q(),{data:m,isLoading:h,isError:x}=P({queryKey:["groups",d],queryFn:()=>Ne(d)}),{data:t,isLoading:s,isError:i}=P({queryKey:["test-material-thematic",n],queryFn:()=>ke(u,n)});return h||s?e.jsx(xe,{}):x||i?e.jsx(H,{title:"Failed to Load page",message:"An error occurred while loading the page. Please try again later."}):e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"text-xl font-semibold",children:r.get(m,"name")}),e.jsx("div",{className:"flex gap-2",children:e.jsx(fe,{to:`/teacher/tests/thematic/statistics/${n}`,label:"Back to thematic groups"})})]}),e.jsxs(z,{className:"w-full",children:[e.jsx(O,{className:"flex flex-row items-center gap-4",children:e.jsx(U,{children:m?.name})}),e.jsxs(G,{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{className:"text-sm text-primary font-extrabold",children:"Number of students"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:m?.students_count})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{className:"text-sm text-primary font-extrabold",children:"Status:"}),m?.is_active===!0?e.jsx(o,{variant:"success",children:"Active"}):e.jsx(o,{variant:"destructive",children:"Inactive"})]})]})]}),e.jsxs(z,{className:"w-full",children:[e.jsx(O,{className:"flex flex-row items-center gap-4",children:e.jsxs(U,{className:"flex items-center gap-2 text-lg",children:[e.jsx("div",{children:r.get(t,"test_info.type")==="reading"?e.jsx(we,{className:"h-6 w-6"}):r.get(t,"test_info.type")==="listening"?e.jsx(je,{className:"h-6 w-6"}):r.get(t,"test_info.type")==="writing"?e.jsx(ve,{className:"h-6 w-6"}):e.jsx(ye,{className:"h-6 w-6"})}),e.jsx("div",{children:r.get(t,"test_info.test_title")})]})}),e.jsxs(G,{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{className:"text-sm text-primary font-extrabold",children:"Section title:"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:r.get(t,"material_info.title")})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{className:"text-sm text-primary font-extrabold",children:"Material title:"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:r.get(t,"title")})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{className:"text-sm text-primary font-extrabold",children:"Test type:"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:e.jsx(o,{variant:"default",children:r.get(t,"test_type","N/A")})})]})]})]}),e.jsx(De,{type:r.get(t,"test_info.type"),material:t})]})};export{rt as default};
