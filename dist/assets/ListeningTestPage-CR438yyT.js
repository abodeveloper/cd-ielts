import{a as te,j as e,d as re,u as ge,t as K,r as d,R as D,e as fe}from"./index-CS2s05i4.js";import{u as je,F as ye,C as we}from"./useTestLogic-C78rFO_v.js";import{B as W}from"./badge-CjIsRrrA.js";import{B as H}from"./button-COBIZrUi.js";import{C as O,a as V,c as B,d as Q}from"./card-B6uzx6J5.js";import{T as Se,a as Ne,b as X,c as R,d as ve,e as F}from"./table-C7t1_LVl.js";import{b as ne,e as Te,g as be,R as G,O as _e}from"./index-Cqn82ak4.js";import{l as i}from"./lodash-CWzgwyzy.js";import{T as Ae}from"./tabs-CJyCdXqc.js";import{u as Ee,T as Ce,a as q,P as Ie,C as Le,b as ke}from"./usePreventPageLeave-VKlQO_5H.js";import{o as Z,b as Pe,s as $,n as ee,u as Re,a as Fe}from"./schemas-3KC15JZT.js";import{u as qe,a as He,F as Me}from"./index.esm-B71M4lkn.js";import{u as $e,E as se}from"./ErrorMessage-BbNFSGUB.js";import{L as Oe}from"./LoadingSpinner-CflaIdYD.js";import"./index-BdrbzQWw.js";import"./utils-CPYLdFy8.js";import"./index-63UScni_.js";import"./index-C0WrmhQw.js";import"./index-x3L15vPG.js";import"./index-f06P9S5E.js";import"./index-tcoWAij7.js";import"./index-DLJVOBtY.js";import"./index-mipPtYdG.js";import"./createLucideIcon-Dms7U1ir.js";import"./select-DjYLCAgf.js";import"./index-DBp2RNDP.js";import"./index-DWHm-Cgz.js";import"./index-B-d4RDQV.js";import"./form-0hi-Stsd.js";import"./dropdown-menu-CUfoXf1Z.js";import"./chevron-right-DYVfM_R8.js";import"./input-DTtiGvPz.js";import"./index-D9z673Yh.js";function Ve({formData:r}){const{user:p}=te(),m=i.get(r,"finish"),u=i.get(r,"test_type"),n=i.get(r,"overall_score"),A=i.get(r,"percentage_correct_for_material",0),E=i.get(r,"answers",[]),j=i.get(r,"total_answers",0),o=i.get(r,"total_correct_answers",0),C=i.get(r,"total_incorrect_answers",0),_=()=>{m()};return e.jsx("div",{className:"p-4 w-full",children:e.jsxs(O,{className:"w-full shadow-lg",children:[e.jsxs(V,{className:"flex items-center space-x-2",children:[e.jsx(ne,{className:"w-12 h-12"}),e.jsx("h1",{className:"text-center text-lg font-extrabold tracking-tight text-balance",children:"IELTS Academic Listening - Results"})]}),e.jsxs(B,{className:"space-y-8",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Candidate:"}),e.jsx("div",{children:i.get(p,"full_name")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Total Questions:"}),e.jsx("div",{children:j})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Correct answers:"}),e.jsx("div",{className:"text-green-500",children:o})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Incorrect answers:"}),e.jsx("div",{className:"text-destructive",children:C})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Percentage correct for material:"}),e.jsxs("div",{children:[A,"%"]})]}),u==="mock"&&e.jsxs("div",{className:"flex items-center gap-2 mt-4",children:[e.jsx("strong",{children:"Overal:"}),e.jsx(W,{variant:"default",children:n})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h2",{className:"text-md font-semibold",children:"Answer Review"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(Se,{className:"h-[400px]",children:[e.jsx(Ne,{children:e.jsxs(X,{children:[e.jsx(R,{children:"Question"}),e.jsx(R,{children:"Your Answer"}),e.jsx(R,{children:"True Answer"}),e.jsx(R,{children:"Status"})]})}),e.jsx(ve,{children:E.map(f=>e.jsxs(X,{children:[e.jsx(F,{children:f.question_number}),e.jsx(F,{children:f.answer||e.jsx(W,{className:"bg-orange-500",children:"Not answered"})}),e.jsx(F,{children:f.true_answer}),e.jsx(F,{children:f.is_true?e.jsx(Te,{className:"text-green-500"}):e.jsx(be,{className:"text-destructive"})})]},f.id))})]})})]})]}),e.jsx(Q,{children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsxs("p",{className:"flex gap-2",children:[e.jsx(G,{})," Review and finalize your results."]}),e.jsx(H,{className:"w-64",onClick:()=>_(),children:"Finish"})]})})]})})}const Be=async r=>(await re.get(`/api/listening/by-material/${r}/`)).data,Qe=async(r,p)=>(await re.post(`/api/listening-answers/${r}/`,p)).data,Ge=Z({answers:Pe(Z({listening_id:ee().optional()||$().optional(),question_number:ee().optional()||$().optional(),answer:$().nullable().optional()}).nullable()).optional()}),Ue=r=>$e({queryKey:["listenings",r],queryFn:()=>Be(r),enabled:!!r}),ae=(r=[])=>[...r].sort((p,m)=>{const u=(p.listening_section??0)-(m.listening_section??0);return u!==0?u:p.id-m.id}),Ye=(r,p)=>{const{user:m}=te(),u=ge(),n=Ue(r),A=m?.id||"guest",E=i.get(n.data,"is_view"),j=i.get(n.data,"material"),o=()=>{if(m?.role===D.TEACHER)u("/");else if(String(i.get(j,"test_type"))?.toLowerCase()=="mock"){const t=i.get(j,"next_test"),l=i.get(j,"next_test_id");u(t==="listening"&&l?`/listenings/${l}`:t==="reading"&&l?`/readings/${l}`:t==="speaking"&&l?`/speakings/${l}`:t==="writing"&&l?`/writings/${l}`:"/")}else u("/")},C=t=>{m?.role===D.TEACHER?p?.({...t,material:j,finish:o}):E===!0?p?.({...t,material:j}):o()},_=Re({mutationFn:t=>Qe(r,t),onSuccess:t=>{K.success("Successfully submitted!"),C(t)},onError:t=>{console.error("Error:",t),K.error(i.get(t,"response.data.error",""))}}),f=qe({resolver:Fe(Ge),defaultValues:{answers:[]}}),{fields:I,replace:L}=He({control:f.control,name:"answers"}),g=`listening_answers_${A}_${r}`;return d.useEffect(()=>{const t=n.data,l=Array.isArray(t?.listening_parts)?ae(t.listening_parts):[];if(l.length===0)return;const x=Math.max(...l.flatMap(h=>h?.question_numbers?.map(y=>y.question_number))),s=Array(x).fill(null);l.forEach(h=>{h?.question_numbers?.forEach(y=>{const N=y.question_number-1;s[N]={listening_id:h.id,question_number:y.question_number,answer:""}})});try{const h=localStorage.getItem(g);if(h){const y=JSON.parse(h);s.forEach((N,S)=>{y[S]&&y[S].answer&&(s[S].answer=y[S].answer)})}}catch(h){console.warn("Failed to load saved answers:",h)}L(s)},[n.data,L,g]),d.useEffect(()=>{const t=f.watch(l=>{if(l.answers&&l.answers.length>0)try{localStorage.setItem(g,JSON.stringify(l.answers))}catch(x){console.warn("Failed to save answers:",x)}});return()=>t.unsubscribe()},[f,g]),{form:f,listeningMutation:_,onSubmit:t=>{const l=(t.answers??[]).filter(x=>x!=null);_.mutate(l);try{localStorage.removeItem(g)}catch(x){console.warn("Failed to clear saved answers:",x)}},answersFields:I,query:n,finish:o}};function ze({onNext:r}){const[p,m]=d.useState(!1),u=d.useRef(null),n=()=>{p?u.current?.pause():u.current?.play(),m(!p)};return e.jsx("div",{className:"flex items-center justify-center min-h-screen py-4",children:e.jsxs(O,{className:"w-full max-w-xl shadow-lg",children:[e.jsxs(V,{className:"flex items-center space-x-2",children:[e.jsx(_e,{className:"w-12 h-12"}),e.jsx("h1",{className:"scroll-m-20 text-center text-lg font-extrabold tracking-tight text-balance",children:"Test sound"})]}),e.jsxs(B,{className:"space-y-6",children:[e.jsx("p",{className:"text-center",children:"Put on your headphones and click on the Play sound button to play a sample sound."}),e.jsx("div",{className:"flex justify-center",children:e.jsx(H,{variant:"outline",onClick:n,children:p?"Stop sound":"Play sound"})}),e.jsxs("p",{className:"flex gap-2",children:[e.jsx(G,{className:"text-destructive"})," If you cannot hear the sound clearly, please tell the invigilator."]}),e.jsx("audio",{ref:u,src:"https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3"})]}),e.jsx(Q,{children:e.jsx(H,{className:"w-full",onClick:r,children:"Continue"})})]})})}const Je=({onNext:r})=>{const{id:p}=fe(),{form:m,onSubmit:u,query:n,listeningMutation:A,finish:E}=Ye(p,r),j=i.get(n,"data.listening_parts",[]),o=d.useMemo(()=>ae(Array.isArray(j)?j:[]),[j]),C=i.get(n,"data.answer_time",null);(i.get(n,"data.material.test_type","Mock")||"Mock").toString().toLowerCase();const[_,f]=d.useState(!1),[I,L]=d.useState(!0),[g,k]=d.useState(0),[t,l]=d.useState(!1),x=d.useRef([]),s=d.useRef(null),[h,y]=d.useState(()=>{const a=localStorage.getItem("audioVolume");return a?parseFloat(a):1}),[N,S]=d.useState(!1),[U,ie]=d.useState(!1),[v,M]=d.useState(!1);d.useEffect(()=>{n.data&&(i.get(n,"data.material.test_type","Mock")==="Thematic"?(S(!0),M(!1)):(S(!1),M(!0)))},[n.data]);const{timeLeft:oe,formatTime:le,activeTab:P,setActiveTab:Y,currentTabIndex:ce,handlePrevious:de,handleNext:ue,isTestFinished:z}=je(C,o,m.handleSubmit(u),_,E);Ee(!z),d.useEffect(()=>{if(n.isSuccess&&o.length>0&&!t){let a=0;const c=[];o.forEach((T,b)=>{const w=new Audio;w.src=T.audio,w.preload="auto",w.volume=h,c[b]=w,w.oncanplaythrough=()=>{a++,a===o.length&&(l(!0),x.current=c)},w.onerror=xe=>{console.error(`Audio yuklashda xato (part ${T.id}):`,xe),a++,a===o.length&&(l(!0),x.current=c)}})}},[n.isSuccess,o,t,h]);const me=()=>{L(!1),x.current.length>0&&(s.current=x.current[0],i.get(n,"data.material.test_type","Mock")==="Mock"&&s.current.play().catch(c=>{console.error("Birinchi audio ijro etishda xato:",c)}))};d.useEffect(()=>{localStorage.setItem("audioVolume",h.toString()),x.current.forEach(a=>{a.volume=h})},[h]),d.useEffect(()=>{n.data&&t&&i.get(n,"data.material.test_type","Mock")==="Thematic"&&s.current&&(s.current.pause(),s.current.currentTime=0)},[n.data,t]),d.useEffect(()=>{if(I||!t||o.length===0)return;const a=i.get(n,"data.material.test_type","Mock");if(a==="Thematic"&&!v)return;const c=s.current,T=()=>{g<o.length-1?(c&&(c.pause(),c.currentTime=0),k(b=>b+1)):(f(!0),c&&(c.pause(),c.currentTime=0))};if(g<o.length){const b=x.current[g];b&&b!==c?(c&&(c.pause(),c.currentTime=0,c.removeEventListener("ended",T)),s.current=b,s.current.volume=h,a==="Thematic"&&!v&&(s.current.pause(),s.current.currentTime=0),!N&&v&&s.current.play().catch(w=>{console.error(`Audio ijro etishda xato (part ${o[g].id}):`,w)}),s.current.addEventListener("ended",T)):c&&(c.paused&&!N&&v&&c.play().catch(w=>{console.error("Audio ijro etishda xato:",w)}),c.addEventListener("ended",T))}return()=>{s.current&&(s.current.pause(),s.current.removeEventListener("ended",T))}},[g,o,I,t,h,N,v]),d.useEffect(()=>{"mediaSession"in navigator&&(navigator.mediaSession.setActionHandler("play",()=>{s.current&&s.current.paused&&v&&s.current.play()}),navigator.mediaSession.setActionHandler("pause",()=>{s.current&&!s.current.paused&&s.current.pause()}),navigator.mediaSession.setActionHandler("stop",()=>{s.current&&(s.current.pause(),s.current.currentTime=0)}),navigator.mediaSession.setActionHandler("nexttrack",()=>{g<o.length-1&&k(a=>a+1)}),navigator.mediaSession.setActionHandler("previoustrack",()=>{g>0&&k(a=>a-1)}))},[g,o.length,v]);const J=a=>{y(a)},he=()=>{if(s.current)if(N){s.current.play(),S(!1),M(!0);const{user:a}=useAuthStore.getState();a?.role===Role.STUDENT&&ie(!0)}else{const{user:a}=useAuthStore.getState();(a?.role===Role.TEACHER||!U)&&(s.current.pause(),S(!0))}},pe=o.find(a=>`tab-${a.id}`===P);return n.isLoading||!t?e.jsx(Oe,{message:"Loading test data and audio files..."}):n.isError?e.jsx(se,{title:"Failed to Load Test",message:"An error occurred while loading the test. Please try again later."}):n.data?.listening_parts.length===0?e.jsx(se,{title:"Failed to load test",message:"An error occurred while loading the test questions. Please try again later."}):e.jsx(e.Fragment,{children:I?e.jsx(ze,{onNext:me,onVolumeChange:J,initialVolume:h,audioElements:x.current}):e.jsx(Me,{...m,children:e.jsxs("form",{onSubmit:m.handleSubmit(u),className:"min-h-screen",children:[e.jsxs("div",{className:"sticky top-0 z-50 bg-primary-foreground space-y-1",children:[e.jsx(Ce,{timeLeft:oe,formatTime:le,testType:q.LISTENING,type:i.get(n,"data.material.test_type","Mock"),audioRef:s,handleVolumeChange:J,handlePauseToggle:he,isPaused:N,studentHasStarted:U,userHasStarted:v}),e.jsx(Ie,{activePart:pe,testType:q.LISTENING})]}),e.jsxs(Ae,{value:P,onValueChange:Y,children:[e.jsx(Le,{data:o,activeTab:P,testType:q.LISTENING,form:m,testId:p}),e.jsx(ke,{data:o,testType:q.LISTENING,form:m,activeTab:P,setActiveTab:Y,currentTabIndex:ce,handlePrevious:de,handleNext:ue,onSubmit:m.handleSubmit(u),isTestFinished:z,isLoading:A.isPending})]})]})})})};function Ke({onNext:r}){return e.jsx("div",{className:"flex items-center justify-center min-h-screen py-4",children:e.jsxs(O,{className:"w-full max-w-3xl shadow-lg",children:[e.jsxs(V,{className:"flex items-center space-x-2",children:[e.jsx(ne,{className:"w-12 h-12"}),e.jsx("h1",{className:"scroll-m-20 text-center text-lg font-extrabold tracking-tight text-balance",children:"IELTS Academic Listening"})]}),e.jsxs(B,{className:"space-y-8",children:[e.jsx("div",{className:"space-y-3",children:e.jsxs("p",{children:[e.jsx("strong",{children:"Time:"})," Approximately 30 minutes"]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h2",{className:"text-md font-semibold",children:"INSTRUCTIONS TO CANDIDATES"}),e.jsxs("ul",{className:"list-disc pl-5 space-y-1",children:[e.jsx("li",{children:"Answer all the questions."}),e.jsx("li",{children:"You can change your answers at any time during the test."})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h2",{className:"text-md font-semibold",children:"INFORMATION FOR CANDIDATES"}),e.jsxs("ul",{className:"list-disc pl-5 space-y-1",children:[e.jsx("li",{children:"There are 40 questions in this test."}),e.jsx("li",{children:"Each question carries one mark."}),e.jsx("li",{children:"There are four parts to the test."}),e.jsx("li",{children:"You will hear each part once."}),e.jsx("li",{children:"For each part of the test there will be time for you to look through the questions and time for you to check your answers."})]})]}),e.jsxs("p",{className:"flex gap-2",children:[e.jsx(G,{})," Read instructions and start only when ready."]})]}),e.jsx(Q,{children:e.jsx(H,{className:"w-full",onClick:r,children:"Start test"})})]})})}const Cs=()=>e.jsx(ye,{steps:[e.jsx(we,{}),e.jsx(Ke,{}),e.jsx(Je,{}),e.jsx(Ve,{disableOverflow:!0})]});export{Cs as default};
