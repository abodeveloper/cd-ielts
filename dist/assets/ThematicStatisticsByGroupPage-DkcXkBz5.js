import{j as e,c as C,r as y,e as Q}from"./index-CfIrOS5m.js";import{B as c}from"./badge-BhECQGgt.js";import{C as B,a as M,b as V,c as z}from"./card-BhVoAx_3.js";import{B as ne}from"./BackButton-o3mbxZfK.js";import{u as F,E as H}from"./ErrorMessage-DcP46Mqc.js";import{L as ce}from"./LoadingSpinner-CfqyBL7n.js";import{U as oe,F as le,c as de,b as me,_ as ge,h as ue}from"./index-DBWS05Jx.js";import{l as r}from"./lodash-DiA_zyBt.js";import{a as he}from"./groups-DTZvijlO.js";import{j as fe,k as xe,h as pe}from"./test-material-GaXpr7Md.js";import{D as _e}from"./data-table-CfjkQrwz.js";import{I as we}from"./input-BZQtrkrJ.js";import{u as je}from"./useDebounce-U2IRvVpy.js";import{b as ve}from"./helper-DHn6dyFE.js";import{B as ye}from"./button-BK_aH1du.js";import{T as U,a as G,W as $,P as p,A as O,b as v,c as Ne,F as be,d as Te,e as ke}from"./index-vYlAMFR9.js";import"./index-BdrbzQWw.js";import"./utils-CPYLdFy8.js";import"./createLucideIcon-3PnfhH_s.js";import"./table-Cp4XBak1.js";import"./chevron-right-CfezoklJ.js";import"./index-CM6yX0md.js";function Se(o){const i=[{accessorKey:"full_name",header:"Student Name",cell:({row:t})=>e.jsx("div",{children:t.getValue("full_name")})},{accessorKey:"created_at",header:"Test performed",cell:({row:t})=>{const s=String(t.getValue("created_at"));return e.jsxs(e.Fragment,{children:[s.slice(0,10)," ",s.slice(11,19)]})}}],u=[{accessorKey:"total_questions",header:"Total questions",cell:({row:t})=>e.jsx(c,{variant:"outline",children:r.get(t.original.material_info,"total_questions")})},{accessorKey:"incorrect_answers",header:"Incorrect answers",cell:({row:t})=>e.jsx(c,{variant:"destructive",children:r.get(t.original.material_info,"incorrect_answers")})},{accessorKey:"correct_answers",header:"Correct answers",cell:({row:t})=>e.jsx(c,{variant:"success",children:r.get(t.original.material_info,"correct_answers")})},{accessorKey:"score_percentage",header:"Score percentage (%)",cell:({row:t})=>e.jsx(c,{variant:"secondary",children:r.get(t.original.material_info,"score_percentage")})},{accessorKey:"material_info",header:"Answer review",cell:({row:t})=>{const s=t.original.student_id,n=r.get(t.original.material_info,"id",null);return e.jsx(C,{to:`/teacher/students/${s}/thematic/reading/${n}/view`,className:"text-blue-500",children:"View"})}}],d=[{accessorKey:"total_questions",header:"Total questions",cell:({row:t})=>{const s=t.original.material_info;return e.jsx(c,{variant:"outline",children:r.get(s,"total_questions")})}},{accessorKey:"incorrect_answers",header:"Incorrect answers",cell:({row:t})=>{const s=t.original.material_info;return e.jsx(c,{variant:"destructive",children:r.get(s,"incorrect_answers")})}},{accessorKey:"correct_answers",header:"Correct answers",cell:({row:t})=>{const s=t.original.material_info;return e.jsx(c,{variant:"success",children:r.get(s,"correct_answers")})}},{accessorKey:"score_percentage",header:"Score percentage (%)",cell:({row:t})=>{const s=t.original.material_info;return e.jsx(c,{variant:"secondary",children:r.get(s,"score_percentage")})}},{accessorKey:"material_info",header:"Answer review",cell:({row:t})=>{const s=t.original.student_id,n=t.getValue("material_info"),g=r.get(n,"id",null);return e.jsx(e.Fragment,{children:e.jsx(C,{to:`/teacher/students/${s}/thematic/listening/${g}/view`,className:"text-blue-500",children:"View"})})}}],h=[{accessorKey:"writing_task1_score",header:"Writing (T1) score",cell:({row:t})=>{const s=t.original.material_info,n=r.get(s,"writing_task1"),g=r.get(n,"completed",!1);return e.jsx(e.Fragment,{children:g?e.jsx(c,{variant:"secondary",children:r.get(n,"score")}):e.jsx(c,{variant:"destructive",children:"Not completed"})})}},{accessorKey:"writing_task2_score",header:"Writing (T2) score",cell:({row:t})=>{const s=t.original.material_info,n=r.get(s,"writing_task2"),g=r.get(n,"completed",!1);return e.jsx(e.Fragment,{children:g?e.jsx(c,{variant:"secondary",children:r.get(n,"score")}):e.jsx(c,{variant:"destructive",children:"Not completed"})})}},{accessorKey:"score",header:"Total score",cell:({row:t})=>{const s=t.original.material_info;return e.jsx(c,{variant:"default",children:r.get(s,"score")})}},{accessorKey:"material_info",header:"Answer review",cell:({row:t})=>{const s=t.original.student_id,n=t.getValue("material_info"),g=r.get(n,"id",null);return e.jsx(e.Fragment,{children:e.jsx(C,{to:`/teacher/students/${s}/thematic/writing/${g}/view`,className:"text-blue-500",children:"View"})})}}],f=[{accessorKey:"feedback",header:"Feedback",cell:({row:t})=>{const s=t.original.material_info;return e.jsx(e.Fragment,{children:r.get(s,"feedback")})}},{accessorKey:"score",header:"Score",cell:({row:t})=>{const s=t.original.material_info;return e.jsx(c,{variant:"default",children:r.get(s,"score")})}},{accessorKey:"material_info",header:"Answer review",cell:({row:t})=>{const s=t.original.student_id,n=t.getValue("material_info"),g=r.get(n,"id",null);return e.jsx(e.Fragment,{children:e.jsx(C,{to:`/teacher/students/${s}/thematic/writing/${g}/view`,className:"text-blue-500",children:"View"})})}}];return o==="reading"?[...i,...u]:o==="speaking"?[...i,...f]:o==="listening"?[...i,...d]:o==="writing"?[...i,...h]:i}const Ce=({testData:o,type:i,material_id:u,group_id:d})=>{const[h,f]=y.useState(!1),t=y.useMemo(()=>({material_id:u,group_id:d}),[u,d]),{data:s,fetchStatus:n,refetch:g}=F({queryKey:["thematic-full-results",t],queryFn:()=>fe(i,u,d),enabled:!1}),T=async()=>{f(!0);try{const N=(await g()).data?.results||[];if(N.length===0){console.error("No data fetched from API");return}const k=N[0]?.group_name||"Group Result",K=["No","Student Name","Test Performed"];let j=[];i==="reading"||i==="listening"?j=["Total Questions","Correct Answers","Incorrect Answers","Score Percentage (%)"]:i==="writing"?j=["Writing (T1) Score","Writing (T2) Score","Total Score"]:i==="speaking"&&(j=["Feedback","Score"]);const _=[...K,...j],P=N.map((a,m)=>{const l=a.material_info,D={no:m+1,name:a.full_name,created_at:`${a.created_at.slice(0,10)} ${a.created_at.slice(11,19)}`};let S={};return i==="reading"||i==="listening"?S={total_questions:l.total_questions?.toString()||"-",correct_answers:l.correct_answers?.toString()||"-",incorrect_answers:l.incorrect_answers?.toString()||"-",score_percentage:l.score_percentage?.toString()||"-"}:i==="writing"?S={writing_task1_score:l.writing_task1?.completed&&l.writing_task1?.score?l.writing_task1.score.toString():"Not completed",writing_task2_score:l.writing_task2?.completed&&l.writing_task2?.score?l.writing_task2.score.toString():"Not completed",total_score:l.score?.toString()||"-"}:i==="speaking"&&(S={feedback:l.feedback||"-",score:l.score?.toString()||"-"}),{...D,...S}}),X=_.length,A=9026,E=[.5,1.8,...Array(X-2).fill(1)],Z=E.reduce((a,m)=>a+m,0),J=Math.floor(A/Z),R=E.map(a=>Math.floor(J*a)),Y=R.reduce((a,m)=>a+m,0),I=A-Y;I>0&&(R[1]+=I);const q=a=>R[a],ee=new U({children:_.map((a,m)=>new G({children:[new p({children:[new v({text:a,bold:!0})],alignment:O.CENTER})],shading:{fill:"D3D3D3"},width:{size:q(m),type:$.DXA}}))}),te=P.map(a=>{const m=[a.no,a.name,a.created_at];return i==="reading"||i==="listening"?m.push(a.total_questions,a.correct_answers,a.incorrect_answers,a.score_percentage):i==="writing"?m.push(a.writing_task1_score,a.writing_task2_score,a.total_score):i==="speaking"&&m.push(a.feedback,a.score),new U({children:m.map((l,D)=>new G({children:[new p({children:[new v({text:String(l)})],alignment:O.LEFT})],width:{size:q(D),type:$.DXA}}))})}),se=new Ne({rows:[ee,...te],width:{size:A,type:$.DXA},columnWidths:_.map((a,m)=>q(m))}),x=[];o&&(x.push(new p({children:[new v({text:`Test Title: ${o.title}`,size:20})]})),x.push(new p({children:[new v({text:`Test Type: ${o.test_type}`,size:20})]}))),x.push(new p({children:[new v({text:`Group: ${k}`,size:24,bold:!0})]})),x.push(new p({text:""})),x.push(se);const L=new Date().toLocaleString("en-US",{timeZone:"Asia/Tashkent"});x.push(new p({text:""})),x.push(new p({children:[new v({text:`Generated on: ${L}`,size:20})]}));const re=new be({sections:[{properties:{page:{size:{orientation:Te.PORTRAIT,width:11906,height:16838},margin:{top:1440,right:1440,bottom:1440,left:1440}}},children:x}]}),ae=await ke.toBlob(re),W=window.URL.createObjectURL(ae),b=document.createElement("a");b.href=W;const ie=L.replace(/[/:]/g,"-").replace(/,/g,"");b.download=`${k} - Thematic ${i} Results - ${ie}.docx`,document.body.appendChild(b),b.click(),document.body.removeChild(b),window.URL.revokeObjectURL(W)}catch(w){console.error("Error generating Word document:",w)}finally{f(!1)}};return e.jsxs(ye,{onClick:T,disabled:h,children:[h?e.jsx(oe,{className:"w-5 h-5 animate-spin"}):e.jsx(le,{className:"w-5 h-5"})," ","Download"]})},Fe=({type:o,material:i})=>{const{material_id:u,group_id:d}=Q(),[h,f]=y.useState(1),[t,s]=y.useState(""),n=je(t),g=y.useMemo(()=>({material_id:u,group_id:d}),[u,d]),T=ve(g),{data:w,isLoading:N,isError:k}=F({queryKey:["thematic-reading-results",h,n,T],queryFn:()=>xe(o,h,n,"",T)}),K=Se(o),j=r.get(w,"results",[]),_={totalCount:r.get(w,"count",0),totalPages:r.get(w,"total_pages",1),currentPage:h};return y.useEffect(()=>{f(1)},[n]),k?e.jsx(H,{title:"Failed to Load page",message:"An error occurred while loading the page. Please try again later."}):e.jsx("div",{className:"space-y-8",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"text-xl font-semibold",children:"Results"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(we,{placeholder:"Search ...",value:t,onChange:P=>s(P.target.value),className:"max-w-sm w-64"}),e.jsx(Ce,{testData:i,group_id:d,material_id:u,type:o})]})]}),e.jsx("div",{className:"space-y-4",children:e.jsx(_e,{data:j,columns:K,pagination:!0,totalCount:_.totalCount,totalPages:_.totalPages,currentPage:_.currentPage,onPageChange:f,isLoading:N})})]})})},Je=()=>{const{group_id:o,material_id:i,skill:u}=Q(),{data:d,isLoading:h,isError:f}=F({queryKey:["groups",o],queryFn:()=>he(o)}),{data:t,isLoading:s,isError:n}=F({queryKey:["test-material-thematic",i],queryFn:()=>pe(u,i)});return h||s?e.jsx(ce,{}):f||n?e.jsx(H,{title:"Failed to Load page",message:"An error occurred while loading the page. Please try again later."}):e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"text-xl font-semibold",children:r.get(d,"name")}),e.jsx("div",{className:"flex gap-2",children:e.jsx(ne,{to:`/teacher/tests/thematic/statistics/${i}`,label:"Back to thematic groups"})})]}),e.jsxs(B,{className:"w-full",children:[e.jsx(M,{className:"flex flex-row items-center gap-4",children:e.jsx(V,{children:d?.name})}),e.jsxs(z,{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{className:"text-sm text-primary font-extrabold",children:"Number of students"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:d?.students_count})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{className:"text-sm text-primary font-extrabold",children:"Status:"}),d?.is_active===!0?e.jsx(c,{variant:"success",children:"Active"}):e.jsx(c,{variant:"destructive",children:"Inactive"})]})]})]}),e.jsxs(B,{className:"w-full",children:[e.jsx(M,{className:"flex flex-row items-center gap-4",children:e.jsxs(V,{className:"flex items-center gap-2 text-lg",children:[e.jsx("div",{children:r.get(t,"test_info.type")==="reading"?e.jsx(de,{className:"h-6 w-6"}):r.get(t,"test_info.type")==="listening"?e.jsx(me,{className:"h-6 w-6"}):r.get(t,"test_info.type")==="writing"?e.jsx(ge,{className:"h-6 w-6"}):e.jsx(ue,{className:"h-6 w-6"})}),e.jsx("div",{children:r.get(t,"test_info.test_title")})]})}),e.jsxs(z,{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{className:"text-sm text-primary font-extrabold",children:"Section title:"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:r.get(t,"material_info.title")})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{className:"text-sm text-primary font-extrabold",children:"Material title:"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:r.get(t,"title")})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{className:"text-sm text-primary font-extrabold",children:"Test type:"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:e.jsx(c,{variant:"default",children:r.get(t,"test_type","N/A")})})]})]})]}),e.jsx(Fe,{type:r.get(t,"test_info.type"),material:t})]})};export{Je as default};
