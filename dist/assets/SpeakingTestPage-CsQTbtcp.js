import{j as e,d as se,a as ne,u as he,t as X,R as fe,r as i,e as xe}from"./index-DCOFZdkl.js";import{H as ge,u as je,F as we,C as ye}from"./useTestLogic-kwhjzcVe.js";import{B as C}from"./button-CJmDKSm7.js";import{C as A,a as re,c as L,d as ae}from"./card-BNV1fjx2.js";import{h as ie,R as ce,u as Se,x as Z,y as be,q as ve,s as Ne,L as ke,r as Re,j as Te}from"./index-C-ywvi3k.js";import{T as Ce,d as qe}from"./tabs-DpOspKjP.js";import{o as Fe,_ as ze,u as Ae,a as Le}from"./schemas-DglB_8gz.js";import{l as F}from"./lodash-Cljd8h8O.js";import{u as Ee,F as Me}from"./index.esm-BneCDedC.js";import{u as Pe,E as ee}from"./ErrorMessage-CjXSFoQr.js";import{c as De}from"./utils-CPYLdFy8.js";import{L as oe}from"./LoadingSpinner-BYEw7_CK.js";import"./index-BKv6cBc6.js";import"./index-BdrbzQWw.js";import"./index-DfDO-NHl.js";import"./index-DlQqJRZi.js";import"./index-3nd8Io2J.js";import"./index-Cwv8Bpok.js";import"./index-DQ8OiU3I.js";import"./index-D-GPwZwk.js";import"./createLucideIcon-CkTYkncT.js";function Ue({onNext:s}){return e.jsx("div",{className:"flex items-center justify-center min-h-screen py-4",children:e.jsxs(A,{className:"w-full max-w-3xl shadow-lg",children:[e.jsxs(re,{className:"flex items-center space-x-2",children:[e.jsx(ie,{className:"w-12 h-12"}),e.jsx("h1",{className:"scroll-m-20 text-center text-lg font-extrabold tracking-tight text-balance",children:"IELTS Academic Speaking"})]}),e.jsxs(L,{className:"space-y-8",children:[e.jsx("div",{className:"space-y-3",children:e.jsxs("p",{children:[e.jsx("strong",{children:"Time:"})," 11â€“14 minutes"]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h2",{className:"text-md font-semibold",children:"INSTRUCTIONS TO CANDIDATES"}),e.jsxs("ul",{className:"list-disc pl-5 space-y-1",children:[e.jsx("li",{children:"This test will be recorded through your microphone."}),e.jsx("li",{children:"Speak clearly and answer all the questions."}),e.jsx("li",{children:"You cannot pause or repeat the questions."})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h2",{className:"text-md font-semibold",children:"INFORMATION FOR CANDIDATES"}),e.jsxs("ul",{className:"list-disc pl-5 space-y-1",children:[e.jsx("li",{children:"The Speaking test has three parts."}),e.jsx("li",{children:"Part 1: Introduction and interview."}),e.jsx("li",{children:"Part 2: Long turn (1 minute to prepare, 1â€“2 minutes to speak)."}),e.jsx("li",{children:"Part 3: Two-way discussion."})]})]}),e.jsxs("p",{className:"flex gap-2",children:[e.jsx(ce,{})," Check your microphone before starting."]})]}),e.jsx(ae,{children:e.jsx(C,{className:"w-full",onClick:s,children:"Start Speaking Test"})})]})})}const _e=async s=>(await se.get(`/api/speaking/by-material/${s}/`)).data,Ie=async s=>(await se.post("/api/speaking-answers/",s,{headers:{"Content-Type":"multipart/form-data"}})).data,Be=Fe({record:ze(File).refine(s=>s.type.startsWith("audio/"),{message:"Faqat audio fayllar qabul qilinadi"})}),te=s=>Pe({queryKey:["speakings",s],queryFn:()=>_e(s),enabled:!!s}),He=s=>{const{user:m}=ne(),u=he(),p=te(s),d=F.get(p.data,"material"),h=()=>{if(m?.role===fe.TEACHER)u("/");else if(String(F.get(d,"test_type"))?.toLowerCase()=="mock"){const n=F.get(d,"next_test"),r=F.get(d,"next_test_id");u(n==="listening"&&r?`/listenings/${r}`:n==="speaking"&&r?`/speakings/${r}`:n==="writing"&&r?`/writings/${r}`:"/")}else u("/")},f=()=>{h()},x=Ae({mutationFn:n=>Ie(n),onSuccess:()=>{X.success("Successfully submitted!"),f()},onError:n=>{console.error("Error:",n),X.error(F.get(n,"response.data.error",""))}});return{form:Ee({resolver:Le(Be),defaultValues:{record:void 0}}),speakingMutation:x,onSubmit:n=>{x.isPending||x.mutate(n)},query:te(s)}},$e=()=>{const[s,m]=i.useState(0),[u,p]=i.useState(0),d=i.useCallback(()=>{m(window.innerWidth),p(window.innerHeight)},[m,p]);return i.useEffect(()=>(window.addEventListener("resize",d),d(),()=>window.removeEventListener("resize",d)),[d]),[s,u]};function Oe(s,m,u,p,d){s.getByteFrequencyData(p),u.fillStyle="#000";const h=m.height/2;var f=Math.ceil(m.width/d)*2.5;let x,c=0;for(var o=0;o<d;o++)x=p[o]/255*h,u.fillStyle="#21C55d",u.fillRect(c,h-x,f,x),c+=f+1}const Ve=({analyzerData:s})=>{const m=i.useRef(null),{dataArray:u,analyzer:p,bufferLength:d}=s,h=(c,o,n)=>{const r=m.current;if(!r||!o)return;const y=r.getContext("2d");if(!y)return;const S=()=>{!m.current||!o||(requestAnimationFrame(S),r.width=r.width,Oe(o,r,y,c,n))};S()};i.useEffect(()=>{h(u,p,d)},[u,p,d]);const[f,x]=$e();return e.jsx("canvas",{ref:m,width:f,height:x,style:{maxWidth:"600px",maxHeight:"100px",marginTop:"16px",width:"100%"}})},We=({part:s,activeTab:m,isLastPart:u,onNextPart:p,onFinish:d,allAudioChunks:h})=>{const[f,x]=i.useState(0),[c,o]=i.useState("preparation"),[n,r]=i.useState(null),[y,S]=i.useState(!1),[E,M]=i.useState(!1),[P,q]=i.useState(null),a=i.useRef(null),k=i.useRef(null),b=i.useRef(null),R=i.useRef(null),T=i.useRef(null),[D,g]=i.useState(!1),v=i.useRef(null),U=s?.question_numbers||[],w=U[f],O=l=>{if(l===null)return"";if(l<60)return e.jsx("div",{className:"w-[50px]",children:`${l} s`});{const t=Math.floor(l/60),$=l%60;return e.jsx("div",{className:"w-[50px]",children:`${t}:${$.toString().padStart(2,"0")}`})}},V=l=>{if(!l)return"";const t=document.createElement("div");return t.innerHTML=l,t.textContent||t.innerText||""},le=()=>{if(!w||!w.question)return;if(!("speechSynthesis"in window)){console.warn("Text-to-Speech is not supported in this browser.");return}const l=V(w.question).trim();if(!l)return;window.speechSynthesis.cancel();const t=new SpeechSynthesisUtterance(l);t.lang="en-US",t.rate=.95,t.pitch=1,t.onstart=()=>g(!0),t.onend=()=>{g(!1),v.current=null},t.onerror=()=>{g(!1),v.current=null},v.current=t,window.speechSynthesis.speak(t)},H=()=>{"speechSynthesis"in window&&(window.speechSynthesis.cancel(),g(!1),v.current=null)};i.useEffect(()=>{if(!w||!w.question){window.speechSynthesis&&window.speechSynthesis.cancel(),g(!1),v.current=null;return}if(!("speechSynthesis"in window))return;window.speechSynthesis.cancel(),g(!1);const l=V(w.question).trim();if(!l)return;const t=new SpeechSynthesisUtterance(l);return t.lang="en-US",t.rate=.95,t.pitch=1,t.onstart=()=>g(!0),t.onend=()=>{g(!1),v.current=null},t.onerror=()=>{g(!1),v.current=null},v.current=t,window.speechSynthesis.speak(t),()=>{window.speechSynthesis&&window.speechSynthesis.cancel(),g(!1),v.current=null}},[w?.question_number]),i.useEffect(()=>{w&&c==="preparation"&&m===`tab-${s.id}`&&r(s.prep_time)},[f,m,c,w,s.prep_time]),i.useEffect(()=>{if(n===null||c==="paused"||c==="finish")return;if(n<=0){c==="preparation"?(o("answering"),r(s.answer_time),W()):c==="answering"&&(Q(),o("paused"),r(0));return}const l=setTimeout(()=>{r(t=>t!==null?t-1:null)},1e3);return()=>clearTimeout(l)},[n,c,s.answer_time]),i.useEffect(()=>{if(c==="paused"&&n===0&&!E){const l=setTimeout(()=>{console.log("Paused phase:",{currentIndex:f,questionsLength:U.length,isLastPart:u}),f<U.length-1?(x(t=>t+1),o("preparation"),r(null)):!u&&p?(p(),x(0),o("preparation"),r(null)):u&&d&&(console.log("onFinish called"),M(!0),ue().finally(()=>{o("finish"),d()}))},1e3);return()=>clearTimeout(l)}},[c,n,f,U.length,u,p,d,E]);const W=async()=>{try{if(a.current&&a.current.state==="paused"){try{a.current.requestData()}catch(j){console.warn("Could not request data before resume:",j)}a.current.resume(),S(!0),T.current&&q(T.current),console.log("Recording resumed. Total chunks:",h.current.length);return}if(a.current?.state==="recording")return;const l=await navigator.mediaDevices.getUserMedia({audio:{channelCount:1,sampleRate:44100,sampleSize:16,echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});R.current=l;const t=new(window.AudioContext||window.webkitAudioContext);b.current=t;const $=t.createMediaStreamSource(l),_=t.createBiquadFilter();_.type="highpass",_.frequency.value=120;const I=t.createBiquadFilter();I.type="lowpass",I.frequency.value=8e3;const N=t.createDynamicsCompressor();N.threshold.setValueAtTime(-30,t.currentTime),N.knee.setValueAtTime(30,t.currentTime),N.ratio.setValueAtTime(12,t.currentTime),N.attack.setValueAtTime(.003,t.currentTime),N.release.setValueAtTime(.25,t.currentTime);const K=t.createMediaStreamDestination();$.connect(_),_.connect(I),I.connect(N),N.connect(K);const B=t.createAnalyser();B.fftSize=2048;const Y=B.frequencyBinCount,de=new Uint8Array(Y);N.connect(B),T.current={analyzer:B,bufferLength:Y,dataArray:de},q(T.current);const me=K.stream,J=["audio/mpeg","audio/webm;codecs=opus","audio/webm"].find(j=>MediaRecorder.isTypeSupported(j)),pe=J?{mimeType:J,audioBitsPerSecond:128e3}:{audioBitsPerSecond:128e3},z=new MediaRecorder(me,pe);a.current=z,z.ondataavailable=j=>{j.data&&j.data.size>0&&(console.log("Audio chunk received:",j.data.size,"bytes"),h.current.push(j.data))},z.onerror=j=>{console.error("MediaRecorder error:",j)},z.onstop=()=>{if(a.current&&a.current.state!=="inactive")try{a.current.requestData()}catch(j){console.warn("Could not request final data:",j)}S(!1),q(null),T.current=null,console.log("Recording stopped. Total chunks:",h.current.length),setTimeout(()=>{a.current=null,R.current&&(R.current.getTracks().forEach(j=>j.stop()),R.current=null),b.current&&(b.current.close(),b.current=null),k.current&&(k.current(),k.current=null)},100)},z.start(1e3),S(!0),console.log("Recording started with timeslice 1000ms")}catch(l){console.error("Microphone permission denied:",l),o("paused"),r(0)}},Q=()=>{a.current&&a.current.state==="recording"&&(a.current.requestData(),a.current.pause(),S(!1),q(null),console.log("Recording paused. Total chunks:",h.current.length))},ue=()=>new Promise(l=>{if(a.current&&a.current.state!=="inactive"){try{a.current.state==="recording"&&a.current.requestData()}catch(t){console.warn("Could not request final data before stop:",t)}k.current=()=>{console.log("Recording fully stopped. Final chunk count:",h.current.length),l()},a.current.stop()}else l()}),G=async l=>{l.preventDefault(),c==="preparation"?(H(),o("answering"),r(s.answer_time),await W()):c==="answering"&&y&&(H(),Q(),o("paused"),r(0))};return w?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-[calc(100vh-225px)] flex flex-col items-center justify-center gap-6 p-[100px]",children:e.jsxs("div",{className:"flex flex-col gap-10",children:[e.jsxs("div",{className:"text-lg font-extrabold",children:[c==="preparation"&&e.jsxs("div",{className:"flex flex-col gap-4 items-center justify-center",children:[e.jsx(Se,{size:80,className:"text-orange-500"}),e.jsxs("div",{className:"text-orange-500 flex items-center gap-2 justify-center",children:[e.jsx("div",{children:"Preparation:"})," ",O(n)]})]}),c==="answering"&&e.jsxs("div",{className:"flex flex-col gap-4 items-center justify-center",children:[e.jsx(Z,{size:80,className:"text-green-500"}),e.jsxs("div",{className:"text-green-500 flex items-center gap-2 justify-center",children:[e.jsx("div",{children:"Speaking:"})," ",O(n)]}),y&&P&&e.jsx(Ve,{analyzerData:P})]}),c==="paused"&&e.jsx(oe,{}),c==="finish"&&e.jsxs("div",{className:"flex flex-col gap-4 items-center justify-center",children:[e.jsx(be,{size:80,className:"text-green-500"}),e.jsx("div",{className:"text-green-500",children:"Test Completed"})]})]}),c!=="finish"&&e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsxs("div",{className:"text-2xl font-bold text-center",children:[w.question_number,"."," ",e.jsx(ge,{htmlString:w.question})]}),e.jsx("div",{className:"flex items-center gap-3",children:e.jsx(C,{type:"button",variant:"outline",size:"sm",onClick:D?H:le,className:"flex items-center gap-2",children:D?e.jsxs(e.Fragment,{children:[e.jsx(ve,{size:18}),e.jsx("span",{children:"Stop Reading"})]}):e.jsxs(e.Fragment,{children:[e.jsx(Ne,{size:18}),e.jsx("span",{children:"Read Question"})]})})})]})]})}),e.jsx(A,{className:"w-full shadow-md p-2 px-5 sticky bottom-0 z-50 rounded-none",children:e.jsx(L,{className:"p-0 flex items-center justify-end gap-2 h-[80px]",children:(c==="preparation"||c==="answering")&&e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[c==="preparation"&&e.jsxs(C,{variant:"success",onClick:G,className:"flex items-center gap-2",children:[e.jsx(Z,{size:20}),"Start Answering"]}),c==="answering"&&y&&e.jsxs(C,{variant:"destructive",onClick:G,className:"flex items-center gap-2",children:[e.jsx(ke,{size:20}),"Stop and Continue",e.jsx(Re,{size:20})]})]})})})]}):e.jsx("div",{className:"text-center text-lg",children:"No question available"})},Qe=()=>{const{id:s}=xe(),{user:m}=ne(),{form:u,onSubmit:p,query:d}=He(s),[h,f]=i.useState(null),[x,c]=i.useState(!1),o=i.useRef([]),n=F.get(d,"data.speaking_parts",[]),{activeTab:r,setActiveTab:y,currentTabIndex:S}=je(null,n,()=>{},!1),E=S===n.length-1,M=n.find(a=>`tab-${a.id}`===r);i.useEffect(()=>{if(h&&URL.revokeObjectURL(h),o.current.length>0){const k=o.current[0].type||"audio/webm",b=new Blob(o.current,{type:k}),R=URL.createObjectURL(b);f(R)}else f(null);return()=>{h&&URL.revokeObjectURL(h)}},[o.current.length]);const P=()=>{S<n.length-1&&y(`tab-${n[S+1].id}`)},q=()=>{if(x){console.log("Submit allaqachon bajarilgan, qayta urinish rad etildi");return}c(!0);const a=new FormData;if(o.current.length>0){const b=o.current[0].type||"audio/webm",T=b.includes("mpeg")||b.includes("mp3")?"mp3":"webm",D=new Blob(o.current,{type:b}),g=new File([D],`speaking-test-combined.${T}`,{type:b});a.append("record",g),a.append("speaking",s||""),console.log("FormData ga qoâ€˜shildi:",{fileName:g.name,fileSize:g.size,fileType:g.type,speakingId:s})}else console.warn("Hech qanday audio yozilmadi"),a.append("speaking",s||"");p(a)};return d.isLoading?e.jsx(oe,{message:"Loading test data..."}):d.isError?e.jsx(ee,{title:"Failed to Load Test",message:"An error occurred while loading the test. Please try again later."}):d.data?.speaking_parts.length===0?e.jsx(ee,{title:"Failed to load test",message:"An error occurred while loading the test questions. Please try again later."}):e.jsx(Me,{...u,children:e.jsxs("form",{className:"min-h-screen",children:[e.jsxs("div",{className:"sticky top-0 z-50 bg-primary-foreground space-y-1",children:[e.jsx(A,{className:"w-full shadow-md rounded-none",children:e.jsxs(L,{className:"p-3 flex justify-between items-center h-[50px]",children:[e.jsxs("div",{className:"text-sm flex items-center gap-2",children:[e.jsx(Te,{}),e.jsx("b",{children:"Candidate:"})," ",m?.username||"Guest"]}),e.jsx("div",{className:"flex items-center gap-8"})]})}),e.jsx(A,{className:"w-full shadow-sm rounded-none",children:e.jsxs(L,{className:"p-3 text-sm h-[70px]",children:[e.jsxs("div",{className:"font-semibold",children:["Part ",M?.speaking_part]}),e.jsx("div",{children:M?.description})]})})]}),e.jsx(Ce,{value:r,onValueChange:y,children:e.jsx("div",{children:n.map(a=>e.jsx(qe,{value:`tab-${a.id}`,className:De("h-full bg-muted",r!==`tab-${a.id}`&&"hidden"),children:e.jsx(We,{part:a,activeTab:r,isLastPart:E,onNextPart:P,onFinish:q,allAudioChunks:o})},a.id))})})]})})};function Ge({onNext:s}){const[m,u]=i.useState(!1),[p,d]=i.useState(null),h=i.useRef(null),f=i.useRef([]),x=async()=>{try{const o=await navigator.mediaDevices.getUserMedia({audio:!0}),n=new MediaRecorder(o);h.current=n,f.current=[],n.ondataavailable=r=>{r.data.size>0&&f.current.push(r.data)},n.onstop=()=>{const r=new Blob(f.current,{type:"audio/webm"}),y=URL.createObjectURL(r);d(y)},n.start(),u(!0)}catch(o){console.error("Microphone access denied:",o),alert("Please allow microphone access to continue.")}},c=()=>{h.current?.stop(),u(!1)};return e.jsx("div",{className:"flex items-center justify-center min-h-screen py-4",children:e.jsxs(A,{className:"w-full max-w-xl shadow-lg",children:[e.jsxs(re,{className:"flex items-center space-x-2",children:[e.jsx(ie,{className:"w-12 h-12"}),e.jsx("h1",{className:"scroll-m-20 text-center text-lg font-extrabold tracking-tight text-balance",children:"Test microphone"})]}),e.jsxs(L,{className:"space-y-6",children:[e.jsx("p",{className:"text-center",children:"Click on the button below and say a few words to check your microphone."}),e.jsx("div",{className:"flex justify-center gap-2",children:m?e.jsx(C,{variant:"destructive",onClick:c,children:"â¹ Stop recording"}):e.jsx(C,{variant:"outline",onClick:x,children:"ðŸŽ¤ Start recording"})}),p&&e.jsxs("div",{className:"flex flex-col items-center space-y-2",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Playback your recording:"}),e.jsx("audio",{controls:!0,src:p})]}),e.jsxs("p",{className:"flex gap-2",children:[e.jsx(ce,{className:"text-destructive"}),"If your voice cannot be heard clearly, please tell the invigilator."]})]}),e.jsx(ae,{children:e.jsx(C,{className:"w-full",onClick:s,disabled:!p,children:"Continue"})})]})})}const gt=()=>e.jsx(we,{steps:[e.jsx(ye,{}),e.jsx(Ue,{}),e.jsx(Ge,{}),e.jsx(Qe,{})]});export{gt as default};
