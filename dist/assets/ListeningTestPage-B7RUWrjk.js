import{a as ee,j as e,d as se,u as he,t as z,r as c,R as K,e as xe}from"./index-BxWpwr9K.js";import{u as pe,F as fe,C as ge}from"./useTestLogic-IcuwJ-1K.js";import{B as D}from"./badge-C8u5UXDS.js";import{B as P}from"./button-CNuY1AEb.js";import{C as M,a as O,c as $,d as V}from"./card-Dk_bWVLs.js";import{T as je,a as ye,b as J,c as I,d as Ne,e as k}from"./table-Dh5MqKeZ.js";import{b as te,e as Se,g as Te,R as B,O as ve}from"./index-B49kkQR6.js";import{l as o}from"./lodash-B6TVBKew.js";import{T as we}from"./tabs-C6GgIFvb.js";import{u as be,T as _e,a as R,P as Ae,C as Ee,b as Ce}from"./usePreventPageLeave-BgcSb0lh.js";import{o as W,b as Le,s as q,n as X,u as Ie,a as ke}from"./schemas-B82KTCYB.js";import{u as Re,a as Pe,F as Fe}from"./index.esm-ChS6XLnu.js";import{u as He,E as Z}from"./ErrorMessage-D0ZiHF_2.js";import{L as qe}from"./LoadingSpinner-CWTzwFnx.js";import"./index-BdrbzQWw.js";import"./utils-CPYLdFy8.js";import"./index-l1yS5F1P.js";import"./index-BDN4nLcq.js";import"./index-Wh0fB7su.js";import"./index-G9_EqjY3.js";import"./index-BG6d6_mM.js";import"./index-D1JhMIMx.js";import"./index-B0vI_HCU.js";import"./createLucideIcon-CICipjdr.js";import"./select-BN9ZGS1D.js";import"./index-B5emdeup.js";import"./index-BqYe3S9A.js";import"./index-DQnzmU1N.js";import"./form-DYmBEsQu.js";import"./circle-BZ55Rx38.js";import"./input-C5VEc5qf.js";function Me({formData:r}){const{user:m}=ee(),d=o.get(r,"finish"),u=o.get(r,"test_type"),n=o.get(r,"overall_score"),b=o.get(r,"percentage_correct_for_material",0),i=o.get(r,"answers",[]),v=o.get(r,"total_answers",0),_=o.get(r,"total_correct_answers",0),w=o.get(r,"total_incorrect_answers",0),y=()=>{d()};return e.jsx("div",{className:"p-4 w-full",children:e.jsxs(M,{className:"w-full shadow-lg",children:[e.jsxs(O,{className:"flex items-center space-x-2",children:[e.jsx(te,{className:"w-12 h-12"}),e.jsx("h1",{className:"text-center text-lg font-extrabold tracking-tight text-balance",children:"IELTS Academic Listening - Results"})]}),e.jsxs($,{className:"space-y-8",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Candidate:"}),e.jsx("div",{children:o.get(m,"full_name")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Total Questions:"}),e.jsx("div",{children:v})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Correct answers:"}),e.jsx("div",{className:"text-green-500",children:_})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Incorrect answers:"}),e.jsx("div",{className:"text-destructive",children:w})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{children:"Percentage correct for material:"}),e.jsxs("div",{children:[b,"%"]})]}),u==="mock"&&e.jsxs("div",{className:"flex items-center gap-2 mt-4",children:[e.jsx("strong",{children:"Overal:"}),e.jsx(D,{variant:"default",children:n})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h2",{className:"text-md font-semibold",children:"Answer Review"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(je,{className:"h-[400px]",children:[e.jsx(ye,{children:e.jsxs(J,{children:[e.jsx(I,{children:"Question"}),e.jsx(I,{children:"Your Answer"}),e.jsx(I,{children:"True Answer"}),e.jsx(I,{children:"Status"})]})}),e.jsx(Ne,{children:i.map(j=>e.jsxs(J,{children:[e.jsx(k,{children:j.question_number}),e.jsx(k,{children:j.answer||e.jsx(D,{className:"bg-orange-500",children:"Not answered"})}),e.jsx(k,{children:j.true_answer}),e.jsx(k,{children:j.is_true?e.jsx(Se,{className:"text-green-500"}):e.jsx(Te,{className:"text-destructive"})})]},j.id))})]})})]})]}),e.jsx(V,{children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsxs("p",{className:"flex gap-2",children:[e.jsx(B,{})," Review and finalize your results."]}),e.jsx(P,{className:"w-64",onClick:()=>y(),children:"Finish"})]})})]})})}const Oe=async r=>(await se.get(`/api/listening/by-material/${r}/`)).data,$e=async(r,m)=>(await se.post(`/api/listening-answers/${r}/`,m)).data,Ve=W({answers:Le(W({listening_id:X().optional()||q().optional(),question_number:X().optional()||q().optional(),answer:q().nullable().optional()}).nullable()).optional()}),Be=r=>He({queryKey:["listenings",r],queryFn:()=>Oe(r),enabled:!!r}),Qe=(r,m)=>{const{user:d}=ee(),u=he(),n=Be(r),b=o.get(n.data,"is_view"),i=o.get(n.data,"material"),v=()=>{if(d?.role===K.TEACHER)u("/");else if(String(o.get(i,"test_type"))?.toLowerCase()=="mock"){const t=o.get(i,"next_test"),h=o.get(i,"next_test_id");u(t==="listening"&&h?`/listenings/${h}`:t==="speaking"&&h?`/speakings/${h}`:t==="writing"&&h?`/writings/${h}`:"/")}else u("/")},_=t=>{d?.role===K.TEACHER?m?.({...t,material:i,finish:v}):b===!0?m?.({...t,material:i}):v()},w=Ie({mutationFn:t=>$e(r,t),onSuccess:t=>{z.success("Successfully submitted!"),_(t)},onError:t=>{console.error("Error:",t),z.error(o.get(t,"response.data.error",""))}}),y=Re({resolver:ke(Ve),defaultValues:{answers:[]}}),{fields:j,replace:f}=Pe({control:y.control,name:"answers"});return c.useEffect(()=>{const t=n.data;if(!Array.isArray(t?.listening_parts)||t.listening_parts.length===0)return;const h=Math.max(...t.listening_parts.flatMap(s=>s?.question_numbers?.map(p=>p.question_number))),x=Array(h).fill(null);t.listening_parts.forEach(s=>{s?.question_numbers?.forEach(p=>{const F=p.question_number-1;x[F]={listening_id:s.id,question_number:p.question_number,answer:""}})}),f(x)},[n.data,f]),{form:y,listeningMutation:w,onSubmit:t=>{const h=(t.answers??[]).filter(x=>x!=null);w.mutate(h)},answersFields:j,query:n}};function Ge({onNext:r}){const[m,d]=c.useState(!1),u=c.useRef(null),n=()=>{m?u.current?.pause():u.current?.play(),d(!m)};return e.jsx("div",{className:"flex items-center justify-center min-h-screen py-4",children:e.jsxs(M,{className:"w-full max-w-xl shadow-lg",children:[e.jsxs(O,{className:"flex items-center space-x-2",children:[e.jsx(ve,{className:"w-12 h-12"}),e.jsx("h1",{className:"scroll-m-20 text-center text-lg font-extrabold tracking-tight text-balance",children:"Test sound"})]}),e.jsxs($,{className:"space-y-6",children:[e.jsx("p",{className:"text-center",children:"Put on your headphones and click on the Play sound button to play a sample sound."}),e.jsx("div",{className:"flex justify-center",children:e.jsx(P,{variant:"outline",onClick:n,children:m?"Stop sound":"Play sound"})}),e.jsxs("p",{className:"flex gap-2",children:[e.jsx(B,{className:"text-destructive"})," If you cannot hear the sound clearly, please tell the invigilator."]}),e.jsx("audio",{ref:u,src:"https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3"})]}),e.jsx(V,{children:e.jsx(P,{className:"w-full",onClick:r,children:"Continue"})})]})})}const Ue=({onNext:r})=>{const{id:m}=xe(),{form:d,onSubmit:u,query:n,listeningMutation:b}=Qe(m,r),i=o.get(n,"data.listening_parts",[]),v=o.get(n,"data.answer_time",null),[_,w]=c.useState(!1),[y,j]=c.useState(!0),[f,E]=c.useState(0),[t,h]=c.useState(!1),x=c.useRef([]),s=c.useRef(null),[p,F]=c.useState(()=>{const a=localStorage.getItem("audioVolume");return a?parseFloat(a):1}),[A,C]=c.useState(!1),[Q,ae]=c.useState(!1),[N,H]=c.useState(!1);c.useEffect(()=>{n.data&&(o.get(n,"data.material.test_type","Mock")==="Thematic"?(C(!0),H(!1)):(C(!1),H(!0)))},[n.data]);const{timeLeft:ne,formatTime:re,activeTab:L,setActiveTab:G,currentTabIndex:ie,handlePrevious:oe,handleNext:le,isTestFinished:U}=pe(v,i,d.handleSubmit(u),_);be(!U),c.useEffect(()=>{if(n.isSuccess&&i.length>0&&!t){let a=0;const l=[];i.forEach((S,T)=>{const g=new Audio;g.src=S.audio,g.preload="auto",g.volume=p,l[T]=g,g.oncanplaythrough=()=>{a++,a===i.length&&(h(!0),x.current=l)},g.onerror=me=>{console.error(`Audio yuklashda xato (part ${S.id}):`,me),a++,a===i.length&&(h(!0),x.current=l)}})}},[n.isSuccess,i,t,p]);const ce=()=>{j(!1),x.current.length>0&&(s.current=x.current[0],o.get(n,"data.material.test_type","Mock")==="Mock"&&s.current.play().catch(l=>{console.error("Birinchi audio ijro etishda xato:",l)}))};c.useEffect(()=>{localStorage.setItem("audioVolume",p.toString()),x.current.forEach(a=>{a.volume=p})},[p]),c.useEffect(()=>{n.data&&t&&o.get(n,"data.material.test_type","Mock")==="Thematic"&&s.current&&(s.current.pause(),s.current.currentTime=0)},[n.data,t]),c.useEffect(()=>{if(y||!t||i.length===0)return;const a=o.get(n,"data.material.test_type","Mock");if(a==="Thematic"&&!N)return;const l=s.current,S=()=>{f<i.length-1?(l&&(l.pause(),l.currentTime=0),E(T=>T+1)):(w(!0),l&&(l.pause(),l.currentTime=0))};if(f<i.length){const T=x.current[f];T&&T!==l?(l&&(l.pause(),l.currentTime=0,l.removeEventListener("ended",S)),s.current=T,s.current.volume=p,a==="Thematic"&&!N&&(s.current.pause(),s.current.currentTime=0),!A&&N&&s.current.play().catch(g=>{console.error(`Audio ijro etishda xato (part ${i[f].id}):`,g)}),s.current.addEventListener("ended",S)):l&&(l.paused&&!A&&N&&l.play().catch(g=>{console.error("Audio ijro etishda xato:",g)}),l.addEventListener("ended",S))}return()=>{s.current&&(s.current.pause(),s.current.removeEventListener("ended",S))}},[f,i,y,t,p,A,N]),c.useEffect(()=>{"mediaSession"in navigator&&(navigator.mediaSession.setActionHandler("play",()=>{s.current&&s.current.paused&&N&&s.current.play()}),navigator.mediaSession.setActionHandler("pause",()=>{s.current&&!s.current.paused&&s.current.pause()}),navigator.mediaSession.setActionHandler("stop",()=>{s.current&&(s.current.pause(),s.current.currentTime=0)}),navigator.mediaSession.setActionHandler("nexttrack",()=>{f<i.length-1&&E(a=>a+1)}),navigator.mediaSession.setActionHandler("previoustrack",()=>{f>0&&E(a=>a-1)}))},[f,i.length,N]);const Y=a=>{F(a)},ue=()=>{if(s.current)if(A){s.current.play(),C(!1),H(!0);const{user:a}=useAuthStore.getState();a?.role===Role.STUDENT&&ae(!0)}else{const{user:a}=useAuthStore.getState();(a?.role===Role.TEACHER||!Q)&&(s.current.pause(),C(!0))}},de=i.find(a=>`tab-${a.id}`===L);return n.isLoading||!t?e.jsx(qe,{message:"Loading test data and audio files..."}):n.isError?e.jsx(Z,{title:"Failed to Load Test",message:"An error occurred while loading the test. Please try again later."}):n.data?.listening_parts.length===0?e.jsx(Z,{title:"Failed to load test",message:"An error occurred while loading the test questions. Please try again later."}):e.jsx(e.Fragment,{children:y?e.jsx(Ge,{onNext:ce,onVolumeChange:Y,initialVolume:p,audioElements:x.current}):e.jsx(Fe,{...d,children:e.jsxs("form",{onSubmit:d.handleSubmit(u),className:"min-h-screen",children:[e.jsxs("div",{className:"sticky top-0 z-50 bg-primary-foreground space-y-1",children:[e.jsx(_e,{timeLeft:ne,formatTime:re,testType:R.LISTENING,type:o.get(n,"data.material.test_type","Mock"),audioRef:s,handleVolumeChange:Y,handlePauseToggle:ue,isPaused:A,studentHasStarted:Q,userHasStarted:N}),e.jsx(Ae,{activePart:de,testType:R.LISTENING})]}),e.jsxs(we,{value:L,onValueChange:G,children:[e.jsx(Ee,{data:i,activeTab:L,testType:R.LISTENING,form:d}),e.jsx(Ce,{data:i,testType:R.LISTENING,form:d,activeTab:L,setActiveTab:G,currentTabIndex:ie,handlePrevious:oe,handleNext:le,onSubmit:d.handleSubmit(u),isTestFinished:U,isLoading:b.isPending})]})]})})})};function Ye({onNext:r}){return e.jsx("div",{className:"flex items-center justify-center min-h-screen py-4",children:e.jsxs(M,{className:"w-full max-w-3xl shadow-lg",children:[e.jsxs(O,{className:"flex items-center space-x-2",children:[e.jsx(te,{className:"w-12 h-12"}),e.jsx("h1",{className:"scroll-m-20 text-center text-lg font-extrabold tracking-tight text-balance",children:"IELTS Academic Listening"})]}),e.jsxs($,{className:"space-y-8",children:[e.jsx("div",{className:"space-y-3",children:e.jsxs("p",{children:[e.jsx("strong",{children:"Time:"})," Approximately 30 minutes"]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h2",{className:"text-md font-semibold",children:"INSTRUCTIONS TO CANDIDATES"}),e.jsxs("ul",{className:"list-disc pl-5 space-y-1",children:[e.jsx("li",{children:"Answer all the questions."}),e.jsx("li",{children:"You can change your answers at any time during the test."})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h2",{className:"text-md font-semibold",children:"INFORMATION FOR CANDIDATES"}),e.jsxs("ul",{className:"list-disc pl-5 space-y-1",children:[e.jsx("li",{children:"There are 40 questions in this test."}),e.jsx("li",{children:"Each question carries one mark."}),e.jsx("li",{children:"There are four parts to the test."}),e.jsx("li",{children:"You will hear each part once."}),e.jsx("li",{children:"For each part of the test there will be time for you to look through the questions and time for you to check your answers."})]})]}),e.jsxs("p",{className:"flex gap-2",children:[e.jsx(B,{})," Read instructions and start only when ready."]})]}),e.jsx(V,{children:e.jsx(P,{className:"w-full",onClick:r,children:"Start test"})})]})})}const ws=()=>e.jsx(fe,{steps:[e.jsx(ge,{}),e.jsx(Ye,{}),e.jsx(Ue,{}),e.jsx(Me,{disableOverflow:!0})]});export{ws as default};
